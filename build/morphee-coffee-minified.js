// morphee-coffee-minified.js - https://github.com/davidedc/livecodelab
'use strict';var BlinkerMorph,BouncerMorph,BoxMorph,CaretMorph,CircleBoxMorph,Color,ColorPaletteMorph,ColorPickerMorph,FrameMorph,GrayPaletteMorph,HandMorph,HandleMorph,InspectorMorph,ListMorph,MenuItemMorph,MenuMorph,Morph,MorphicNode,MorphsListMorph,MouseSensorMorph,PenMorph,Point,Point2,Rectangle,ScrollFrameMorph,ShadowMorph,SliderButtonMorph,SliderMorph,SpeechBubbleMorph,StringFieldMorph,StringMorph,TextMorph,TriggerMorph,WorldMorph,clone,contains,copy,degrees,detect,fontHeight,getBlurredShadowSupport,
getDocumentPositionOf,getMinimumFontHeight,hashCode,isFunction,isNil,isObject,isString,localize,modules,morphicVersion,newCanvas,noOperation,nop,radians,sizeOf,standardSettings,touchScreenSettings,useBlurredShadows,__hasProp={}.hasOwnProperty,__extends=function(c,a){function b(){this.constructor=c}for(var h in a)__hasProp.call(a,h)&&(c[h]=a[h]);b.prototype=a.prototype;c.prototype=new b;c.__super__=a.prototype;return c},__indexOf=[].indexOf||function(c){for(var a=0,b=this.length;a<b;a++)if(a in this&&
this[a]===c)return a;return-1};hashCode=function(c){var a,b,h,d;b=0;if(0===c.length)return b;a=h=0;for(d=c.length;0<=d?h<d:h>d;a=0<=d?++h:--h)a=c.charCodeAt(a),b=(b<<5)-b+a,b&=b;return b};nop=function(){return function(){return null}};noOperation=function(){return null};isFunction=function(c){return"function"===typeof c};localize=function(c){return c};isNil=function(c){return void 0===c||null===c};contains=function(c,a){return c.some(function(b){return b===a})};
detect=function(c,a){var b,h,d;h=0;for(d=c.length;h<d;h++)if(b=c[h],a.call(null,b))return b;return null};sizeOf=function(c){var a,b;b=0;a=void 0;for(a in c)c.hasOwnProperty(a)&&(b+=1);return b};isString=function(c){return"string"===typeof c||c instanceof String};isObject=function(c){return null!=c&&("object"===typeof c||c instanceof Object)};radians=function(c){return c*Math.PI/180};degrees=function(c){return 180*c/Math.PI};fontHeight=function(c){return 1.2*Math.max(c,WorldMorph.MorphicPreferences.minimumFontHeight)};
newCanvas=function(c){var a;a=c||{x:0};({y:0});c=document.createElement("canvas");c.width=a.x;c.height=a.y;return c};getMinimumFontHeight=function(){var c,a,b,h,d,e;c=document.createElement("canvas");c.width=50;c.height=50;c=c.getContext("2d");c.font="1px serif";b=c.measureText("I").width;c.fillStyle="black";c.textBaseline="bottom";c.fillText("I",0,50);for(h=d=0;50>d;h=++d)for(a=e=0;0<=b?e<b:e>b;a=0<=b?++e:--e)if(a=c.getImageData(a,h,1,1),0!==a.data[3])return 50-h+1;return 0};
getBlurredShadowSupport=function(){var c,a;a=document.createElement("canvas");a.width=10;a.height=10;c=a.getContext("2d");c.fillStyle="rgb(255, 0, 0)";c.beginPath();c.arc(5,5,5,0,2*Math.PI,!0);c.closePath();c.fill();c=document.createElement("canvas");c.width=10;c.height=10;c=c.getContext("2d");c.shadowBlur=10;c.shadowColor="rgba(0, 0, 255, 1)";c.drawImage(a,0,0);return c.getImageData(0,0,1,1).data[3]?!0:!1};
getDocumentPositionOf=function(c){var a;if(null===c)return{x:0,y:0};a={x:c.offsetLeft,y:c.offsetTop};for(c=c.offsetParent;null!==c;)a.x+=c.offsetLeft,a.y+=c.offsetTop,c!==document.body&&c!==document.documentElement&&(a.x-=c.scrollLeft,a.y-=c.scrollTop),c=c.offsetParent;return a};clone=function(c){var a;return"object"===typeof c?(a=function(){},a.prototype=c,new a):c};
copy=function(c){var a,b;if("object"!==typeof c)return c;a=c.valueOf();if(c!==a)return new c.constructor(a);if(c instanceof c.constructor&&c.constructor!==Object)for(b in a=clone(c.constructor.prototype),c)c.hasOwnProperty(b)&&(a[b]=c[b]);else for(b in a={},c)a[b]||(a[b]=c[b]);return a};
getMinimumFontHeight=function(){var c,a,b,h,d,e;c=document.createElement("canvas");c.width=50;c.height=50;c=c.getContext("2d");c.font="1px serif";b=c.measureText("I").width;c.fillStyle="black";c.textBaseline="bottom";c.fillText("I",0,50);for(h=d=0;50>d;h=++d)for(a=e=0;0<=b?e<b:e>b;a=0<=b?++e:--e)if(a=c.getImageData(a,h,1,1),0!==a.data[3])return 50-h+1;return 0};
getBlurredShadowSupport=function(){var c,a;a=document.createElement("canvas");a.width=10;a.height=10;c=a.getContext("2d");c.fillStyle="rgb(255, 0, 0)";c.beginPath();c.arc(5,5,5,0,2*Math.PI,!0);c.closePath();c.fill();c=document.createElement("canvas");c.width=10;c.height=10;c=c.getContext("2d");c.shadowBlur=10;c.shadowColor="rgba(0, 0, 255, 1)";c.drawImage(a,0,0);return c.getImageData(0,0,1,1).data[3]?!0:!1};
getDocumentPositionOf=function(c){var a;if(null===c)return{x:0,y:0};a={x:c.offsetLeft,y:c.offsetTop};for(c=c.offsetParent;null!==c;)a.x+=c.offsetLeft,a.y+=c.offsetTop,c!==document.body&&c!==document.documentElement&&(a.x-=c.scrollLeft,a.y-=c.scrollTop),c=c.offsetParent;return a};clone=function(c){var a;return"object"===typeof c?(a=function(){},a.prototype=c,new a):c};
copy=function(c){var a,b;if("object"!==typeof c)return c;a=c.valueOf();if(c!==a)return new c.constructor(a);if(c instanceof c.constructor&&c.constructor!==Object)for(b in a=clone(c.constructor.prototype),c)c.hasOwnProperty(b)&&(a[b]=c[b]);else for(b in a={},c)a[b]||(a[b]=c[b]);return a};
MorphicNode=function(){function c(a,b){this.parent=null!=a?a:null;this.children=null!=b?b:[]}c.prototype.parent=null;c.prototype.children=null;c.prototype.toString=function(){return"a MorphicNode["+this.children.length.toString()+"]"};c.prototype.addChild=function(a){this.children.push(a);return a.parent=this};c.prototype.addChildFirst=function(a){this.children.splice(0,null,a);return a.parent=this};c.prototype.removeChild=function(a){a=this.children.indexOf(a);if(-1!==a)return this.children.splice(a,
1)};c.prototype.root=function(){return null!=this.parent?this.parent.root():this};c.prototype.depth=function(){return!this.parent?0:this.parent.depth()+1};c.prototype.allChildren=function(){var a;a=[this];this.children.forEach(function(b){return a=a.concat(b.allChildren())});return a};c.prototype.forAllChildren=function(a){this.children.length&&this.children.forEach(function(b){return b.forAllChildren(a)});return a.call(null,this)};c.prototype.allLeafs=function(){var a;a=[];this.allChildren().forEach(function(b){if(!b.children.length)return a.push(b)});
return a};c.prototype.allParents=function(){var a;a=[this];null!=this.parent&&(a=a.concat(this.parent.allParents()));return a};c.prototype.siblings=function(){var a=this;return!this.parent?[]:this.parent.children.filter(function(b){return b!==a})};c.prototype.parentThatIsA=function(a){return this instanceof a?this:!this.parent?null:this.parent.parentThatIsA(a)};c.prototype.parentThatIsAnyOf=function(a){var b=this;a.forEach(function(a){if(b.constructor===a)return b});return!this.parent?null:this.parent.parentThatIsAnyOf(a)};
return c}();
Morph=function(c){function a(){a.__super__.constructor.call(this);this.bounds=new Rectangle(0,0,50,40);this.color=new Color(80,80,80);this.drawNew();this.lastTime=Date.now()}__extends(a,c);a.prototype.propertyUpTheChain=[1,2,3];a.prototype.morphMethod=function(){return 3.14};a.morphStaticMethod=function(){return 3.14};a.prototype.isMorph=!0;a.prototype.bounds=null;a.prototype.color=null;a.prototype.texture=null;a.prototype.cachedTexture=null;a.prototype.lastTime=null;a.prototype.alpha=1;a.prototype.isVisible=
!0;a.prototype.isDraggable=!1;a.prototype.isTemplate=!1;a.prototype.acceptsDrops=!1;a.prototype.noticesTransparentClick=!1;a.prototype.fps=0;a.prototype.customContextMenu=null;a.prototype.trackChanges=!0;a.prototype.shadowBlur=4;a.prototype.image=null;a.prototype.onNextStep=null;a.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds};a.prototype.destroy=function(){if(null!==this.parent)return this.fullChanged(),
this.parent.removeChild(this)};a.prototype.runChildrensStepFunction=function(){var b;if(!this.step)return null;b=WorldMorph.currentTime-this.lastTime;if(1>(0<this.fps?1E3/this.fps-b:0))return this.lastTime=WorldMorph.currentTime,this.onNextStep&&(b=this.onNextStep,this.onNextStep=null,b.call(this)),this.step(),this.children.forEach(function(b){return b.runChildrensStepFunction()})};a.prototype.nextSteps=function(b){var a,d,e=this;a=b||[];if(d=a.shift())return this.onNextStep=function(){d.call(e);
return e.nextSteps(a)}};a.prototype.step=noOperation;a.prototype.left=function(){return this.bounds.left()};a.prototype.right=function(){return this.bounds.right()};a.prototype.top=function(){return this.bounds.top()};a.prototype.bottom=function(){return this.bounds.bottom()};a.prototype.center=function(){return this.bounds.center()};a.prototype.bottomCenter=function(){return this.bounds.bottomCenter()};a.prototype.bottomLeft=function(){return this.bounds.bottomLeft()};a.prototype.bottomRight=function(){return this.bounds.bottomRight()};
a.prototype.boundingBox=function(){return this.bounds};a.prototype.corners=function(){return this.bounds.corners()};a.prototype.leftCenter=function(){return this.bounds.leftCenter()};a.prototype.rightCenter=function(){return this.bounds.rightCenter()};a.prototype.topCenter=function(){return this.bounds.topCenter()};a.prototype.topLeft=function(){return this.bounds.topLeft()};a.prototype.topRight=function(){return this.bounds.topRight()};a.prototype.position=function(){return this.bounds.origin};a.prototype.extent=
function(){return this.bounds.extent()};a.prototype.width=function(){return this.bounds.width()};a.prototype.height=function(){return this.bounds.height()};a.prototype.boundsIncludingChildren=function(){var b;b=this.bounds;this.children.forEach(function(a){if(a.isVisible)return b=b.merge(a.boundsIncludingChildren())});return b};a.prototype.boundsIncludingChildrenNoShadow=function(){var b;b=this.bounds;this.children.forEach(function(a){if(!(a instanceof ShadowMorph)&&a.isVisible)return b=b.merge(a.boundsIncludingChildren())});
return b};a.prototype.visibleBounds=function(){var b;b=this.bounds;this.allParents().filter(function(b){return b instanceof FrameMorph}).forEach(function(a){return b=b.intersect(a.bounds)});return b};a.prototype.moveBy=function(b){this.changed();this.bounds=this.bounds.translateBy(b);this.children.forEach(function(a){return a.moveBy(b)});return this.changed()};a.prototype.silentMoveBy=function(b){this.bounds=this.bounds.translateBy(b);return this.children.forEach(function(a){return a.silentMoveBy(b)})};
a.prototype.setPosition=function(b){b=b.subtract(this.topLeft());if(0!==b.x||0!==b.y)return this.moveBy(b)};a.prototype.silentSetPosition=function(b){b=b.subtract(this.topLeft());if(0!==b.x||0!==b.y)return this.silentMoveBy(b)};a.prototype.setLeft=function(b){return this.setPosition(new Point(b,this.top()))};a.prototype.setRight=function(b){return this.setPosition(new Point(b-this.width(),this.top()))};a.prototype.setTop=function(b){return this.setPosition(new Point(this.left(),b))};a.prototype.setBottom=
function(b){return this.setPosition(new Point(this.left(),b-this.height()))};a.prototype.setCenter=function(b){return this.setPosition(b.subtract(this.extent().floorDivideBy(2)))};a.prototype.setFullCenter=function(b){return this.setPosition(b.subtract(this.boundsIncludingChildren().extent().floorDivideBy(2)))};a.prototype.keepWithin=function(b){var a;a=this.boundsIncludingChildren().left()-b.left();0>a&&this.moveBy(new Point(-a,0));a=this.boundsIncludingChildren().right()-b.right();0<a&&this.moveBy(new Point(-a,
0));a=this.boundsIncludingChildren().top()-b.top();0>a&&this.moveBy(new Point(0,-a));b=this.boundsIncludingChildren().bottom()-b.bottom();if(0<b)return this.moveBy(new Point(0,-b))};a.prototype.setExtent=function(b){if(!b.eq(this.extent()))return this.changed(),this.silentSetExtent(b),this.changed(),this.drawNew()};a.prototype.silentSetExtent=function(b){var a;a=b.round();b=Math.max(a.x,0);a=Math.max(a.y,0);return this.bounds.corner=new Point(this.bounds.origin.x+b,this.bounds.origin.y+a)};a.prototype.setWidth=
function(b){return this.setExtent(new Point(b||0,this.height()))};a.prototype.silentSetWidth=function(b){b=Math.max(Math.round(b||0),0);return this.bounds.corner=new Point(this.bounds.origin.x+b,this.bounds.corner.y)};a.prototype.setHeight=function(b){return this.setExtent(new Point(this.width(),b||0))};a.prototype.silentSetHeight=function(b){b=Math.max(Math.round(b||0),0);return this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+b)};a.prototype.setColor=function(b){if(b&&!this.color.eq(b))return this.color=
b,this.changed(),this.drawNew()};a.prototype.drawNew=function(){var b;this.image=newCanvas(this.extent());b=this.image.getContext("2d");b.fillStyle=this.color.toString();b.fillRect(0,0,this.width(),this.height());if(this.cachedTexture)return this.drawCachedTexture();if(this.texture)return this.drawTexture(this.texture)};a.prototype.drawTexture=function(b){var a=this;this.cachedTexture=new Image;this.cachedTexture.onload=function(){return a.drawCachedTexture()};return this.cachedTexture.src=this.texture=
b};a.prototype.drawCachedTexture=function(){var b,a,d,e,c,f,i,j;b=this.cachedTexture;a=Math.floor(this.image.width/b.width);e=Math.floor(this.image.height/b.height);d=this.image.getContext("2d");for(f=i=0;0<=e?i<=e:i>=e;f=0<=e?++i:--i)for(c=j=0;0<=a?j<=a:j>=a;c=0<=a?++j:--j)d.drawImage(b,Math.round(c*b.width),Math.round(f*b.height));return this.changed()};a.prototype.drawOn=function(b,a){var d,e,c,f,i,j,k,l;null==a&&(a=this.bounds());if(!this.isVisible)return null;e=a.intersect(this.bounds).round();
if(e.isNotEmpty()){d=this.position().neg();f=e.copy().translateBy(d).round();c=b.getContext("2d");c.globalAlpha=this.alpha;i=f.left();j=f.top();d=e.left();e=e.top();l=Math.min(f.width(),this.image.width-i);f=Math.min(f.height(),this.image.height-j);if(1>l||1>f)return null;c.drawImage(this.image,Math.round(i),Math.round(j),Math.round(l),Math.round(f),Math.round(d),Math.round(e),Math.round(l),Math.round(f));if(WorldMorph.showRedraws)return k=Math.round(255*Math.random()),j=Math.round(255*Math.random()),
i=Math.round(255*Math.random()),c.globalAlpha=0.5,c.fillStyle="rgb("+k+","+j+","+i+")",c.fillRect(Math.round(d),Math.round(e),Math.round(l),Math.round(f))}};a.prototype.fullDrawOn=function(b,a){null==a&&(a=this.boundsIncludingChildren());if(!this.isVisible)return null;this.drawOn(b,a);return this.children.forEach(function(d){return d.fullDrawOn(b,a)})};a.prototype.hide=function(){this.isVisible=!1;this.changed();return this.children.forEach(function(b){return b.hide()})};a.prototype.show=function(){this.isVisible=
!0;this.changed();return this.children.forEach(function(b){return b.show()})};a.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible;this.changed();return this.children.forEach(function(b){return b.toggleVisibility()})};a.prototype.fullImageClassic=function(){var b,a;b=this.boundsIncludingChildren();a=newCanvas(b.extent());this.fullDrawOn(a,b);a.globalAlpha=this.alpha;return a};a.prototype.fullImage=function(){var b,a;b=this.boundsIncludingChildren();a=newCanvas(b.extent());a.getContext("2d").translate(-this.bounds.origin.x,
-this.bounds.origin.y);this.fullDrawOn(a,b);return a};a.prototype.fullImageData=function(){return this.fullImage().toDataURL()};a.prototype.fullImageHashCode=function(){return hashCode(this.fullImageData())};a.prototype.shadowImage=function(b,a){var d,e,c,f,i,j;i=b||new Point(7,7);d=a||new Color(0,0,0);c=this.boundsIncludingChildren().extent();f=this.fullImage();j=newCanvas(c);e=j.getContext("2d");e.drawImage(f,0,0);e.globalCompositeOperation="destination-out";e.drawImage(f,Math.round(-i.x),Math.round(-i.y));
f=newCanvas(c);e=f.getContext("2d");e.drawImage(j,0,0);e.globalCompositeOperation="source-atop";e.fillStyle=d.toString();e.fillRect(0,0,c.x,c.y);return f};a.prototype.shadowImageBlurred=function(b,a){var d,e,c,f,i,j;i=b||new Point(7,7);d=this.shadowBlur;e=a||new Color(0,0,0);c=this.boundsIncludingChildren().extent().add(2*d);f=this.fullImage();j=newCanvas(c);c=j.getContext("2d");c.shadowOffsetX=i.x;c.shadowOffsetY=i.y;c.shadowBlur=d;c.shadowColor=e.toString();c.drawImage(f,Math.round(d-i.x),Math.round(d-
i.y));c.shadowOffsetX=0;c.shadowOffsetY=0;c.shadowBlur=0;c.globalCompositeOperation="destination-out";c.drawImage(f,Math.round(d-i.x),Math.round(d-i.y));return j};a.prototype.shadow=function(b,a,d){var e,c;c=new ShadowMorph;b=b||new Point(7,7);a=a||(0===a?0:0.2);e=this.boundsIncludingChildren();c.setExtent(e.extent().add(2*this.shadowBlur));useBlurredShadows?(c.image=this.shadowImageBlurred(b,d),c.alpha=a,c.setPosition(e.origin.add(b).subtract(this.shadowBlur))):(c.image=this.shadowImage(b,d),c.alpha=
a,c.setPosition(e.origin.add(b)));return c};a.prototype.addShadow=function(b,a,d){b=this.shadow(b||new Point(7,7),a||(0===a?0:0.2),d);this.addBack(b);this.fullChanged();return b};a.prototype.getShadow=function(){var b;b=this.children.slice(0).reverse().filter(function(b){return b instanceof ShadowMorph});return b.length?b[0]:null};a.prototype.removeShadow=function(){var b;b=this.getShadow();if(null!==b)return this.fullChanged(),this.removeChild(b)};a.prototype.penTrails=function(){return this.image};
a.prototype.changed=function(){var b;this.trackChanges&&(b=this.root(),b instanceof WorldMorph&&b.broken.push(this.visibleBounds().spread()));if(this.parent)return this.parent.childChanged(this)};a.prototype.fullChanged=function(){var b;if(this.trackChanges&&(b=this.root(),b instanceof WorldMorph))return b.broken.push(this.boundsIncludingChildren().spread())};a.prototype.childChanged=function(){if(this.parent)return this.parent.childChanged(this)};a.prototype.world=function(){var b;b=this.root();
return b instanceof WorldMorph?b:b instanceof HandMorph?b.world:null};a.prototype.add=function(b){var a;a=b.parent;null!=a&&a.removeChild(b);return this.addChild(b)};a.prototype.addBack=function(b){var a;a=b.parent;null!=a&&a.removeChild(b);return this.addChildFirst(b)};a.prototype.topMorphSuchThat=function(b){var a;return b.call(null,this)?(a=detect(this.children.slice(0).reverse(),b))?a.topMorphSuchThat(b):this:null};a.prototype.morphAt=function(b){var a,d;a=this.allChildren().slice(0).reverse();
d=null;a.forEach(function(a){if(a.boundsIncludingChildren().containsPoint(b)&&null===d)return d=a});return d};a.prototype.overlappedMorphs=function(){var b,a,d,e,c=this;e=this.world();d=this.boundsIncludingChildren();a=this.allParents();b=this.allChildren();return e.allChildren().filter(function(f){return f.isVisible&&f!==c&&f!==e&&!contains(a,f)&&!contains(b,f)&&f.boundsIncludingChildren().intersects(d)})};a.prototype.getPixelColor=function(b){b=b.subtract(this.bounds.origin);b=this.image.getContext("2d").getImageData(b.x,
b.y,1,1);return new Color(b.data[0],b.data[1],b.data[2],b.data[3])};a.prototype.isTransparentAt=function(b){var a;if(this.bounds.containsPoint(b)){if(this.texture)return!1;a=b.subtract(this.bounds.origin);b=this.image.getContext("2d");b=b.getImageData(Math.floor(a.x),Math.floor(a.y),1,1);return 0===b.data[3]}return!1};a.prototype.copy=function(){var b;b=copy(this);b.parent=null;b.children=[];b.bounds=this.bounds.copy();return b};a.prototype.fullCopy=function(){var b,a;a={};b=this.copyRecordingReferences(a);
b.forAllChildren(function(b){return b.updateReferences(a)});return b};a.prototype.copyRecordingReferences=function(b){var a;a=this.copy();b[this]=a;this.children.forEach(function(d){return a.add(d.copyRecordingReferences(b))});return a};a.prototype.updateReferences=function(b){var a,d;d=[];for(a in this)a.isMorph&&b[a]?d.push(this[a]=b[a]):d.push(void 0);return d};a.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?
this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()};a.prototype.wantsDropOf=function(b){return b instanceof HandleMorph||b instanceof MenuMorph||b instanceof InspectorMorph?!1:this.acceptsDrops};a.prototype.pickUp=function(b){b=b||this.world();this.setPosition(b.hand.position().subtract(this.extent().floorDivideBy(2)));return b.hand.grab(this)};a.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)};
a.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null};a.prototype.slideBackTo=function(b,a){var d,e,c,f,i,j,k,l=this;i=a||5;c=b.origin.position().add(b.position);j=-(this.left()-c.x)/i;k=-(this.top()-c.y)/i;f=0;e=this.step;d=this.fps;this.fps=0;return this.step=function(){l.fullChanged();l.silentMoveBy(new Point(j,k));l.fullChanged();f+=1;if(f===i)return b.origin.add(l),b.origin.reactToDropOf&&b.origin.reactToDropOf(l),
l.step=e,l.fps=d}};a.prototype.resize=function(){return this.world().activeHandle=new HandleMorph(this)};a.prototype.move=function(){return this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")};a.prototype.hint=function(b){var a;(a=b)?b.toString&&(a=b.toString()):a="NULL";b=new MenuMorph(this,a);b.isDraggable=!0;return b.popUpCenteredAtHand(this.world())};a.prototype.inform=function(b){var a;(a=b)?b.toString&&(a=b.toString()):a="NULL";b=new MenuMorph(this,a);b.addItem("Ok");
b.isDraggable=!0;return b.popUpCenteredAtHand(this.world())};a.prototype.prompt=function(b,a,d,e,c,f,i,j){var k,l;i&&(l=!0);b=new MenuMorph(a||null,b||"",d||null);k=new StringFieldMorph(e||"",c||100,WorldMorph.MorphicPreferences.prompterFontSize,WorldMorph.MorphicPreferences.prompterFontName,!1,!1,l);b.items.push(k);if(i||WorldMorph.MorphicPreferences.useSliderForInput)e=new SliderMorph(f||0,i,parseFloat(e),Math.floor((i-f)/4),"horizontal"),e.alpha=1,e.color=new Color(225,225,225),e.button.color=
b.borderColor,e.button.highlightColor=e.button.color.copy(),e.button.highlightColor.b+=100,e.button.pressColor=e.button.color.copy(),e.button.pressColor.b+=150,e.setHeight(WorldMorph.MorphicPreferences.prompterSliderSize),e.action=j?function(b){k.changed();k.text.text=Math.round(b).toString();k.text.drawNew();k.text.changed();return k.text.edit()}:function(b){k.changed();k.text.text=b.toString();k.text.drawNew();return k.text.changed()},b.items.push(e);b.addLine(2);b.addItem("Ok",function(){return k.string()});
b.addItem("Cancel",function(){return null});b.isDraggable=!0;b.popUpAtHand(this.world());return k.text.edit()};a.prototype.pickColor=function(b,a,d,e){var c,b=new MenuMorph(a||null,b||"",d||null);c=new ColorPickerMorph(e);b.items.push(c);b.addLine(2);b.addItem("Ok",function(){return c.getChoice()});b.addItem("Cancel",function(){return null});b.isDraggable=!0;return b.popUpAtHand(this.world())};a.prototype.inspect=function(b){var a,d;d=this.world instanceof Function?this.world():this.root()||this.world;
a=this;b&&(a=b);b=new InspectorMorph(a);b.setPosition(d.hand.position());b.keepWithin(d);d.add(b);return b.changed()};a.prototype.contextMenu=function(){var b;return this.customContextMenu?this.customContextMenu:(b=this.world instanceof Function?this.world():this.root()||this.world)&&b.isDevMode?this.parent===b?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu()};a.prototype.hierarchyMenu=function(){var b,a,d;a=this.allParents();d=this.world instanceof Function?
this.world():this.root()||this.world;b=new MenuMorph(this,null);a.forEach(function(a){if(a.developersMenu&&a!==d)return b.addItem(a.toString().slice(0,50),function(){return a.developersMenu().popUpAtHand(d)})});return b};a.prototype.developersMenu=function(){var b,a,d;d=this.world instanceof Function?this.world():this.root()||this.world;a=this.userMenu()||this.parent&&this.parent.userMenu();b=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);a&&(b.addItem("user features...",
function(){return a.popUpAtHand(d)}),b.addLine());b.addItem("color...",function(){return this.pickColor(b.title+"\ncolor:",this.setColor,this,this.color)},"choose another color \nfor this morph");b.addItem("transparency...",function(){return this.prompt(b.title+"\nalpha\nvalue:",this.setAlphaScaled,this,(this.alpha*100).toString(),null,1,100,true)},"set this morph's\nalpha value");b.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent");b.addLine();b.addItem("duplicate",
function(){return this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up");b.addItem("pick up","pickUp","disattach and put \ninto the hand");b.addItem("attach...","attach","stick this morph\nto another one");b.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph");b.addItem("inspect...","inspect","open a window\non all properties");b.addItem("pic...",function(){return window.open(this.fullImageData())},"open a new window\nwith a picture of this morph");b.addLine();
this.isDraggable?b.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):b.addItem("unlock","toggleIsDraggable","make this morph\nmovable");b.addItem("hide","hide");b.addItem("delete","destroy");this instanceof WorldMorph||(b.addLine(),b.addItem("World...",function(){return d.contextMenu().popUpAtHand(d)},"show the\nWorld's menu"));return b};a.prototype.userMenu=function(){return null};a.prototype.setAlphaScaled=function(b){"number"===typeof b?this.alpha=Math.min(Math.max(b/100,0.1),1):
(b=parseFloat(b),isNaN(b)||(this.alpha=Math.min(Math.max(b/100,0.1),1)));return this.changed()};a.prototype.attach=function(){var b,a,d=this;b=this.overlappedMorphs();a=new MenuMorph(this,"choose new parent:");b.forEach(function(b){return a.addItem(b.toString().slice(0,50),function(){b.add(d);return d.isDraggable=!1})});if(b.length)return a.popUpAtHand(this.world())};a.prototype.toggleIsDraggable=function(){return this.isDraggable=!this.isDraggable};a.prototype.colorSetters=function(){return["color"]};
a.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]};a.prototype.allEntryFields=function(){return this.allChildren().filter(function(b){return b.isEditable&&(b instanceof StringMorph||b instanceof TextMorph)})};a.prototype.nextEntryField=function(b){var a;a=this.allEntryFields();b=a.indexOf(b);return-1!==b&&a.length>b+1?a[b+1]:a[0]};a.prototype.previousEntryField=function(b){var a;a=this.allEntryFields();b=a.indexOf(b);return-1!==b?0<b?a[b-1]:
a[a.length-1]:a[0]};a.prototype.tab=function(b){if(this.nextTab)return this.nextTab(b);if(this.parent)return this.parent.tab(b)};a.prototype.backTab=function(b){if(this.previousTab)return this.previousTab(b);if(this.parent)return this.parent.backTab(b)};a.prototype.escalateEvent=function(b,a){var d;for(d=this.parent;!d[b]&&null!=d.parent;)d=d.parent;if(d[b])return d[b](a)};a.prototype.evaluateString=function(b){var a;try{a=eval(b),this.drawNew(),this.changed()}catch(d){this.inform(d)}return a};a.prototype.isTouching=
function(b){b=this.overlappingImage(b);b=b.getContext("2d").getImageData(1,1,b.width,b.height).data;return null!==detect(b,function(b){return 0!==b})};a.prototype.overlappingImage=function(b){var a,d,c,g,f;d=this.boundsIncludingChildren();f=b.boundsIncludingChildren();g=d.intersect(f);c=newCanvas(g.extent());a=c.getContext("2d");if(1>g.width()||1>g.height())return newCanvas(new Point(1,1));a.drawImage(this.fullImage(),Math.round(g.origin.x-d.origin.x),Math.round(g.origin.y-d.origin.y));a.globalCompositeOperation=
"source-in";a.drawImage(b.fullImage(),Math.round(f.origin.x-g.origin.x),Math.round(f.origin.y-g.origin.y));return c};return a}(MorphicNode);
HandMorph=function(c){function a(b){this.world=b;this.mouseOverList=[];this.temporaries=[];a.__super__.constructor.call(this);this.bounds=new Rectangle}__extends(a,c);a.prototype.world=null;a.prototype.mouseButton=null;a.prototype.mouseDownMorph=null;a.prototype.morphToGrab=null;a.prototype.grabOrigin=null;a.prototype.mouseOverList=null;a.prototype.temporaries=null;a.prototype.touchHoldTimeout=null;a.prototype.changed=function(){var b;if(null!==this.world&&(b=this.boundsIncludingChildren(),!b.extent().eq(new Point)))return this.world.broken.push(this.boundsIncludingChildren().spread())};
a.prototype.morphAtPointer=function(){var b,a,d=this;b=this.world.allChildren().slice(0).reverse();a=null;b.forEach(function(b){if(b.visibleBounds().containsPoint(d.bounds.origin)&&null===a&&b.isVisible&&(b.noticesTransparentClick||!b.isTransparentAt(d.bounds.origin))&&!(b instanceof ShadowMorph))return a=b});return null!==a?a:this.world};a.prototype.allMorphsAtPointer=function(){var b=this;return this.world.allChildren().filter(function(a){return a.isVisible&&a.visibleBounds().containsPoint(b.bounds.origin)})};
a.prototype.dropTargetFor=function(b){var a;for(a=this.morphAtPointer();!a.wantsDropOf(b);)a=a.parent;return a};a.prototype.grab=function(b){var a;a=b.parent;if(b instanceof WorldMorph)return null;if(!this.children.length&&(this.world.stopEditing(),this.grabOrigin=b.situation(),b.addShadow(),b.prepareToBeGrabbed&&b.prepareToBeGrabbed(this),this.add(b),this.changed(),a&&a.reactToGrabOf))return a.reactToGrabOf(b)};a.prototype.drop=function(){var b,a;if(this.children.length)return b=this.children[0],
a=this.dropTargetFor(b),this.changed(),a.add(b),b.changed(),b.removeShadow(),this.children=[],this.setExtent(new Point),b.justDropped&&b.justDropped(this),a.reactToDropOf&&a.reactToDropOf(b,this),this.dragOrigin=null};a.prototype.processMouseDown=function(b){var a,d;this.destroyTemporaries();this.morphToGrab=null;if(this.children.length)return this.drop(),this.mouseButton=null;d=this.morphAtPointer();this.world.activeMenu&&(contains(d.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):
this.world.activeMenu.destroy());this.world.activeHandle&&d!==this.world.activeHandle&&this.world.activeHandle.destroy();this.world.cursor&&d!==this.world.cursor.target&&this.world.stopEditing();d.mouseMove||(this.morphToGrab=d.rootForGrab());2===b.button||b.ctrlKey?(this.mouseButton="right",b="mouseDownRight",a="mouseClickRight"):(this.mouseButton="left",b="mouseDownLeft",a="mouseClickLeft");for(this.mouseDownMorph=d;!this.mouseDownMorph[a];)this.mouseDownMorph=this.mouseDownMorph.parent;for(;!d[b];)d=
d.parent;return d[b](this.bounds.origin)};a.prototype.processTouchStart=function(b){var a=this;clearInterval(this.touchHoldTimeout);if(1===b.touches.length)return this.touchHoldTimeout=setInterval(function(){a.processMouseDown({button:2});a.processMouseUp({button:2});b.preventDefault();return clearInterval(a.touchHoldTimeout)},400),this.processMouseMove(b.touches[0]),this.processMouseDown({button:0}),b.preventDefault()};a.prototype.processTouchMove=function(b){if(1===b.touches.length)return b=b.touches[0],
this.processMouseMove(b),clearInterval(this.touchHoldTimeout)};a.prototype.processTouchEnd=function(){clearInterval(this.touchHoldTimeout);return this.processMouseUp({button:0})};a.prototype.processMouseUp=function(){var b,a,d,c;c=this.morphAtPointer();this.destroyTemporaries();if(this.children.length)this.drop();else{if("left"===this.mouseButton)d="mouseClickLeft";else if(d="mouseClickRight",this.mouseButton){b=c;for(a=b.contextMenu();!a&&b.parent;)b=b.parent,a=b.contextMenu();a&&a.popUpAtHand(this.world)}for(;!c[d];)c=
c.parent;c[d](this.bounds.origin)}return this.mouseButton=null};a.prototype.processMouseScroll=function(b){var a;for(a=this.morphAtPointer();a&&!a.mouseScroll;)a=a.parent;if(a)return a.mouseScroll(b.detail/-3||(b.hasOwnProperty("wheelDeltaY")?b.wheelDeltaY/120:b.wheelDelta/120),b.wheelDeltaX/120||0)};a.prototype.processDrop=function(b){var a,d,c,g,f,i,j,k,l,n,m;d=b instanceof FileList?b:b.target.files||b.dataTransfer.files;l=b.dataTransfer?b.dataTransfer.getData("Text/HTML"):null;k=this.morphAtPointer();
c=new Image;i=function(b){var a,h,d;h=new Image;for(a=new FileReader;!d.droppedSVG;)d=d.parent;h.onload=function(){return d.droppedSVG(h,b.name)};a=new FileReader;a.onloadend=function(b){return h.src=b.target.result};return a.readAsDataURL(b)};f=function(b){var a,h;h=new Image;for(a=new FileReader;!k.droppedImage;)k=k.parent;h.onload=function(){var a;a=newCanvas(new Point(h.width,h.height));a.getContext("2d").drawImage(h,0,0);return k.droppedImage(a,b.name)};a=new FileReader;a.onloadend=function(b){return h.src=
b.target.result};return a.readAsDataURL(b)};b=function(b){var a,h;h=new Audio;for(a=new FileReader;!k.droppedAudio;)k=k.parent;a.onloadend=function(a){h.src=a.target.result;return k.droppedAudio(h,b.name)};return a.readAsDataURL(b)};j=function(b){var a;for(a=new FileReader;!k.droppedText;)k=k.parent;a.onloadend=function(a){return k.droppedText(a.target.result,b.name)};return a.readAsText(b)};g=function(b){var a;for(a=new FileReader;!k.droppedBinary;)k=k.parent;a.onloadend=function(a){return k.droppedBinary(a.target.result,
b.name)};return a.readAsArrayBuffer(b)};a=function(b){var a,h,d,c,e;d="";h=b.indexOf('<img src="');if(-1===h)return null;a=c=h+=10;for(e=b.length;h<=e?c<e:c>e;a=h<=e?++c:--c){a=b[a];if('"'===a)return d;d=d.concat(a)}return null};if(d.length){m=[];l=0;for(n=d.length;l<n;l++)a=d[l],-1!==a.type.indexOf("svg")&&!WorldMorph.MorphicPreferences.rasterizeSVGs?m.push(i(a)):0===a.type.indexOf("image")?m.push(f(a)):0===a.type.indexOf("audio")?m.push(b(a)):0===a.type.indexOf("text")?m.push(j(a)):m.push(g(a));
return m}if(l){for(;!k.droppedImage;)k=k.parent;c=new Image;c.onload=function(){var b;b=newCanvas(new Point(c.width,c.height));b.getContext("2d").drawImage(c,0,0);return k.droppedImage(b)};if(d=a(l))return c.src=d}};a.prototype.destroyTemporaries=function(){var b=this;return this.temporaries.forEach(function(a){if(!a.isClickable||!a.bounds.containsPoint(b.position()))return a.destroy(),b.temporaries.splice(b.temporaries.indexOf(a),1)})};a.prototype.moveBy=function(b){Morph.prototype.trackChanges=
!1;a.__super__.moveBy.call(this,b);Morph.prototype.trackChanges=!0;return this.fullChanged()};a.prototype.processMouseMove=function(b){var a,d,c,g=this;c=getDocumentPositionOf(this.world.worldCanvas);c=new Point(b.pageX-c.x,b.pageY-c.y);this.setPosition(c);d=this.morphAtPointer().allParents();if(!this.children.length&&"left"===this.mouseButton&&(a=this.morphAtPointer(),b=a.rootForGrab(),a.mouseMove&&a.mouseMove(c),this.morphToGrab&&(this.morphToGrab.isDraggable?(b=this.morphToGrab,this.grab(b)):this.morphToGrab.isTemplate&&
(b=this.morphToGrab.fullCopy(),b.isTemplate=!1,b.isDraggable=!0,this.grab(b),this.grabOrigin=this.morphToGrab.situation()),a=b.boundsIncludingChildren(),!a.containsPoint(c))))this.bounds.origin=a.center(),this.grab(b),this.setPosition(c);this.mouseOverList.forEach(function(b){if(!contains(d,b)&&(b.mouseLeave&&b.mouseLeave(),b.mouseLeaveDragging&&this.mouseButton))return b.mouseLeaveDragging()});d.forEach(function(b){contains(g.mouseOverList,b)||(b.mouseEnter&&b.mouseEnter(),b.mouseEnterDragging&&
g.mouseButton&&b.mouseEnterDragging());if(g.children.length&&b instanceof ScrollFrameMorph&&!b.bounds.insetBy(3*WorldMorph.MorphicPreferences.scrollBarSize).containsPoint(g.bounds.origin))return b.startAutoScrolling()});return this.mouseOverList=d};return a}(Morph);
BoxMorph=function(c){function a(b,h,d){this.edge=null!=b?b:4;this.border=h||(0===h?0:2);this.borderColor=d||new Color;a.__super__.constructor.call(this)}__extends(a,c);a.prototype.edge=null;a.prototype.border=null;a.prototype.borderColor=null;a.prototype.drawNew=function(){var b;this.image=newCanvas(this.extent());b=this.image.getContext("2d");if(0===this.edge&&0===this.border)return a.__super__.drawNew.call(this),null;b.fillStyle=this.color.toString();b.beginPath();this.outlinePath(b,Math.max(this.edge-
this.border,0),this.border);b.closePath();b.fill();if(0<this.border)return b.lineWidth=this.border,b.strokeStyle=this.borderColor.toString(),b.beginPath(),this.outlinePath(b,this.edge,this.border/2),b.closePath(),b.stroke()};a.prototype.outlinePath=function(b,a,d){var c,g;c=a+d;g=this.width();d=this.height();b.arc(c,c,a,radians(-180),radians(-90),!1);b.arc(g-c,c,a,radians(-90),radians(-0.0),!1);b.arc(g-c,d-c,a,radians(0),radians(90),!1);return b.arc(c,d-c,a,radians(90),radians(180),!1)};a.prototype.developersMenu=
function(){var b;b=a.__super__.developersMenu.call(this);b.addLine();b.addItem("border width...",function(){return this.prompt(b.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size");b.addItem("border color...",function(){return this.pickColor(b.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color");b.addItem("corner size...",function(){return this.prompt(b.title+"\ncorner\nsize:",this.setCornerSize,
this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius");return b};a.prototype.setBorderWidth=function(b){"number"===typeof b?this.border=Math.max(b,0):(b=parseFloat(b),isNaN(b)||(this.border=Math.max(b,0)));this.drawNew();return this.changed()};a.prototype.setBorderColor=function(b){if(b)return this.borderColor=b,this.drawNew(),this.changed()};a.prototype.setCornerSize=function(b){"number"===typeof b?this.edge=Math.max(b,0):(b=parseFloat(b),isNaN(b)||(this.edge=Math.max(b,0)));this.drawNew();
return this.changed()};a.prototype.colorSetters=function(){return["color","borderColor"]};a.prototype.numericalSetters=function(){var b;b=a.__super__.numericalSetters.call(this);b.push("setBorderWidth","setCornerSize");return b};return a}(Morph);
MenuMorph=function(c){function a(b,h,d,c){this.target=b;this.title=null!=h?h:null;this.environment=null!=d?d:null;this.fontSize=null!=c?c:null;this.items=[];a.__super__.constructor.call(this);this.border=null}__extends(a,c);a.prototype.target=null;a.prototype.title=null;a.prototype.environment=null;a.prototype.fontSize=null;a.prototype.items=null;a.prototype.label=null;a.prototype.world=null;a.prototype.isListContents=!1;a.prototype.addItem=function(b,a,d,c){return this.items.push([localize(b||"close"),
a||nop,d,c])};a.prototype.addLine=function(b){return this.items.push([0,b||1])};a.prototype.createLabel=function(){var b;null!==this.label&&this.label.destroy();b=new TextMorph(localize(this.title),this.fontSize||WorldMorph.MorphicPreferences.menuFontSize,WorldMorph.MorphicPreferences.menuFontName,!0,!1,"center");b.alignment="center";b.color=new Color(255,255,255);b.backgroundColor=this.borderColor;b.drawNew();this.label=new BoxMorph(3,0);this.label.color=this.borderColor;this.label.borderColor=this.borderColor;
this.label.setExtent(b.extent().add(4));this.label.drawNew();this.label.add(b);return this.label.text=b};a.prototype.drawNew=function(){var b,h,d,c=this;b=!1;this.children.forEach(function(b){return b.destroy()});this.children=[];this.isListContents||(this.edge=5,this.border=2);this.color=new Color(255,255,255);this.borderColor=new Color(60,60,60);this.silentSetExtent(new Point(0,0));d=2;h=this.left()+4;this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),
this.add(this.label),d=this.label.bottom()):d=this.top()+4);d+=1;this.items.forEach(function(a){var f;b=false;if(a instanceof StringFieldMorph||a instanceof ColorPickerMorph||a instanceof SliderMorph)f=a;else if(a[0]===0){b=true;f=new Morph;f.color=c.borderColor;f.setHeight(a[1])}else f=new MenuItemMorph(c.target,a[1],a[0],c.fontSize||WorldMorph.MorphicPreferences.menuFontSize,WorldMorph.MorphicPreferences.menuFontName,c.environment,a[2],a[3]);b&&(d=d+1);f.setPosition(new Point(h,d));c.add(f);d=d+
f.height();if(b)return d=d+1});this.silentSetExtent(this.boundsIncludingChildren().extent().add(4));this.adjustWidths();return a.__super__.drawNew.call(this)};a.prototype.maxWidth=function(){var b;b=0;this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(b=this.parent.scrollFrame.width());this.children.forEach(function(a){if(a instanceof MenuItemMorph)return b=Math.max(b,a.children[0].width()+8);if(a instanceof StringFieldMorph||a instanceof ColorPickerMorph||a instanceof
SliderMorph)return b=Math.max(b,a.width())});this.label&&(b=Math.max(b,this.label.width()));return b};a.prototype.adjustWidths=function(){var b,a=this;b=this.maxWidth();return this.children.forEach(function(d){var c;d.silentSetWidth(b);if(d instanceof MenuItemMorph){if(c=d.image===d.pressImage,d.createBackgrounds(),c)return d.image=d.pressImage}else if(d.drawNew(),d===a.label)return d.text.setPosition(d.center().subtract(d.text.extent().floorDivideBy(2)))})};a.prototype.unselectAllItems=function(){this.children.forEach(function(b){if(b instanceof
MenuItemMorph)return b.image=b.normalImage});return this.changed()};a.prototype.popup=function(b,a){this.drawNew();this.setPosition(a);this.addShadow(new Point(2,2),80);this.keepWithin(b);b.activeMenu&&b.activeMenu.destroy();b.add(this);b.activeMenu=this;return this.fullChanged()};a.prototype.popUpAtHand=function(b){b=b||this.world;return this.popup(b,b.hand.position())};a.prototype.popUpCenteredAtHand=function(b){b=b||this.world;this.drawNew();return this.popup(b,b.hand.position().subtract(this.extent().floorDivideBy(2)))};
a.prototype.popUpCenteredInWorld=function(b){b=b||this.world;this.drawNew();return this.popup(b,b.center().subtract(this.extent().floorDivideBy(2)))};return a}(BoxMorph);
BouncerMorph=function(c){function a(b,h){this.type=null!=b?b:"vertical";this.speed=null!=h?h:1;a.__super__.constructor.call(this);this.fps=50;this.direction="vertical"===this.type?"down":"right"}__extends(a,c);a.prototype.isStopped=!1;a.prototype.type=null;a.prototype.direction=null;a.prototype.speed=null;a.prototype.moveUp=function(){return this.moveBy(new Point(0,-this.speed))};a.prototype.moveDown=function(){return this.moveBy(new Point(0,this.speed))};a.prototype.moveRight=function(){return this.moveBy(new Point(this.speed,
0))};a.prototype.moveLeft=function(){return this.moveBy(new Point(-this.speed,0))};a.prototype.step=function(){if(!this.isStopped)if("vertical"===this.type){if("down"===this.direction?this.moveDown():this.moveUp(),this.boundsIncludingChildren().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.boundsIncludingChildren().bottom()>this.parent.bottom()&&"down"===this.direction)return this.direction="up"}else if("horizontal"===this.type&&("right"===this.direction?this.moveRight():
this.moveLeft(),this.boundsIncludingChildren().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),this.boundsIncludingChildren().right()>this.parent.right()&&"right"===this.direction))return this.direction="left"};return a}(Morph);
ColorPaletteMorph=function(c){function a(b,h){this.target=null!=b?b:null;a.__super__.constructor.call(this);this.silentSetExtent(h||new Point(80,50));this.drawNew()}__extends(a,c);a.prototype.target=null;a.prototype.targetSetter="color";a.prototype.choice=null;a.prototype.drawNew=function(){var b,a,d,c,g,f,i,j,k;a=this.extent();this.image=newCanvas(this.extent());b=this.image.getContext("2d");this.choice=new Color;k=[];g=i=0;for(j=a.x;0<=j?i<=j:i>=j;g=0<=j?++i:--i)d=360*g/a.x,f=0,k.push(function(){var i,
j,k;k=[];f=i=0;for(j=a.y;0<=j?i<=j:i>=j;f=0<=j?++i:--i)c=100-100*(f/a.y),b.fillStyle="hsl("+d+",100%,"+c+"%)",k.push(b.fillRect(g,f,1,1));return k}());return k};a.prototype.mouseMove=function(b){this.choice=this.getPixelColor(b);return this.updateTarget()};a.prototype.mouseDownLeft=function(b){this.choice=this.getPixelColor(b);return this.updateTarget()};a.prototype.updateTarget=function(){if(this.target instanceof Morph&&null!==this.choice){if(this.target[this.targetSetter]instanceof Function)return this.target[this.targetSetter](this.choice);
this.target[this.targetSetter]=this.choice;this.target.drawNew();return this.target.changed()}};a.prototype.copyRecordingReferences=function(b){var h;h=a.__super__.copyRecordingReferences.call(this,b);h.target&&b[this.target]&&(h.target=b[this.target]);return h};a.prototype.developersMenu=function(){var b;b=a.__super__.developersMenu.call(this);b.addLine();b.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one");return b};a.prototype.setTarget=
function(){var b,a,d=this;b=this.overlappedMorphs();a=new MenuMorph(this,"choose target:");b.push(this.world());b.forEach(function(b){return a.addItem(b.toString().slice(0,50),function(){d.target=b;return d.setTargetSetter()})});if(1===b.length)return this.target=b[0],this.setTargetSetter();if(b.length)return a.popUpAtHand(this.world())};a.prototype.setTargetSetter=function(){var b,a,d=this;b=this.target.colorSetters();a=new MenuMorph(this,"choose target property:");b.forEach(function(b){return a.addItem(b,
function(){return d.targetSetter=b})});if(1===b.length)return this.targetSetter=b[0];if(b.length)return a.popUpAtHand(this.world())};return a}(Morph);
ColorPickerMorph=function(c){function a(b){this.choice=b||new Color(255,255,255);a.__super__.constructor.call(this);this.color=new Color(255,255,255);this.silentSetExtent(new Point(80,80));this.drawNew()}__extends(a,c);a.prototype.choice=null;a.prototype.drawNew=function(){a.__super__.drawNew.call(this);return this.buildSubmorphs()};a.prototype.buildSubmorphs=function(){var b,a;this.children.forEach(function(b){return b.destroy()});this.children=[];this.feedback=new Morph;this.feedback.color=this.choice;
this.feedback.setExtent(new Point(20,20));b=new ColorPaletteMorph(this.feedback,new Point(this.width(),50));a=new GrayPaletteMorph(this.feedback,new Point(this.width(),5));b.setPosition(this.bounds.origin);this.add(b);a.setPosition(b.bottomLeft());this.add(a);b=a.left()+Math.floor((a.width()-this.feedback.width())/2);a=a.bottom()+Math.floor((this.bottom()-a.bottom()-this.feedback.height())/2);this.feedback.setPosition(new Point(b,a));return this.add(this.feedback)};a.prototype.getChoice=function(){return this.feedback.color};
a.prototype.rootForGrab=function(){return this};return a}(Morph);
HandleMorph=function(c){function a(b,h,d,c,g,f){this.target=null!=b?b:null;null==h&&(h=0);null==d&&(d=0);this.type=null!=f?f:"resize";this.minExtent=new Point(h,d);this.inset=new Point(c||0,g||c||0);a.__super__.constructor.call(this);this.color=new Color(255,255,255);this.noticesTransparentClick=!0;b=WorldMorph.MorphicPreferences.handleSize;this.setExtent(new Point(b,b))}__extends(a,c);a.prototype.target=null;a.prototype.minExtent=null;a.prototype.inset=null;a.prototype.type=null;a.prototype.drawNew=
function(){this.normalImage=newCanvas(this.extent());this.highlightImage=newCanvas(this.extent());this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100));this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255));this.image=this.normalImage;if(this.target)return this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed()};a.prototype.drawOnCanvas=function(b,a,d){var c,g,f,i,j,k,b=b.getContext("2d");
b.lineWidth=1;b.lineCap="round";b.strokeStyle=a.toString();if("move"===this.type){c=this.bottomLeft().subtract(this.position());g=c.copy();f=this.topRight().subtract(this.position());i=f.copy();a=j=0;for(k=this.height();j<=k;a=j+=6)g.y=c.y-a,i.y=f.y-a,b.beginPath(),b.moveTo(g.x,g.y),b.lineTo(i.x,i.y),b.closePath(),b.stroke()}c=this.bottomLeft().subtract(this.position());g=c.copy();f=this.topRight().subtract(this.position());i=f.copy();a=j=0;for(k=this.width();j<=k;a=j+=6)g.x=c.x+a,i.x=f.x+a,b.beginPath(),
b.moveTo(g.x,g.y),b.lineTo(i.x,i.y),b.closePath(),b.stroke();b.strokeStyle=d.toString();if("move"===this.type){c=this.bottomLeft().subtract(this.position());g=c.copy();f=this.topRight().subtract(this.position());i=f.copy();a=d=-1;for(j=this.height();d<=j;a=d+=6)g.y=c.y-a,i.y=f.y-a,b.beginPath(),b.moveTo(g.x,g.y),b.lineTo(i.x,i.y),b.closePath(),b.stroke()}c=this.bottomLeft().subtract(this.position());g=c.copy();f=this.topRight().subtract(this.position());i=f.copy();k=[];a=d=2;for(j=this.width();d<=
j;a=d+=6)g.x=c.x+a,i.x=f.x+a,b.beginPath(),b.moveTo(g.x,g.y),b.lineTo(i.x,i.y),b.closePath(),k.push(b.stroke());return k};a.prototype.mouseDownLeft=function(b){var a,d,c=this;d=this.root();a=b.subtract(this.bounds.origin);if(!this.target)return null;this.step=function(){var b;return d.hand.mouseButton?(b=d.hand.bounds.origin.copy().subtract(a),"resize"===c.type?(b=b.add(c.extent().add(c.inset)).subtract(c.target.bounds.origin),b=b.max(c.minExtent),c.target.setExtent(b),c.setPosition(c.target.bottomRight().subtract(c.extent().add(c.inset)))):
c.target.setPosition(b.subtract(c.target.extent()).add(c.extent()))):c.step=null};if(!this.target.step)return this.target.step=noOperation};a.prototype.rootForGrab=function(){return this};a.prototype.mouseEnter=function(){this.image=this.highlightImage;return this.changed()};a.prototype.mouseLeave=function(){this.image=this.normalImage;return this.changed()};a.prototype.copyRecordingReferences=function(b){var h;h=a.__super__.copyRecordingReferences.call(this,b);h.target&&b[this.target]&&(h.target=
b[this.target]);return h};a.prototype.attach=function(){var b,a;b=this.overlappedMorphs();a=new MenuMorph(this,"choose target:");b.forEach(function(b){return a.addItem(b.toString().slice(0,50),function(){this.isDraggable=!1;this.target=b;this.drawNew();return this.noticesTransparentClick=!0})});if(b.length)return a.popUpAtHand(this.world())};return a}(Morph);modules={};useBlurredShadows=getBlurredShadowSupport();
standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,useVirtualKeyboard:!0,rasterizeSVGs:!1};
touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!0,useVirtualKeyboard:!0,rasterizeSVGs:!1};
FrameMorph=function(c){function a(b){this.scrollFrame=null!=b?b:null;a.__super__.constructor.call(this);this.color=new Color(255,250,245);this.drawNew();this.acceptsDrops=!0;this.scrollFrame&&(this.noticesTransparentClick=this.isDraggable=!1,this.alpha=0)}__extends(a,c);a.scrollFrame=null;a.prototype.boundsIncludingChildren=function(){var b;b=this.getShadow();return null!==b?this.bounds.merge(b.bounds):this.bounds};a.prototype.fullImage=function(){return this.image};a.prototype.fullDrawOn=function(b,
a){var d,c;if(!this.isVisible)return null;d=a||this.boundsIncludingChildren();c=this.bounds.intersect(d);if(c.isEmpty())return null;this.drawOn(b,c);return this.children.forEach(function(a){return a instanceof ShadowMorph?a.fullDrawOn(b,d):a.fullDrawOn(b,c)})};a.prototype.moveBy=function(b){this.changed();this.bounds=this.bounds.translateBy(b);this.children.forEach(function(a){return a.silentMoveBy(b)});return this.changed()};a.prototype.submorphBounds=function(){var b;b=null;this.children.length&&
(b=this.children[0].bounds,this.children.forEach(function(a){return b=b.merge(a.boundsIncludingChildren())}));return b};a.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0));this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0));this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top()));if(this.bottom()<
this.scrollFrame.bottom())return this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))};a.prototype.adjustBounds=function(){var b,a=this;if(null===this.scrollFrame)return null;b=(b=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?b.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy();this.bounds.eq(b)||(this.bounds=b,this.drawNew(),this.keepInScrollFrame());this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(b){if(b instanceof
TextMorph){b.setWidth(a.width());return a.setHeight(Math.max(b.height(),a.scrollFrame.height()))}});return this.scrollFrame.adjustScrollBars()};a.prototype.reactToDropOf=function(){return this.adjustBounds()};a.prototype.reactToGrabOf=function(){return this.adjustBounds()};a.prototype.copyRecordingReferences=function(b){var h;h=a.__super__.copyRecordingReferences.call(this,b);h.frame&&b[this.scrollFrame]&&(h.frame=b[this.scrollFrame]);return h};a.prototype.developersMenu=function(){var b;b=a.__super__.developersMenu.call(this);
this.children.length&&(b.addLine(),b.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"));return b};a.prototype.keepAllSubmorphsWithin=function(){var b=this;return this.children.forEach(function(a){return a.keepWithin(b)})};return a}(Morph);
WorldMorph=function(c){function a(b,h){a.__super__.constructor.call(this);this.color=new Color(205,205,205);this.alpha=1;this.bounds=new Rectangle(0,0,b.width,b.height);this.drawNew();this.isVisible=!0;this.isDraggable=!1;this.currentKey=null;this.worldCanvas=b;this.useFillPage=h;void 0===this.useFillPage&&(this.useFillPage=!0);this.isDevMode=!1;this.broken=[];this.hand=new HandMorph(this);this.virtualKeyboard=this.activeHandle=this.activeMenu=this.caret=this.lastEditedText=this.keyboardReceiver=
null;this.initEventListeners()}__extends(a,c);a.MorphicPreferences=standardSettings;a.currentTime=null;a.showRedraws=!1;a.prototype.brokenFor=function(b){var a;a=b.boundsIncludingChildren();return this.broken.filter(function(b){return b.intersects(a)})};a.prototype.fullDrawOn=function(b,h){a.__super__.fullDrawOn.call(this,b,h);return this.hand.fullDrawOn(b,h)};a.prototype.updateBroken=function(){var b=this;this.broken.forEach(function(a){if(a.isNotEmpty())return b.fullDrawOn(b.worldCanvas,a)});return this.broken=
[]};a.prototype.doOneCycle=function(){a.currentTime=Date.now();this.runChildrensStepFunction();return this.updateBroken()};a.prototype.fillPage=function(){var b,a,d,c=this;d=getDocumentPositionOf(this.worldCanvas);b=window.innerHeight;a=window.innerWidth;0<d.x&&(this.worldCanvas.style.position="absolute",this.worldCanvas.style.left="0px",d.x=0);0<d.y&&(this.worldCanvas.style.position="absolute",this.worldCanvas.style.top="0px",d.y=0);document.body.scrollTop&&(b=document.documentElement.clientHeight);
document.body.scrollLeft&&(a=document.documentElement.clientWidth);this.worldCanvas.width!==a&&(this.worldCanvas.width=a,this.setWidth(a));this.worldCanvas.height!==b&&(this.worldCanvas.height=b,this.setHeight(b));return this.children.forEach(function(b){if(b.reactToWorldResize)return b.reactToWorldResize(c.bounds.copy())})};a.prototype.getGlobalPixelColor=function(b){b=this.worldCanvas.getContext("2d").getImageData(b.x,b.y,1,1).data;return new Color(b[0],b[1],b[2])};a.prototype.initVirtualKeyboard=
function(){var b=this;this.virtualKeyboard&&(document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null);if(a.MorphicPreferences.useVirtualKeyboard)return this.virtualKeyboard=document.createElement("input"),this.virtualKeyboard.type="text",this.virtualKeyboard.style.color="transparent",this.virtualKeyboard.style.backgroundColor="transparent",this.virtualKeyboard.style.border="none",this.virtualKeyboard.style.outline="none",this.virtualKeyboard.style.position="absolute",this.virtualKeyboard.style.top=
"0px",this.virtualKeyboard.style.left="0px",this.virtualKeyboard.style.width="0px",this.virtualKeyboard.style.height="0px",document.body.appendChild(this.virtualKeyboard),this.virtualKeyboard.addEventListener("keydown",function(a){b.currentKey=a.keyCode;b.keyboardReceiver&&b.keyboardReceiver.processKeyDown(a);(a.keyIdentifier==="U+0008"||a.keyIdentifier==="Backspace")&&a.preventDefault();if(a.keyIdentifier==="U+0009"||a.keyIdentifier==="Tab"){b.keyboardReceiver&&b.keyboardReceiver.processKeyPress(a);
return a.preventDefault()}},!1),this.virtualKeyboard.addEventListener("keyup",function(a){b.currentKey=null;b.keyboardReceiver&&b.keyboardReceiver.processKeyUp&&b.keyboardReceiver.processKeyUp(a);return a.preventDefault()},!1),this.virtualKeyboard.addEventListener("keypress",function(a){b.keyboardReceiver&&b.keyboardReceiver.processKeyPress(a);return a.preventDefault()},!1)};a.prototype.initEventListeners=function(){var b,a=this;b=this.worldCanvas;this.useFillPage?this.fillPage():this.changed();b.addEventListener("mousedown",
function(b){return a.hand.processMouseDown(b)},!1);b.addEventListener("touchstart",function(b){return a.hand.processTouchStart(b)},!1);b.addEventListener("mouseup",function(b){b.preventDefault();return a.hand.processMouseUp(b)},!1);b.addEventListener("touchend",function(b){return a.hand.processTouchEnd(b)},!1);b.addEventListener("mousemove",function(b){return a.hand.processMouseMove(b)},!1);b.addEventListener("touchmove",function(b){return a.hand.processTouchMove(b)},!1);b.addEventListener("contextmenu",
function(b){return b.preventDefault()},!1);b.addEventListener("keydown",function(b){a.currentKey=b.keyCode;a.keyboardReceiver&&a.keyboardReceiver.processKeyDown(b);("U+0008"===b.keyIdentifier||"Backspace"===b.keyIdentifier)&&b.preventDefault();if("U+0009"===b.keyIdentifier||"Tab"===b.keyIdentifier)return a.keyboardReceiver&&a.keyboardReceiver.processKeyPress(b),b.preventDefault()},!1);b.addEventListener("keyup",function(b){a.currentKey=null;a.keyboardReceiver&&a.keyboardReceiver.processKeyUp&&a.keyboardReceiver.processKeyUp(b);
return b.preventDefault()},!1);b.addEventListener("keypress",function(b){a.keyboardReceiver&&a.keyboardReceiver.processKeyPress(b);return b.preventDefault()},!1);b.addEventListener("mousewheel",function(b){a.hand.processMouseScroll(b);return b.preventDefault()},!1);b.addEventListener("DOMMouseScroll",function(b){a.hand.processMouseScroll(b);return b.preventDefault()},!1);document.body.addEventListener("copy",function(b){var c;if(a.caret&&(c=a.caret.target.selection(),b.clipboardData&&(b.preventDefault(),
b.clipboardData.setData("text/plain",c)),window.clipboardData))return b.returnValue=!1,window.clipboardData.setData("Text",c)},!1);document.body.addEventListener("paste",function(b){var c;if(a.caret)return b.clipboardData&&(c=b.clipboardData.getData("text/plain")),window.clipboardData&&(c=window.clipboardData.getData("Text")),window.setTimeout(function(){return a.caret.insert(c)},50,!0)},!1);window.addEventListener("dragover",function(b){return b.preventDefault()},!1);window.addEventListener("drop",
function(b){a.hand.processDrop(b);return b.preventDefault()},!1);window.addEventListener("resize",function(){if(a.useFillPage)return a.fillPage()},!1);return window.onbeforeunload=function(b){if(b=b||window.event)b.returnValue="Are you sure you want to leave?";return"Are you sure you want to leave?"}};a.prototype.mouseDownLeft=function(){return noOperation};a.prototype.mouseClickLeft=function(){return noOperation};a.prototype.mouseDownRight=function(){return noOperation};a.prototype.mouseClickRight=
function(){return noOperation};a.prototype.wantsDropOf=function(){return this.acceptsDrops};a.prototype.droppedImage=function(){return null};a.prototype.droppedSVG=function(){return null};a.prototype.nextTab=function(b){var a;if(a=this.nextEntryField(b))return b.clearSelection(),a.selectAll(),a.edit()};a.prototype.previousTab=function(b){var a;if(a=this.previousEntryField(b))return b.clearSelection(),a.selectAll(),a.edit()};a.prototype.contextMenu=function(){var b;b=this.isDevMode?new MenuMorph(this,
this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic");this.isDevMode&&(b.addItem("demo...","userCreateMorph","sample morphs"),b.addLine(),b.addItem("hide all...","hideAll"),b.addItem("show all...","showAllHiddens"),b.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),b.addItem("inspect...","inspect","open a window on\nall properties"),b.addLine(),b.addItem("restore display","changed","redraw the\nscreen once"),
b.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizings"),useBlurredShadows?b.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):b.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),b.addItem("color...",function(){return this.pickColor(b.title+"\ncolor:",this.setColor,this,this.color)},"choose the World's\nbackground color"),a.MorphicPreferences===standardSettings?b.addItem("touch screen settings",
"togglePreferences","bigger menu fonts\nand sliders"):b.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),b.addLine());this.isDevMode?b.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):b.addItem("development mode...","toggleDevMode");b.addItem("about morphic.js...","about");return b};a.prototype.userCreateMorph=function(){var b,a,d=this;b=function(b){b.isDraggable=!0;return b.pickUp(d)};a=new MenuMorph(this,"make a morph");a.addItem("rectangle",
function(){return b(new Morph)});a.addItem("box",function(){return b(new BoxMorph)});a.addItem("circle box",function(){return b(new CircleBoxMorph)});a.addLine();a.addItem("slider",function(){return b(new SliderMorph)});a.addItem("frame",function(){var a;a=new FrameMorph;a.setExtent(new Point(350,250));return b(a)});a.addItem("scroll frame",function(){var a;a=new ScrollFrameMorph;a.contents.acceptsDrops=!0;a.contents.adjustBounds();a.setExtent(new Point(350,250));return b(a)});a.addItem("handle",
function(){return b(new HandleMorph)});a.addLine();a.addItem("string",function(){var a;a=new StringMorph("Hello, World!");a.isEditable=!0;return b(a)});a.addItem("text",function(){var a;a=new TextMorph("Ich wei\u00df nicht, was soll es bedeuten, dass ich so traurig bin, ein M\u00e4rchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist k\u00fchl und es dunkelt, und ruhig flie\u00dft der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die sch\u00f6nste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie k\u00e4mmt ihr goldenes Haar, sie k\u00e4mmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die H\u00f6h'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.");
a.isEditable=!0;a.maxWidth=300;a.drawNew();return b(a)});a.addItem("speech bubble",function(){var a;a=new SpeechBubbleMorph("Hello, World!");return b(a)});a.addLine();a.addItem("gray scale palette",function(){return b(new GrayPaletteMorph)});a.addItem("color palette",function(){return b(new ColorPaletteMorph)});a.addItem("color picker",function(){return b(new ColorPickerMorph)});a.addLine();a.addItem("sensor demo",function(){var a;a=new MouseSensorMorph;a.setColor(new Color(230,200,100));a.edge=35;
a.border=15;a.borderColor=new Color(200,100,50);a.alpha=0.2;a.setExtent(new Point(100,100));return b(a)});a.addItem("animation demo",function(){var a,h,d,c,j;d=new BouncerMorph;d.setPosition(new Point(50,20));d.setExtent(new Point(300,200));d.alpha=0.9;d.speed=3;a=new BouncerMorph;a.setColor(new Color(50,50,50));a.setPosition(new Point(80,80));a.setExtent(new Point(80,250));a.type="horizontal";a.direction="right";a.alpha=0.9;a.speed=5;h=new BouncerMorph;h.setColor(new Color(20,20,20));h.setPosition(new Point(90,
140));h.setExtent(new Point(40,30));h.type="horizontal";h.direction="right";h.speed=3;j=new BouncerMorph;j.setColor(new Color(200,20,20));j.setPosition(new Point(90,140));j.setExtent(new Point(20,20));j.type="vertical";j.direction="up";j.speed=8;c=new BouncerMorph;c.setColor(new Color(20,200,20));c.setPosition(new Point(120,140));c.setExtent(new Point(20,20));c.type="vertical";c.direction="down";c.speed=4;a.add(j);a.add(h);d.add(c);d.add(a);return b(d)});a.addItem("pen",function(){return b(new PenMorph)});
a.addLine();a.addItem("view all...",function(){var a;a=new MorphsListMorph;return b(a)});this.customMorphs&&(a.addLine(),this.customMorphs().forEach(function(d){return a.addItem(d.toString(),function(){return b(d)})}));return a.popUpAtHand(this)};a.prototype.toggleDevMode=function(){return this.isDevMode=!this.isDevMode};a.prototype.hideAll=function(){return this.children.forEach(function(b){return b.hide()})};a.prototype.showAllHiddens=function(){return this.forAllChildren(function(b){if(!b.isVisible)return b.show()})};
a.prototype.about=function(){var b,a;a="";for(b in modules)modules.hasOwnProperty(b)&&(a+="\n"+b+" ("+modules[b]+")");""!==a&&(a="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+a);return this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\noriginal from Jens M\u00f6nig's (jens@moenig.org) morphic.js\n\n\nported and extended by Davide Della Casa\n"+a)};a.prototype.edit=function(b){var h;h=getDocumentPositionOf(this.worldCanvas);if(!b.isEditable)return null;this.caret&&
this.caret.destroy();this.lastEditedText&&this.lastEditedText.clearSelection();this.caret=new CaretMorph(b);b.parent.add(this.caret);this.keyboardReceiver=this.caret;this.initVirtualKeyboard();a.MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard.style.top=this.caret.top()+h.y+"px",this.virtualKeyboard.style.left=this.caret.left()+h.x+"px",this.virtualKeyboard.focus());if(a.MorphicPreferences.useSliderForInput&&!b.parentThatIsA(MenuMorph))return this.slide(b)};a.prototype.slide=function(b){var h,
d;d=parseFloat(b.text);isNaN(d)&&(d=0);h=new MenuMorph;d=new SliderMorph(d-25,d+25,d,10,"horizontal");d.alpha=1;d.color=new Color(225,225,225);d.button.color=h.borderColor;d.button.highlightColor=d.button.color.copy();d.button.highlightColor.b+=100;d.button.pressColor=d.button.color.copy();d.button.pressColor.b+=150;d.silentSetHeight(a.MorphicPreferences.scrollBarSize);d.silentSetWidth(10*a.MorphicPreferences.menuFontSize);d.drawNew();d.action=function(a){b.changed();b.text=Math.round(a).toString();
b.drawNew();b.changed();return b.escalateEvent("reactToSliderEdit",b)};h.items.push(d);return h.popup(this,b.bottomLeft().add(new Point(0,5)))};a.prototype.stopEditing=function(){this.caret&&(this.lastEditedText=this.caret.target,this.caret.destroy(),this.caret=null,this.lastEditedText.escalateEvent("reactToEdit",this.lastEditedText));this.keyboardReceiver=null;this.virtualKeyboard&&(this.virtualKeyboard.blur(),document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null);return this.worldCanvas.focus()};
a.prototype.toggleBlurredShadows=function(){return useBlurredShadows=!useBlurredShadows};a.prototype.togglePreferences=function(){return a.MorphicPreferences===standardSettings?a.MorphicPreferences=touchScreenSettings:a.MorphicPreferences=standardSettings};return a}(FrameMorph);BlinkerMorph=function(c){function a(b){this.fps=null!=b?b:2;a.__super__.constructor.call(this);this.color=new Color(0,0,0);this.drawNew()}__extends(a,c);a.prototype.step=function(){return this.toggleVisibility()};return a}(Morph);
ScrollFrameMorph=function(c){function a(b,h,d){var c=this;a.__super__.constructor.call(this);this.scrollBarSize=h||WorldMorph.MorphicPreferences.scrollBarSize;this.contents=b||new FrameMorph(this);this.add(this.contents);this.hBar=new SliderMorph(null,null,null,null,"horizontal",d);this.hBar.setHeight(this.scrollBarSize);this.hBar.action=function(b){return c.contents.setPosition(new Point(c.left()-b,c.contents.position().y))};this.hBar.isDraggable=!1;this.add(this.hBar);this.vBar=new SliderMorph(null,
null,null,null,"vertical",d);this.vBar.setWidth(this.scrollBarSize);this.vBar.action=function(b){return c.contents.setPosition(new Point(c.contents.position().x,c.top()-b))};this.vBar.isDraggable=!1;this.add(this.vBar)}__extends(a,c);a.prototype.autoScrollTrigger=null;a.prototype.hasVelocity=!0;a.prototype.padding=0;a.prototype.growth=0;a.prototype.isTextLineWrapping=!1;a.prototype.isScrollingByDragging=!0;a.prototype.scrollBarSize=null;a.prototype.contents=null;a.prototype.vBar=null;a.prototype.hBar=
null;a.prototype.adjustScrollBars=function(){var b,a;b=this.width()-this.scrollBarSize;a=this.height()-this.scrollBarSize;this.changed();this.contents.width()>this.width()+WorldMorph.MorphicPreferences.scrollBarSize?(this.hBar.show(),this.hBar.width()!==b&&this.hBar.setWidth(b),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=
this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide();return this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==a&&this.vBar.setHeight(a),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide()};a.prototype.addContents=
function(b){this.contents.add(b);return this.contents.adjustBounds()};a.prototype.setContents=function(b){this.contents.children.forEach(function(b){return b.destroy()});this.contents.children=[];b.setPosition(this.position().add(this.padding+2));return this.addContents(b)};a.prototype.setExtent=function(b){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy());a.__super__.setExtent.call(this,b);return this.contents.adjustBounds()};a.prototype.scrollX=function(b){var a,d,c,g;a=
this.contents.left();c=this.left();d=this.contents.width();g=this.right();b=a+b;b>c&&(b=c);b+d<g&&(b=g-d);if(b!==a)return this.contents.setLeft(b)};a.prototype.scrollY=function(b){var a,c,e,g;e=this.contents.top();g=this.top();c=this.contents.height();a=this.bottom();b=e+b;b>g&&(b=g);b+c<a&&(b=a-c);if(b!==e)return this.contents.setTop(b)};a.prototype.mouseDownLeft=function(b){var a,c,e,g,f=this;if(!this.isScrollingByDragging)return null;g=this.root();e=b;c=a=0;return this.step=function(){var b;g.hand.mouseButton&&
!g.hand.children.length&&f.bounds.containsPoint(g.hand.position())?(b=g.hand.bounds.origin,a=b.x-e.x,0!==a&&f.scrollX(a),c=b.y-e.y,0!==c&&f.scrollY(c),e=b):f.hasVelocity?0.5>Math.abs(a)&&0.5>Math.abs(c)?f.step=noOperation:(a*=0.8,f.scrollX(Math.round(a)),c*=0.8,f.scrollY(Math.round(c))):f.step=noOperation;return f.adjustScrollBars()}};a.prototype.startAutoScrolling=function(){var b,a,c,e=this;a=3*WorldMorph.MorphicPreferences.scrollBarSize;c=this.world();if(!c)return null;b=c.hand;this.autoScrollTrigger||
(this.autoScrollTrigger=Date.now());return this.step=function(){var c,d;d=b.bounds.origin;c=e.bounds.insetBy(a);if(e.bounds.containsPoint(d)&&!c.containsPoint(d)&&b.children.length)return e.autoScroll(d);e.step=noOperation;return e.autoScrollTrigger=null}};a.prototype.autoScroll=function(b){var a,c;if(500>Date.now()-this.autoScrollTrigger)return null;c=3*WorldMorph.MorphicPreferences.scrollBarSize;a=this.topLeft().extent(new Point(this.width(),c));a.containsPoint(b)&&this.scrollY(c-(b.y-this.top()));
a=this.topLeft().extent(new Point(c,this.height()));a.containsPoint(b)&&this.scrollX(c-(b.x-this.left()));a=(new Point(this.right()-c,this.top())).extent(new Point(c,this.height()));a.containsPoint(b)&&this.scrollX(-(c-(this.right()-b.x)));a=(new Point(this.left(),this.bottom()-c)).extent(new Point(this.width(),c));a.containsPoint(b)&&this.scrollY(-(c-(this.bottom()-b.y)));return this.adjustScrollBars()};a.prototype.scrollCaretIntoView=function(b){var a,c,e,g;g=b.target;e=g.position().subtract(this.contents.position());
c=this.top()+this.padding;a=this.bottom()-this.padding;this.contents.setExtent(g.extent().add(e).add(this.padding));b.top()<c?(this.contents.setTop(this.contents.top()+c-b.top()),b.setTop(c)):b.bottom()>a&&(this.contents.setBottom(this.contents.bottom()+a-b.bottom()),b.setBottom(a));return this.adjustScrollBars()};a.prototype.mouseScroll=function(b,a){b&&this.scrollY(b*WorldMorph.MorphicPreferences.mouseScrollAmount);a&&this.scrollX(a*WorldMorph.MorphicPreferences.mouseScrollAmount);return this.adjustScrollBars()};
a.prototype.copyRecordingReferences=function(b){var c;c=a.__super__.copyRecordingReferences.call(this,b);c.contents&&b[this.contents]&&(c.contents=b[this.contents]);c.hBar&&b[this.hBar]&&(c.hBar=b[this.hBar],c.hBar.action=function(b){return c.contents.setPosition(new Point(c.left()-b,c.contents.position().y))});c.vBar&&b[this.vBar]&&(c.vBar=b[this.vBar],c.vBar.action=function(b){return c.contents.setPosition(new Point(c.contents.position().x,c.top()-b))});return c};a.prototype.developersMenu=function(){var b;
b=a.__super__.developersMenu.call(this);this.isTextLineWrapping?b.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):b.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping");return b};a.prototype.toggleTextLineWrapping=function(){return this.isTextLineWrapping=!this.isTextLineWrapping};return a}(FrameMorph);
CircleBoxMorph=function(c){function a(b){this.orientation=null!=b?b:"vertical";a.__super__.constructor.call(this);this.setExtent(new Point(20,100))}__extends(a,c);a.prototype.orientation=null;a.prototype.autoOrient=!0;a.prototype.autoOrientation=function(){return this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"};a.prototype.drawNew=function(){var b,a,c,e,g,f=this;this.autoOrient&&this.autoOrientation();this.image=newCanvas(this.extent());c=this.image.getContext("2d");
"vertical"===this.orientation?(e=this.width()/2,g=this.center().x,b=new Point(g,this.top()+e),a=new Point(g,this.bottom()-e),g=this.bounds.origin.add(new Point(0,e)).corner(this.bounds.corner.subtract(new Point(0,e)))):(e=this.height()/2,g=this.center().y,b=new Point(this.left()+e,g),a=new Point(this.right()-e,g),g=this.bounds.origin.add(new Point(e,0)).corner(this.bounds.corner.subtract(new Point(e,0))));[b.subtract(this.bounds.origin),a.subtract(this.bounds.origin)].forEach(function(b){c.fillStyle=
f.color.toString();c.beginPath();c.arc(b.x,b.y,e,0,2*Math.PI,false);c.closePath();return c.fill()});g=g.translateBy(this.bounds.origin.neg());b=g.extent();if(0<b.x&&0<b.y)return c.fillRect(g.origin.x,g.origin.y,g.width(),g.height())};a.prototype.developersMenu=function(){var b;b=a.__super__.developersMenu.call(this);b.addLine();"vertical"===this.orientation?b.addItem("horizontal...","toggleOrientation","toggle the\norientation"):b.addItem("vertical...","toggleOrientation","toggle the\norientation");
return b};a.prototype.toggleOrientation=function(){var b;b=this.center();this.changed();this.orientation="vertical"===this.orientation?"horizontal":"vertical";this.silentSetExtent(new Point(this.height(),this.width()));this.setCenter(b);this.drawNew();return this.changed()};return a}(Morph);
Color=function(){function c(a,b,c,d){this.r=null!=a?a:0;this.g=null!=b?b:0;this.b=null!=c?c:0;this.a=d||(0===d?0:1)}c.prototype.a=null;c.prototype.r=null;c.prototype.g=null;c.prototype.b=null;c.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"};c.prototype.copy=function(){return new c(this.r,this.g,this.b,this.a)};c.prototype.eq=function(a){return a&&this.r===a.r&&this.g===a.g&&this.b===a.b};c.prototype.hsv=function(){var a,
b,c,d,e,g,f;f=this.r/255;c=this.g/255;a=this.b/255;e=Math.max(f,c,a);g=Math.min(f,c,a);d=e;b=e-g;if(e===g)d=0;else{switch(e){case f:d=(c-a)/b+(c<a?6:0);break;case c:d=(a-f)/b+2;break;case a:d=(f-c)/b+4}d/=6}return[d,0===e?0:b/e,e]};c.prototype.set_hsv=function(a,b,c){var d,e,g;e=Math.floor(6*a);d=6*a-e;a=c*(1-b);g=c*(1-d*b);b=c*(1-(1-d)*b);switch(e%6){case 0:this.r=c;this.g=b;this.b=a;break;case 1:this.r=g;this.g=c;this.b=a;break;case 2:this.r=a;this.g=c;this.b=b;break;case 3:this.r=a;this.g=g;this.b=
c;break;case 4:this.r=b;this.g=a;this.b=c;break;case 5:this.r=c,this.g=a,this.b=g}this.r*=255;this.g*=255;return this.b*=255};c.prototype.mixed=function(a,b){var h,d;h=Math.min(Math.max(a,0),1);d=1-h;return new c(this.r*h+b.r*d,this.g*h+b.g*d,this.b*h+b.b*d)};c.prototype.darker=function(a){var b;b=0.8333;a&&(b=(100-a)/100);return this.mixed(b,new c(0,0,0))};c.prototype.lighter=function(a){var b;b=0.8333;a&&(b=(100-a)/100);return this.mixed(b,new c(255,255,255))};c.prototype.dansDarker=function(){var a,
b,h;a=this.hsv();b=new c;h=Math.max(a[2]-0.16,0);b.set_hsv(a[0],a[1],h);return b};return c}();
SliderButtonMorph=function(c){function a(b){this.color=new Color(80,80,80);a.__super__.constructor.call(this,b)}__extends(a,c);a.prototype.highlightColor=new Color(90,90,140);a.prototype.pressColor=new Color(80,80,160);a.prototype.is3D=!0;a.prototype.hasMiddleDip=!0;a.prototype.autoOrientation=function(){return noOperation};a.prototype.drawNew=function(){var b;b=this.color.copy();a.__super__.drawNew.call(this);this.is3D&&this.drawEdges();this.normalImage=this.image;this.color=this.highlightColor.copy();
a.__super__.drawNew.call(this);this.is3D&&this.drawEdges();this.highlightImage=this.image;this.color=this.pressColor.copy();a.__super__.drawNew.call(this);this.is3D&&this.drawEdges();this.pressImage=this.image;this.color=b;return this.image=this.normalImage};a.prototype.drawEdges=function(){var b,a,c,e,g;b=this.image.getContext("2d");g=this.width();c=this.height();b.lineJoin="round";b.lineCap="round";if("vertical"===this.orientation){if(b.lineWidth=g/3,a=b.createLinearGradient(0,0,b.lineWidth,0),
a.addColorStop(0,"white"),a.addColorStop(1,this.color.toString()),b.strokeStyle=a,b.beginPath(),b.moveTo(0.5*b.lineWidth,g/2),b.lineTo(0.5*b.lineWidth,c-g/2),b.stroke(),a=b.createLinearGradient(g-b.lineWidth,0,g,0),a.addColorStop(0,this.color.toString()),a.addColorStop(1,"black"),b.strokeStyle=a,b.beginPath(),b.moveTo(g-0.5*b.lineWidth,g/2),b.lineTo(g-0.5*b.lineWidth,c-g/2),b.stroke(),this.hasMiddleDip)return a=b.createLinearGradient(b.lineWidth,0,g-b.lineWidth,0),e=g/4,a.addColorStop(0,"black"),
a.addColorStop(0.35,this.color.toString()),a.addColorStop(0.65,this.color.toString()),a.addColorStop(1,"white"),b.fillStyle=a,b.beginPath(),b.arc(g/2,c/2,e,radians(0),radians(360),!1),b.closePath(),b.fill()}else if("horizontal"===this.orientation&&(b.lineWidth=c/3,a=b.createLinearGradient(0,0,0,b.lineWidth),a.addColorStop(0,"white"),a.addColorStop(1,this.color.toString()),b.strokeStyle=a,b.beginPath(),b.moveTo(c/2,0.5*b.lineWidth),b.lineTo(g-c/2,0.5*b.lineWidth),b.stroke(),a=b.createLinearGradient(0,
c-b.lineWidth,0,c),a.addColorStop(0,this.color.toString()),a.addColorStop(1,"black"),b.strokeStyle=a,b.beginPath(),b.moveTo(c/2,c-0.5*b.lineWidth),b.lineTo(g-c/2,c-0.5*b.lineWidth),b.stroke(),this.hasMiddleDip))return a=b.createLinearGradient(0,b.lineWidth,0,c-b.lineWidth),e=c/4,a.addColorStop(0,"black"),a.addColorStop(0.35,this.color.toString()),a.addColorStop(0.65,this.color.toString()),a.addColorStop(1,"white"),b.fillStyle=a,b.beginPath(),b.arc(this.width()/2,this.height()/2,e,radians(0),radians(360),
!1),b.closePath(),b.fill()};a.prototype.mouseEnter=function(){this.image=this.highlightImage;return this.changed()};a.prototype.mouseLeave=function(){this.image=this.normalImage;return this.changed()};a.prototype.mouseDownLeft=function(b){this.image=this.pressImage;this.changed();return this.escalateEvent("mouseDownLeft",b)};a.prototype.mouseClickLeft=function(){this.image=this.highlightImage;return this.changed()};a.prototype.mouseMove=function(){return noOperation};return a}(CircleBoxMorph);
SpeechBubbleMorph=function(c){function a(b,c,d,e,g,f,i){this.contents=null!=b?b:"";this.padding=null!=f?f:0;this.isThought=null!=i?i:!1;a.__super__.constructor.call(this,d||6,e||(0===e?0:1),g||new Color(140,140,140));this.color=c||new Color(230,230,230);this.drawNew()}__extends(a,c);a.prototype.isPointingRight=!0;a.prototype.contents=null;a.prototype.padding=null;a.prototype.isThought=null;a.prototype.isClickable=!1;a.prototype.popUp=function(b,a,c){this.drawNew();this.setPosition(a.subtract(new Point(0,
this.height())));this.addShadow(new Point(2,2),80);this.keepWithin(b);b.add(this);this.changed();b.hand.destroyTemporaries();b.hand.temporaries.push(this);return c?this.mouseEnter=function(){return this.destroy()}:this.isClickable=!1};a.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy();this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,WorldMorph.MorphicPreferences.bubbleHelpFontSize,null,
!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contentsMorph=new TextMorph(this.contents.toString(),WorldMorph.MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center");this.add(this.contentsMorph);this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge));this.silentSetHeight(this.contentsMorph.height()+
this.edge+2*this.border+2*this.padding+2);a.__super__.drawNew.call(this);return this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))};a.prototype.outlinePath=function(b,a,c){var e,g,f,i;e=function(a,c,h){b.moveTo(a+h,c);return b.arc(a,c,h,radians(0),radians(360))};f=a+c;i=this.width();g=this.height();b.arc(f,f,a,radians(-180),radians(-90),!1);b.arc(i-f,f,a,radians(-90),radians(-0.0),!1);b.arc(i-f,g-f-a,a,radians(0),radians(90),!1);this.isThought||
(this.isPointingRight?(b.lineTo(f+a,g-f),b.lineTo(a/2+c,g-c)):(b.lineTo(i-(a/2+c),g-c),b.lineTo(i-(f+a),g-f)));b.arc(f,g-f-a,a,radians(90),radians(180),!1);if(this.isThought){b.lineTo(c,f);if(this.isPointingRight)return f=a/4,e(f+c,g-f-c,f),f=a/3.2,e(2*f+c,g-f-2*c,f),f=a/2.8,e(3*f+2*c,g-f-4*c,f);f=a/4;e(i-(f+c),g-f-c,f);f=a/3.2;e(i-(2*f+c),g-f-2*c,f);f=a/2.8;return e(i-(3*f+2*c),g-f-4*c,f)}};a.prototype.shadowImage=function(b,a){var c,e,g,f,i,j;i=b||new Point(7,7);c=a||new Color(0,0,0);g=this.extent();
f=this.image;j=newCanvas(g);e=j.getContext("2d");e.drawImage(f,0,0);e.globalCompositeOperation="destination-out";e.drawImage(f,-i.x,-i.y);f=newCanvas(g);e=f.getContext("2d");e.drawImage(j,0,0);e.globalCompositeOperation="source-atop";e.fillStyle=c.toString();e.fillRect(0,0,g.x,g.y);return f};a.prototype.shadowImageBlurred=function(b,a){var c,e,g,f,i,j;i=b||new Point(7,7);c=this.shadowBlur;e=a||new Color(0,0,0);g=this.extent().add(2*c);f=this.image;j=newCanvas(g);g=j.getContext("2d");g.shadowOffsetX=
i.x;g.shadowOffsetY=i.y;g.shadowBlur=c;g.shadowColor=e.toString();g.drawImage(f,c-i.x,c-i.y);g.shadowOffsetX=0;g.shadowOffsetY=0;g.shadowBlur=0;g.globalCompositeOperation="destination-out";g.drawImage(f,c-i.x,c-i.y);return j};a.prototype.fixLayout=function(){this.removeShadow();this.drawNew();return this.addShadow(new Point(2,2),80)};return a}(BoxMorph);
CaretMorph=function(c){function a(b){this.target=b;this.originalContents=this.target.text;this.originalAlignment=this.target.alignment;this.slot=this.target.text.length;a.__super__.constructor.call(this);b=fontHeight(this.target.fontSize);this.setExtent(new Point(Math.max(Math.floor(b/20),1),b));this.drawNew();this.image.getContext("2d").font=this.target.font();this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft();this.gotoSlot(this.slot)}__extends(a,c);
a.prototype.keyDownEventUsed=!1;a.prototype.target=null;a.prototype.originalContents=null;a.prototype.slot=null;a.prototype.viewPadding=1;a.prototype.processKeyPress=function(b){if(this.keyDownEventUsed)return this.keyDownEventUsed=!1,null;if(40===b.keyCode||40===b.charCode)return this.insert("("),null;if(37===b.keyCode||37===b.charCode)return this.insert("%"),null;b.keyCode?b.ctrlKey?this.ctrl(b.keyCode):b.metaKey?this.cmd(b.keyCode):this.insert(String.fromCharCode(b.keyCode),b.shiftKey):b.charCode&&
(b.ctrlKey?this.ctrl(b.charCode):b.metaKey?this.cmd(b.keyCode):this.insert(String.fromCharCode(b.charCode),b.shiftKey));return this.target.escalateEvent("reactToKeystroke",b)};a.prototype.processKeyDown=function(b){var a;a=b.shiftKey;this.keyDownEventUsed=!1;if(b.ctrlKey)this.ctrl(b.keyCode),this.target.escalateEvent("reactToKeystroke",b);else if(b.metaKey)this.cmd(b.keyCode),this.target.escalateEvent("reactToKeystroke",b);else{switch(b.keyCode){case 37:this.goLeft(a);this.keyDownEventUsed=!0;break;
case 39:this.goRight(a);this.keyDownEventUsed=!0;break;case 38:this.goUp(a);this.keyDownEventUsed=!0;break;case 40:this.goDown(a);this.keyDownEventUsed=!0;break;case 36:this.goHome(a);this.keyDownEventUsed=!0;break;case 35:this.goEnd(a);this.keyDownEventUsed=!0;break;case 46:this.deleteRight();this.keyDownEventUsed=!0;break;case 8:this.deleteLeft();this.keyDownEventUsed=!0;break;case 13:"StringMorph"===this.target.constructor.name?this.accept():this.insert("\n");this.keyDownEventUsed=!0;break;case 27:this.cancel(),
this.keyDownEventUsed=!0}return this.target.escalateEvent("reactToKeystroke",b)}};a.prototype.gotoSlot=function(b){var a,c;a=this.target.text.length;c=this.target.slotPosition(b);this.slot=0>b?0:b>a?a:b;if(this.parent&&this.target.isScrollable&&(a=this.parent.right()-this.viewPadding,b=this.parent.left()+this.viewPadding,c.x>a&&(this.target.setLeft(this.target.left()+a-c.x),c.x=a),c.x<b&&(b=Math.min(this.parent.left(),b),this.target.setLeft(this.target.left()+b-c.x),c.x=b),this.target.right()<a&&
a-this.target.width()<b))c.x+=a-this.target.right(),this.target.setRight(a);this.show();this.setPosition(c);if(this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable)return this.parent.parent.scrollCaretIntoView(this)};a.prototype.goLeft=function(b){this.updateSelection(b);this.gotoSlot(this.slot-1);return this.updateSelection(b)};a.prototype.goRight=function(b,a){this.updateSelection(b);this.gotoSlot(this.slot+(a||1));return this.updateSelection(b)};a.prototype.goUp=
function(b){this.updateSelection(b);this.gotoSlot(this.target.upFrom(this.slot));return this.updateSelection(b)};a.prototype.goDown=function(b){this.updateSelection(b);this.gotoSlot(this.target.downFrom(this.slot));return this.updateSelection(b)};a.prototype.goHome=function(b){this.updateSelection(b);this.gotoSlot(this.target.startOfLine(this.slot));return this.updateSelection(b)};a.prototype.goEnd=function(b){this.updateSelection(b);this.gotoSlot(this.target.endOfLine(this.slot));return this.updateSelection(b)};
a.prototype.gotoPos=function(b){this.gotoSlot(this.target.slotAt(b));return this.show()};a.prototype.updateSelection=function(b){if(b){if(!this.target.endMark&&!this.target.startMark)return this.target.startMark=this.slot,this.target.endMark=this.slot;if(this.target.endMark!==this.slot)return this.target.endMark=this.slot,this.target.drawNew(),this.target.changed()}else return this.target.clearSelection()};a.prototype.accept=function(){var b;(b=this.root())&&b.stopEditing();return this.escalateEvent("accept",
null)};a.prototype.cancel=function(){var b;b=this.root();this.undo();b&&b.stopEditing();return this.escalateEvent("cancel",null)};a.prototype.undo=function(){this.target.text=this.originalContents;this.target.changed();this.target.drawNew();this.target.changed();return this.gotoSlot(0)};a.prototype.insert=function(b,a){var c;if("\t"===b)return this.target.escalateEvent("reactToEdit",this.target),a?this.target.backTab(this.target):this.target.tab(this.target);if(!this.target.isNumeric||!isNaN(parseFloat(b))||
contains(["-","."],b))return""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()),c=this.target.text,c=c.slice(0,this.slot)+b+c.slice(this.slot),this.target.text=c,this.target.drawNew(),this.target.changed(),this.goRight(!1,b.length)};a.prototype.ctrl=function(b){if(97===b||65===b)return this.target.selectAll();if(90===b)return this.undo();if(123===b)return this.insert("{");if(125===b)return this.insert("}");if(91===b)return this.insert("[");
if(93===b)return this.insert("]");if(64===b)return this.insert("@")};a.prototype.cmd=function(b){if(65===b)return this.target.selectAll();if(90===b)return this.undo()};a.prototype.deleteRight=function(){var b;if(""!==this.target.selection())return this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection();b=this.target.text;this.target.changed();b=b.slice(0,this.slot)+b.slice(this.slot+1);this.target.text=b;return this.target.drawNew()};a.prototype.deleteLeft=function(){var b;if(this.target.selection())return this.gotoSlot(this.target.selectionStartSlot()),
this.target.deleteSelection();b=this.target.text;this.target.changed();this.target.text=b.substring(0,this.slot-1)+b.substr(this.slot);this.target.drawNew();return this.goLeft()};a.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.drawNew(),this.target.changed());return a.__super__.destroy.apply(this,arguments)};a.prototype.inspectKeyEvent=function(b){return this.inform("Key pressed: "+String.fromCharCode(b.charCode)+
"\n------------------------\ncharCode: "+b.charCode.toString()+"\nkeyCode: "+b.keyCode.toString()+"\naltKey: "+b.altKey.toString()+"\nctrlKey: "+b.ctrlKey.toString()+"\ncmdKey: "+b.metaKey.toString())};return a}(BlinkerMorph);
PenMorph=function(c){function a(){this.penSize=4*WorldMorph.MorphicPreferences.handleSize;a.__super__.constructor.call(this);this.setExtent(new Point(this.penSize,this.penSize));this.penSize=1}__extends(a,c);a.prototype.heading=0;a.prototype.penSize=null;a.prototype.isWarped=!1;a.prototype.isDown=!0;a.prototype.wantsRedraw=!1;a.prototype.penPoint="tip";a.staticVariable=1;a.staticFunction=function(){return 3.14};a.prototype.changed=function(){var b;if(!1===this.isWarped&&(b=this.root(),b instanceof
WorldMorph&&b.broken.push(this.visibleBounds().spread()),this.parent))return this.parent.childChanged(this)};a.prototype.drawNew=function(b){var a,c,e,g,f;c=b||this.heading;if(this.isWarped)this.wantsRedraw=!0;else return this.image=newCanvas(this.extent()),b=this.image.getContext("2d"),g=this.width()/2,f=this.center().subtract(this.bounds.origin),"tip"===this.penPoint?(a=f.distanceAngle(0.75*g,c-180),e=f.distanceAngle(g,c+195),c=f.distanceAngle(g,c-195)):(a=f.distanceAngle(0.75*g,c),e=f.distanceAngle(0.33*
g,c+230),c=f.distanceAngle(0.33*g,c-230)),b.fillStyle=this.color.toString(),b.beginPath(),b.moveTo(f.x,f.y),b.lineTo(e.x,e.y),b.lineTo(a.x,a.y),b.lineTo(c.x,c.y),b.closePath(),b.strokeStyle="white",b.lineWidth=3,b.stroke(),b.strokeStyle="black",b.lineWidth=1,b.stroke(),b.fill(),this.wantsRedraw=!1};a.prototype.setHeading=function(b){this.heading=parseFloat(b)%360;this.drawNew();return this.changed()};a.prototype.drawLine=function(b,a){var c,e,g;c=this.parent.penTrails().getContext("2d");e=b.subtract(this.parent.bounds.origin);
g=a.subtract(this.parent.bounds.origin);if(this.isDown&&(c.lineWidth=this.penSize,c.strokeStyle=this.color.toString(),c.lineCap="round",c.lineJoin="round",c.beginPath(),c.moveTo(e.x,e.y),c.lineTo(g.x,g.y),c.stroke(),!1===this.isWarped))return this.world().broken.push(b.rectangle(a).expandBy(Math.max(this.penSize/2,1)).intersect(this.parent.visibleBounds()).spread())};a.prototype.turn=function(b){return this.setHeading(this.heading+parseFloat(b))};a.prototype.forward=function(b){var a;a=this.center();
b=parseFloat(b);this.setPosition(0<=b?this.position().distanceAngle(b,this.heading):this.position().distanceAngle(Math.abs(b),this.heading-180));return this.drawLine(a,this.center())};a.prototype.down=function(){return this.isDown=!0};a.prototype.up=function(){return this.isDown=!1};a.prototype.clear=function(){this.parent.drawNew();return this.parent.changed()};a.prototype.startWarp=function(){this.wantsRedraw=!1;return this.isWarped=!0};a.prototype.endWarp=function(){this.isWarped=!1;this.wantsRedraw&&
(this.drawNew(),this.wantsRedraw=!1);return this.parent.changed()};a.prototype.warp=function(b){this.startWarp();b.call(this);return this.endWarp()};a.prototype.warpOp=function(b,a){this.startWarp();this[b].apply(this,a);return this.endWarp()};a.prototype.warpSierpinski=function(b,a){return this.warpOp("sierpinski",[b,a])};a.prototype.sierpinski=function(b,a){var c,e;if(b>a){e=[];for(c=0;3>c;++c)this.sierpinski(0.5*b,a),this.turn(120),e.push(this.forward(b));return e}};a.prototype.warpTree=function(b,
a,c){return this.warpOp("tree",[b,a,c])};a.prototype.tree=function(b,a,c){if(0<b)return this.penSize=b,this.forward(a),this.turn(c),this.tree(b-1,0.75*a,c),this.turn(-2*c),this.tree(b-1,0.75*a,c),this.turn(c),this.forward(-a)};return a}(Morph);
GrayPaletteMorph=function(c){function a(b,c){this.target=null!=b?b:null;a.__super__.constructor.call(this,this.target,c||new Point(80,10))}__extends(a,c);a.prototype.drawNew=function(){var b,a,c;a=this.extent();this.image=newCanvas(this.extent());b=this.image.getContext("2d");this.choice=new Color;c=b.createLinearGradient(0,0,a.x,a.y);c.addColorStop(0,"black");c.addColorStop(1,"white");b.fillStyle=c;return b.fillRect(0,0,a.x,a.y)};return a}(ColorPaletteMorph);
ListMorph=function(c){function a(b,c,d){this.elements=null!=b?b:[];this.format=null!=d?d:[];a.__super__.constructor.call(this);this.contents.acceptsDrops=!1;this.color=new Color(255,255,255);this.hBar.alpha=0.6;this.vBar.alpha=0.6;this.labelGetter=c||function(b){return isString(b)?b:b.toSource?b.toSource():b.toString()};this.buildListContents()}__extends(a,c);a.prototype.elements=null;a.prototype.labelGetter=null;a.prototype.format=null;a.prototype.listContents=null;a.prototype.selected=null;a.prototype.action=
null;a.prototype.buildListContents=function(){var b=this;this.listContents&&this.listContents.destroy();this.listContents=new MenuMorph(this.select,null,this);this.elements.length||(this.elements=["(empty)"]);this.elements.forEach(function(a){var c;c=null;b.format.forEach(function(b){if(b[1].call(null,a))return c=b[0]});return b.listContents.addItem(b.labelGetter(a),a,null,c)});this.listContents.setPosition(this.contents.position());this.listContents.isListContents=!0;this.listContents.drawNew();
return this.addContents(this.listContents)};a.prototype.select=function(b){this.selected=b;if(this.action)return this.action.call(null,b)};a.prototype.setExtent=function(b){var c,d;c=this.listContents.bounds;d=this.bounds.origin.copy().corner(this.bounds.origin.add(b));d.right()>c.right()&&d.width()<=c.width()&&this.listContents.setRight(d.right());d.bottom()>c.bottom()&&d.height()<=c.height()&&this.listContents.setBottom(d.bottom());return a.__super__.setExtent.call(this,b)};return a}(ScrollFrameMorph);
StringFieldMorph=function(c){function a(b,c,d,e,g,f,i){this.defaultContents=null!=b?b:"";this.minWidth=null!=c?c:100;this.fontSize=null!=d?d:12;this.fontStyle=null!=e?e:"sans-serif";this.isBold=null!=g?g:!1;this.isItalic=null!=f?f:!1;this.isNumeric=null!=i?i:!1;a.__super__.constructor.call(this);this.color=new Color(255,255,255);this.drawNew()}__extends(a,c);a.prototype.defaultContents=null;a.prototype.minWidth=null;a.prototype.fontSize=null;a.prototype.fontStyle=null;a.prototype.isBold=null;a.prototype.isItalic=
null;a.prototype.isNumeric=null;a.prototype.text=null;a.prototype.isEditable=!0;a.prototype.drawNew=function(){var b;b=this.text?this.string():this.defaultContents;this.text=null;this.children.forEach(function(b){return b.destroy()});this.children=[];this.text=new StringMorph(b,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric);this.text.isNumeric=this.isNumeric;this.text.setPosition(this.bounds.origin.copy());this.text.isEditable=this.isEditable;this.text.isDraggable=!1;this.text.enableSelecting();
this.silentSetExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height()));a.__super__.drawNew.call(this);return this.add(this.text)};a.prototype.string=function(){return this.text.text};a.prototype.mouseClickLeft=function(b){return this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",b)};a.prototype.copyRecordingReferences=function(b){var c;c=a.__super__.copyRecordingReferences.call(this,b);c.text&&b[this.text]&&(c.text=b[this.text]);return c};return a}(FrameMorph);
morphicVersion="2012-October-22";
MorphsListMorph=function(c){function a(){a.__super__.constructor.call(this);this.silentSetExtent(new Point(10*WorldMorph.MorphicPreferences.handleSize,40*WorldMorph.MorphicPreferences.handleSize/3));this.isDraggable=!0;this.border=1;this.edge=5;this.color=new Color(60,60,60);this.borderColor=new Color(95,95,95);this.drawNew();this.buildPanes()}__extends(a,c);a.prototype.morphsList=null;a.prototype.buttonClose=null;a.prototype.resizer=null;a.prototype.setTarget=function(b){this.target=b;this.currentProperty=
null;return this.buildPanes()};a.prototype.buildPanes=function(){var b,a,c=this;this.children.forEach(function(b){if(b!==this.work)return b.destroy()});this.children=[];this.label=new TextMorph("Morphs List");this.label.fontSize=WorldMorph.MorphicPreferences.menuFontSize;this.label.isBold=!0;this.label.color=new Color(255,255,255);this.label.drawNew();this.add(this.label);b=[];for(a in window)-1!==a.indexOf("Morph",a.length-5)&&b.push(a);this.morphsList=new ListMorph(b,null);this.morphsList.hBar.alpha=
0.6;this.morphsList.vBar.alpha=0.6;this.add(this.morphsList);this.buttonClose=new TriggerMorph;this.buttonClose.labelString="close";this.buttonClose.action=function(){return c.destroy()};this.add(this.buttonClose);this.resizer=new HandleMorph(this,150,100,this.edge,this.edge);return this.fixLayout()};a.prototype.fixLayout=function(){var b,a,c,e;Morph.prototype.trackChanges=!1;c=this.left()+this.edge;e=this.top()+this.edge;a=this.right()-this.edge-c;this.label.setPosition(new Point(c,e));this.label.setWidth(a);
this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew());e=this.label.bottom()+2;a=this.width()-this.edge;a-=this.edge;b=this.bottom()-2*this.edge-WorldMorph.MorphicPreferences.handleSize-e;this.morphsList.setPosition(new Point(c,e));this.morphsList.setExtent(new Point(a,b));c=this.morphsList.left();e=this.morphsList.bottom()+this.edge;b=WorldMorph.MorphicPreferences.handleSize;a=this.morphsList.width()-b-this.edge;this.buttonClose.setPosition(new Point(c,
e));this.buttonClose.setExtent(new Point(a,b));Morph.prototype.trackChanges=!0;return this.changed()};a.prototype.setExtent=function(b){a.__super__.setExtent.call(this,b);return this.fixLayout()};return a}(BoxMorph);
Point2=function(){function c(a,b){this.x=null!=a?a:0;this.y=null!=b?b:0}c.prototype.x=null;c.prototype.y=null;c.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())};c.prototype.copy=function(){return new c(this.x,this.y)};c.prototype.eq=function(a){return this.x===a.x&&this.y===a.y};c.prototype.lt=function(a){return this.x<a.x&&this.y<a.y};c.prototype.gt=function(a){return this.x>a.x&&this.y>a.y};c.prototype.ge=function(a){return this.x>=a.x&&this.y>=
a.y};c.prototype.le=function(a){return this.x<=a.x&&this.y<=a.y};c.prototype.max=function(a){this.x=Math.max(this.x,a.x);return this.y=Math.max(this.y,a.y)};c.prototype.min=function(a){this.x=Math.min(this.x,a.x);return this.y=Math.min(this.y,a.y)};c.prototype.round=function(){this.x=Math.round(this.x);return this.y=Math.round(this.y)};c.prototype.abs=function(){this.x=Math.abs(this.x);return this.y=Math.abs(this.y)};c.prototype.neg=function(){this.x=-this.x;return this.y=-this.y};c.prototype.mirror=
function(){var a;a=this.x;this.x=this.y;return this.y=a};c.prototype.floor=function(){this.x=Math.max(Math.floor(this.x),0);return this.y=Math.max(Math.floor(this.y),0)};c.prototype.ceil=function(){this.x=Math.ceil(this.x);return this.y=Math.ceil(this.y)};c.prototype.add=function(a){if(a instanceof c)this.x+=a.x,this.y+=a.y;else return this.x+=a,this.y+=a};c.prototype.subtract=function(a){if(a instanceof c)this.x-=a.x,this.y-=a.y;else return this.x-=a,this.y-=a};c.prototype.multiplyBy=function(a){if(a instanceof
c)this.x*=a.x,this.y*=a.y;else return this.x*=a,this.y*=a};c.prototype.divideBy=function(a){if(a instanceof c)this.x/=a.x,this.y/=a.y;else return this.x/=a,this.y/=a};c.prototype.floorDivideBy=function(a){if(a instanceof c)this.x=Math.floor(this.x/a.x),this.y=Math.floor(this.y/a.y);else return this.x=Math.floor(this.x/a),this.y=Math.floor(this.y/a)};c.prototype.r=function(){var a;a=this.copy();a.multiplyBy(a);return Math.sqrt(a.x+a.y)};c.prototype.degrees=function(){var a;if(0===this.x)return 0<=
this.y?90:270;a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?degrees(a):360+degrees(a):180+degrees(a)};c.prototype.theta=function(){var a;if(0===this.x)return 0<=this.y?radians(90):radians(270);a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?a:radians(360)+a:radians(180)+a};c.prototype.crossProduct=function(a){return this.multiplyBy(a.copy().mirror())};c.prototype.distanceTo=function(a){return a.copy().subtract(this).r()};c.prototype.rotate=function(a,b){var c;c=this.copy().subtract(b);
if("right"===a)this.x=-c.y+b.x,this.y=c.y+b.y;else if("left"===a)this.x=c.y+b.x,this.y=-c.y+b.y;else return c=b.copy().subtract(c),this.x=c.x,this.y=c.y};c.prototype.flip=function(a,b){if("vertical"===a)this.y=2*b.y-this.y;else return this.x=2*b.x-this.x};c.prototype.distanceAngle=function(a,b){var c,d;c=b;270<c?c-=360:-270>c&&(c+=360);if(-90<=c&&90>=c)c=Math.sin(radians(c))*a,d=Math.sqrt(a*a-c*c),this.x=c+this.x,this.y-=d;else return c=Math.sin(radians(180-c))*a,d=Math.sqrt(a*a-c*c),this.x=c+this.x,
this.y+=d};c.prototype.scaleBy=function(a){return this.multiplyBy(a)};c.prototype.translateBy=function(a){return this.add(a)};c.prototype.rotateBy=function(a,b){var h,d,e;h=b||new c(0,0);d=this.copy().subtract(h);e=d.r();d=a-d.theta();this.x=h.x+e*Math.cos(d);return this.y=h.y-e*Math.sin(d)};c.prototype.asArray=function(){return[this.x,this.y]};c.prototype.corner=function(a){return new Rectangle(this.x,this.y,a.x,a.y)};c.prototype.rectangle=function(a){var b;b=this.copy().min(a);a=this.copy().max(a);
return new Rectangle(b.x,b.y,a.x,a.y)};c.prototype.extent=function(a){a=this.copy().add(a);return new Rectangle(this.x,this.y,a.x,a.y)};return c}();
StringMorph=function(c){function a(b,c,d,e,g,f,i,j,k,l){this.fontSize=null!=c?c:12;this.fontStyle=null!=d?d:"sans-serif";this.isBold=null!=e?e:!1;this.isItalic=null!=g?g:!1;this.isNumeric=null!=f?f:!1;this.shadowColor=j;this.text=b||(""===b?"":"StringMorph");this.fontName=l||WorldMorph.MorphicPreferences.globalFontFamily;this.shadowOffset=i||new Point(0,0);a.__super__.constructor.call(this);this.color=k||new Color(0,0,0);this.noticesTransparentClick=!0;this.drawNew()}__extends(a,c);a.prototype.text=
null;a.prototype.fontSize=null;a.prototype.fontName=null;a.prototype.fontStyle=null;a.prototype.isBold=null;a.prototype.isItalic=null;a.prototype.isEditable=!1;a.prototype.isNumeric=null;a.prototype.isPassword=!1;a.prototype.shadowOffset=null;a.prototype.shadowColor=null;a.prototype.isShowingBlanks=!1;a.prototype.blanksColor=new Color(180,140,140);a.prototype.isScrollable=!0;a.prototype.currentlySelecting=!1;a.prototype.startMark=0;a.prototype.endMark=0;a.prototype.markedTextColor=new Color(255,255,
255);a.prototype.markedBackgoundColor=new Color(60,60,120);a.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'};a.prototype.password=function(b,a){var c,e;c="";for(e=0;0<=a?e<a:e>a;0<=a?++e:--e)c+=b;return c};a.prototype.font=function(){var b;b="";this.isBold&&(b+="bold ");this.isItalic&&(b+="italic ");return b+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle};a.prototype.drawNew=
function(){var b,a,c,e,g,f,i,j,k;f=this.isPassword?this.password("*",this.text.length):this.text;this.image=newCanvas();a=this.image.getContext("2d");a.font=this.font();c=Math.max(a.measureText(f).width+Math.abs(this.shadowOffset.x),1);this.bounds.corner=this.bounds.origin.add(new Point(c,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y)));this.image.width=c;this.image.height=this.height();a.font=this.font();a.textAlign="left";a.textBaseline="bottom";this.shadowColor&&(i=Math.max(this.shadowOffset.x,
0),j=Math.max(this.shadowOffset.y,0),a.fillStyle=this.shadowColor.toString(),a.fillText(f,i,fontHeight(this.fontSize)+j));i=Math.abs(Math.min(this.shadowOffset.x,0));j=Math.abs(Math.min(this.shadowOffset.y,0));a.fillStyle=this.color.toString();this.isShowingBlanks?this.renderWithBlanks(a,i,fontHeight(this.fontSize)+j):a.fillText(f,i,fontHeight(this.fontSize)+j);e=Math.min(this.startMark,this.endMark);g=Math.max(this.startMark,this.endMark);for(b=k=e;e<=g?k<g:k>g;b=e<=g?++k:--k)c=this.slotPosition(b).subtract(this.position()),
b=f.charAt(b),a.fillStyle=this.markedBackgoundColor.toString(),a.fillRect(c.x,c.y,a.measureText(b).width+1+i,fontHeight(this.fontSize)+j),a.fillStyle=this.markedTextColor.toString(),a.fillText(b,c.x+i,fontHeight(this.fontSize)+j);if(this.parent&&this.parent.fixLayout)return this.parent.fixLayout()};a.prototype.renderWithBlanks=function(b,a,c){var e,g,f,i,j,k,l;f=function(){b.drawImage(e,Math.round(l),0);return l+=j};j=b.measureText(" ").width;e=newCanvas(new Point(j,this.height()));g=e.getContext("2d");
k=this.text.split(" ");l=a||0;i=!0;g.fillStyle=this.blanksColor.toString();g.arc(j/2,e.height/2,j/2,radians(0),radians(360));g.fill();return k.forEach(function(a){i||f();i=!1;if(""!==a)return b.fillText(a,l,c),l+=b.measureText(a).width})};a.prototype.slotPosition=function(b){var a,c,e,g,f;e=this.isPassword?this.password("*",this.text.length):this.text;a=Math.min(Math.max(b,0),e.length);b=this.image.getContext("2d");for(c=f=g=0;0<=a?f<a:f>a;c=0<=a?++f:--f)g+=b.measureText(e[c]).width;this.pos=a;e=
this.left()+g;b=this.top();return new Point(e,b)};a.prototype.slotAt=function(a){var c,d,e,g;g=this.isPassword?this.password("*",this.text.length):this.text;c=e=0;for(d=this.image.getContext("2d");a.x-this.left()>c;)if(c+=d.measureText(g[e]).width,e+=1,e===g.length&&d.measureText(g).width-d.measureText(g[e-1]).width/2<a.x-this.left())return e;return e-1};a.prototype.upFrom=function(a){return a};a.prototype.downFrom=function(a){return a};a.prototype.startOfLine=function(){return 0};a.prototype.endOfLine=
function(){return this.text.length};a.prototype.rawHeight=function(){return this.height()/1.2};a.prototype.developersMenu=function(){var b;b=a.__super__.developersMenu.call(this);b.addLine();b.addItem("edit","edit");b.addItem("font size...",function(){return this.prompt(b.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size");"serif"!==this.fontStyle&&b.addItem("serif","setSerif");"sans-serif"!==this.fontStyle&&b.addItem("sans-serif",
"setSansSerif");this.isBold?b.addItem("normal weight","toggleWeight"):b.addItem("bold","toggleWeight");this.isItalic?b.addItem("normal style","toggleItalic"):b.addItem("italic","toggleItalic");this.isShowingBlanks?b.addItem("hide blanks","toggleShowBlanks"):b.addItem("show blanks","toggleShowBlanks");this.isPassword?b.addItem("show characters","toggleIsPassword"):b.addItem("hide characters","toggleIsPassword");return b};a.prototype.toggleIsDraggable=function(){return(this.isDraggable=!this.isDraggable)?
this.disableSelecting():this.enableSelecting()};a.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks;this.changed();this.drawNew();return this.changed()};a.prototype.toggleWeight=function(){this.isBold=!this.isBold;this.changed();this.drawNew();return this.changed()};a.prototype.toggleItalic=function(){this.isItalic=!this.isItalic;this.changed();this.drawNew();return this.changed()};a.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword;this.changed();
this.drawNew();return this.changed()};a.prototype.setSerif=function(){this.fontStyle="serif";this.changed();this.drawNew();return this.changed()};a.prototype.setSansSerif=function(){this.fontStyle="sans-serif";this.changed();this.drawNew();return this.changed()};a.prototype.setFontSize=function(a){"number"===typeof a?this.fontSize=Math.round(Math.min(Math.max(a,4),500)):(a=parseFloat(a),isNaN(a)||(this.fontSize=Math.round(Math.min(Math.max(a,4),500))));this.changed();this.drawNew();return this.changed()};
a.prototype.setText=function(a){this.text=Math.round(a).toString();this.changed();this.drawNew();return this.changed()};a.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]};a.prototype.edit=function(){return this.root().edit(this)};a.prototype.selection=function(){var a,c;a=Math.min(this.startMark,this.endMark);c=Math.max(this.startMark,this.endMark);return this.text.slice(a,c)};a.prototype.selectionStartSlot=function(){return Math.min(this.startMark,
this.endMark)};a.prototype.clearSelection=function(){this.currentlySelecting=!1;this.endMark=this.startMark=0;this.drawNew();return this.changed()};a.prototype.deleteSelection=function(){var a,c,d;d=this.text;a=Math.min(this.startMark,this.endMark);c=Math.max(this.startMark,this.endMark);this.text=d.slice(0,a)+d.slice(c);this.changed();return this.clearSelection()};a.prototype.selectAll=function(){this.startMark=0;this.endMark=this.text.length;this.drawNew();return this.changed()};a.prototype.mouseDownLeft=
function(a){return this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",a)};a.prototype.mouseClickLeft=function(a){var c;c=this.root().caret;return this.isEditable?(this.currentlySelecting||this.edit(),c&&c.gotoPos(a),this.root().caret.gotoPos(a),this.currentlySelecting=!0):this.escalateEvent("mouseClickLeft",a)};a.prototype.enableSelecting=function(){this.mouseDownLeft=function(a){this.clearSelection();if(this.isEditable&&!this.isDraggable)return this.edit(),this.root().caret.gotoPos(a),
this.endMark=this.startMark=this.slotAt(a),this.currentlySelecting=!0};return this.mouseMove=function(a){if(this.isEditable&&this.currentlySelecting&&!this.isDraggable&&(a=this.slotAt(a),a!==this.endMark))return this.endMark=a,this.drawNew(),this.changed()}};a.prototype.disableSelecting=function(){this.mouseDownLeft=a.prototype.mouseDownLeft;return delete this.mouseMove};return a}(Morph);
TriggerMorph=function(c){function a(b,c,d,e,g,f,i,j){this.target=null!=b?b:null;this.action=null!=c?c:null;this.labelString=null!=d?d:null;this.environment=null!=f?f:null;this.hint=null!=i?i:null;this.fontSize=e||WorldMorph.MorphicPreferences.menuFontSize;this.fontStyle=g||"sans-serif";this.labelColor=j||new Color(0,0,0);a.__super__.constructor.call(this);this.color=new Color(255,255,255);this.drawNew()}__extends(a,c);a.prototype.target=null;a.prototype.action=null;a.prototype.environment=null;a.prototype.labelString=
null;a.prototype.label=null;a.prototype.hint=null;a.prototype.fontSize=null;a.prototype.fontStyle=null;a.prototype.highlightColor=new Color(192,192,192);a.prototype.pressColor=new Color(128,128,128);a.prototype.labelColor=null;a.prototype.drawNew=function(){this.createBackgrounds();if(null!==this.labelString)return this.createLabel()};a.prototype.createBackgrounds=function(){var a,c;c=this.extent();this.normalImage=newCanvas(c);a=this.normalImage.getContext("2d");a.fillStyle=this.color.toString();
a.fillRect(0,0,c.x,c.y);this.highlightImage=newCanvas(c);a=this.highlightImage.getContext("2d");a.fillStyle=this.highlightColor.toString();a.fillRect(0,0,c.x,c.y);this.pressImage=newCanvas(c);a=this.pressImage.getContext("2d");a.fillStyle=this.pressColor.toString();a.fillRect(0,0,c.x,c.y);return this.image=this.normalImage};a.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,!1,!1,!1,null,null,this.labelColor);
this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2)));return this.add(this.label)};a.prototype.copyRecordingReferences=function(b){var c;c=a.__super__.copyRecordingReferences.call(this,b);c.label&&b[this.label]&&(c.label=b[this.label]);return c};a.prototype.trigger=function(){return"function"===typeof this.target?"function"===typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"===typeof this.action?
this.action.call(this.target):this.target[this.action]()};a.prototype.mouseEnter=function(){this.image=this.highlightImage;this.changed();if(this.hint)return this.bubbleHelp(this.hint)};a.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed();if(this.hint)return this.world().hand.destroyTemporaries()};a.prototype.mouseDownLeft=function(){this.image=this.pressImage;return this.changed()};a.prototype.mouseClickLeft=function(){this.image=this.highlightImage;this.changed();return this.trigger()};
a.prototype.bubbleHelp=function(a){var c=this;this.fps=2;return this.step=function(){c.bounds.containsPoint(c.world().hand.position())&&c.popUpbubbleHelp(a);c.fps=0;return delete c.step}};a.prototype.popUpbubbleHelp=function(a){return(new SpeechBubbleMorph(localize(a),null,null,1)).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};return a}(Morph);
MouseSensorMorph=function(c){function a(b,c,d){a.__super__.constructor.apply(this,arguments);this.edge=b||4;this.border=c||2;this.color=new Color(255,255,255);this.borderColor=d||new Color;this.isTouched=!1;this.upStep=0.05;this.downStep=0.02;this.noticesTransparentClick=!1;this.drawNew()}__extends(a,c);a.prototype.touch=function(){var a=this;if(!this.isTouched)return this.isTouched=!0,this.alpha=0.6,this.step=function(){a.isTouched?1>a.alpha&&(a.alpha+=a.upStep):a.alpha>a.downStep?a.alpha-=a.downStep:
(a.alpha=0,a.step=null);return a.changed()}};a.prototype.unTouch=function(){return this.isTouched=!1};a.prototype.mouseEnter=function(){return this.touch()};a.prototype.mouseLeave=function(){return this.unTouch()};a.prototype.mouseDownLeft=function(){return this.touch()};a.prototype.mouseClickLeft=function(){return this.unTouch()};return a}(BoxMorph);
TextMorph=function(c){function a(b,c,d,e,g,f,i,j,k,l){this.fontSize=null!=c?c:12;this.fontStyle=null!=d?d:"sans-serif";this.isBold=null!=e?e:!1;this.isItalic=null!=g?g:!1;this.alignment=null!=f?f:"left";this.maxWidth=null!=i?i:0;this.shadowColor=null!=l?l:null;a.__super__.constructor.call(this);this.markedTextColor=new Color(255,255,255);this.markedBackgoundColor=new Color(60,60,120);this.text=b||(""===b?b:"TextMorph");this.fontName=j||WorldMorph.MorphicPreferences.globalFontFamily;this.shadowOffset=
k||new Point(0,0);this.color=new Color(0,0,0);this.noticesTransparentClick=!0;this.drawNew()}__extends(a,c);a.prototype.words=[];a.prototype.lines=[];a.prototype.lineSlots=[];a.prototype.alignment=null;a.prototype.maxWidth=null;a.prototype.maxLineWidth=0;a.prototype.backgroundColor=null;a.prototype.receiver=null;a.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'};a.prototype.parse=function(){var a,c,d,e,g=this;d=this.text.split("\n");a=newCanvas().getContext("2d");
c="";e=0;a.font=this.font();this.maxLineWidth=0;this.lines=[];this.lineSlots=[0];this.words=[];d.forEach(function(a){g.words=g.words.concat(a.split(" "));return g.words.push("\n")});return this.words.forEach(function(d){var i,j;if("\n"===d)return g.lines.push(c),g.lineSlots.push(e),g.maxLineWidth=Math.max(g.maxLineWidth,a.measureText(c).width),c="";0<g.maxWidth?(i=c+d+" ",j=a.measureText(i).width,j>g.maxWidth?(g.lines.push(c),g.lineSlots.push(e),g.maxLineWidth=Math.max(g.maxLineWidth,a.measureText(c).width),
c=d+" "):c=i):c=c+d+" ";return e+=d.length+1})};a.prototype.drawNew=function(){var a,c,d,e,g,f,i,j,k,l,n,m;this.image=newCanvas();c=this.image.getContext("2d");c.font=this.font();this.parse();i=Math.abs(this.shadowOffset.x);f=Math.abs(this.shadowOffset.y);c=this.lines.length*(fontHeight(this.fontSize)+f);this.bounds=0===this.maxWidth?this.bounds.origin.extent(new Point(this.maxLineWidth+i,c)):this.bounds.origin.extent(new Point(this.maxWidth+i,c));this.image.width=this.width();this.image.height=this.height();
c=this.image.getContext("2d");c.font=this.font();c.textAlign="left";c.textBaseline="bottom";this.backgroundColor&&(c.fillStyle=this.backgroundColor.toString(),c.fillRect(0,0,this.width(),this.height()));if(this.shadowColor){e=Math.max(this.shadowOffset.x,0);g=Math.max(this.shadowOffset.y,0);c.fillStyle=this.shadowColor.toString();a=0;m=this.lines;l=0;for(n=m.length;l<n;l++)d=m[l],j=c.measureText(d).width+i,j="right"===this.alignment?this.width()-j:"center"===this.alignment?(this.width()-j)/2:0,k=
(a+1)*(fontHeight(this.fontSize)+f)-f,a++,c.fillText(d,j+e,k+g)}e=Math.abs(Math.min(this.shadowOffset.x,0));g=Math.abs(Math.min(this.shadowOffset.y,0));c.fillStyle=this.color.toString();a=0;m=this.lines;l=0;for(n=m.length;l<n;l++)d=m[l],j=c.measureText(d).width+i,j="right"===this.alignment?this.width()-j:"center"===this.alignment?(this.width()-j)/2:0,k=(a+1)*(fontHeight(this.fontSize)+f)-f,a++,c.fillText(d,j+e,k+g);i=Math.min(this.startMark,this.endMark);d=Math.max(this.startMark,this.endMark);for(a=
e=i;i<=d?e<d:e>d;a=i<=d?++e:--e)f=this.slotPosition(a).subtract(this.position()),a=this.text.charAt(a),c.fillStyle=this.markedBackgoundColor.toString(),c.fillRect(f.x,f.y,c.measureText(a).width+1,fontHeight(this.fontSize)),c.fillStyle=this.markedTextColor.toString(),c.fillText(a,f.x,f.y+fontHeight(this.fontSize));if(this.parent&&this.parent.layoutChanged)return this.parent.layoutChanged()};a.prototype.setExtent=function(a){this.maxWidth=Math.max(a.x,0);this.changed();return this.drawNew()};a.prototype.columnRow=
function(a){var c,d,e,g,f,i,j;e=g=0;for(i=this.lines.length;0<=i?g<i:g>i;e=0<=i?++g:--g){d=this.lineSlots[e];c=f=0;for(j=this.lines[e].length;0<=j?f<j:f>j;c=0<=j?++f:--f){if(d===a)return new Point(c,e);d+=1}}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)};a.prototype.slotPosition=function(a){var c,d,e,g,f,i,a=this.columnRow(a);c=this.image.getContext("2d");e=Math.abs(this.shadowOffset.y);g=0;e=a.y*(fontHeight(this.fontSize)+e);d=f=0;for(i=a.x;0<=i?f<i:f>i;d=0<=i?++f:
--f)g+=c.measureText(this.lines[a.y][d]).width;a=this.left()+g;c=this.top()+e;return new Point(a,c)};a.prototype.slotAt=function(a){var c,d,e,g,f;d=g=c=0;f=Math.abs(this.shadowOffset.y);for(e=this.image.getContext("2d");a.y-this.top()>(fontHeight(this.fontSize)+f)*g;)g+=1;for(g=Math.max(g,1);a.x-this.left()>c;)c+=e.measureText(this.lines[g-1][d]).width,d+=1;return this.lineSlots[Math.max(g-1,0)]+d-1};a.prototype.upFrom=function(a){var c;c=this.columnRow(a);if(1>c.y)return a;a=this.lines[c.y-1];return a.length<
c.x-1?this.lineSlots[c.y-1]+a.length:this.lineSlots[c.y-1]+c.x};a.prototype.downFrom=function(a){var c;c=this.columnRow(a);if(c.y>this.lines.length-2)return a;a=this.lines[c.y+1];return a.length<c.x-1?this.lineSlots[c.y+1]+a.length:this.lineSlots[c.y+1]+c.x};a.prototype.startOfLine=function(a){return this.lineSlots[this.columnRow(a).y]};a.prototype.endOfLine=function(a){return this.startOfLine(a)+this.lines[this.columnRow(a).y].length-1};a.prototype.developersMenu=function(){var b;b=a.__super__.developersMenu.call(this);
b.addLine();b.addItem("edit","edit");b.addItem("font size...",function(){return this.prompt(b.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size");"left"!==this.alignment&&b.addItem("align left","setAlignmentToLeft");"right"!==this.alignment&&b.addItem("align right","setAlignmentToRight");"center"!==this.alignment&&b.addItem("align center","setAlignmentToCenter");b.addLine();"serif"!==this.fontStyle&&b.addItem("serif","setSerif");
"sans-serif"!==this.fontStyle&&b.addItem("sans-serif","setSansSerif");this.isBold?b.addItem("normal weight","toggleWeight"):b.addItem("bold","toggleWeight");this.isItalic?b.addItem("normal style","toggleItalic"):b.addItem("italic","toggleItalic");return b};a.prototype.setAlignmentToLeft=function(){this.alignment="left";this.drawNew();return this.changed()};a.prototype.setAlignmentToRight=function(){this.alignment="right";this.drawNew();return this.changed()};a.prototype.setAlignmentToCenter=function(){this.alignment=
"center";this.drawNew();return this.changed()};a.prototype.evaluationMenu=function(){var a;a=new MenuMorph(this,null);a.addItem("do it","doIt","evaluate the\nselected expression");a.addItem("show it","showIt","evaluate the\nselected expression\nand show the result");a.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result");a.addLine();a.addItem("select all","selectAllAndEdit");return a};a.prototype.selectAllAndEdit=function(){this.edit();return this.selectAll()};
a.prototype.setReceiver=function(a){this.receiver=a;return this.customContextMenu=this.evaluationMenu()};a.prototype.doIt=function(){this.receiver.evaluateString(this.selection());return this.edit()};a.prototype.showIt=function(){var a;a=this.receiver.evaluateString(this.selection());if(null!=a)return this.inform(a)};a.prototype.inspectIt=function(){var a,c;a=this.receiver.evaluateString(this.selection());c=this.world();if(null!=a)return a=new InspectorMorph(a),a.setPosition(c.hand.position()),a.keepWithin(c),
c.add(a),a.changed()};return a}(StringMorph);
InspectorMorph=function(c){function a(b){this.target=b;a.__super__.constructor.call(this);this.silentSetExtent(new Point(20*WorldMorph.MorphicPreferences.handleSize,40*WorldMorph.MorphicPreferences.handleSize/3));this.isDraggable=!0;this.border=1;this.edge=5;this.color=new Color(60,60,60);this.borderColor=new Color(95,95,95);this.drawNew();this.target&&this.buildPanes()}__extends(a,c);a.prototype.target=null;a.prototype.currentProperty=null;a.prototype.showing="attributes";a.prototype.markOwnershipOfProperties=
!1;a.prototype.label=null;a.prototype.list=null;a.prototype.detail=null;a.prototype.work=null;a.prototype.buttonInspect=null;a.prototype.buttonClose=null;a.prototype.buttonSubset=null;a.prototype.buttonEdit=null;a.prototype.resizer=null;a.prototype.setTarget=function(a){this.target=a;this.currentProperty=null;return this.buildPanes()};a.prototype.buildPanes=function(){var b,c,d,e,g,f=this;b=[];this.children.forEach(function(a){if(a!==this.work)return a.destroy()});this.children=[];this.label=new TextMorph(this.target.toString());
this.label.fontSize=WorldMorph.MorphicPreferences.menuFontSize;this.label.isBold=!0;this.label.color=new Color(255,255,255);this.label.drawNew();this.add(this.label);for(c in this.target)c&&b.push(c);"attributes"===this.showing?b=b.filter(function(a){return!isFunction(f.target[a])}):"methods"===this.showing&&(b=b.filter(function(a){return isFunction(f.target[a])}));e=Object.getOwnPropertyNames(this.target.constructor);e=e.filter(function(a){return"name"!==a&&"length"!==a&&"prototype"!==a&&"caller"!==
a&&"__super__"!==a&&"arguments"!==a});"attributes"===this.showing?(d=[],c=e.filter(function(a){return!isFunction(f.target.constructor[a])})):"methods"===this.showing?(d=e.filter(function(a){return isFunction(f.target.constructor[a])}),c=[]):(d=e.filter(function(a){return isFunction(f.target.constructor[a])}),c=e.filter(function(a){return 0>__indexOf.call(d,a)}));b=b.concat(d).concat(c);this.markOwnershipOfProperties&&(g=Object.getOwnPropertyNames(this.target.constructor.prototype));this.list=new ListMorph(this.target instanceof
Array?b:b.sort(),null,this.markOwnershipOfProperties?[[new Color(0,0,180),function(){return true}],[new Color(255,165,0),function(a){return __indexOf.call(e,a)>=0}],[new Color(0,180,0),function(a){return f.target.hasOwnProperty(a)}],[new Color(180,0,0),function(a){return __indexOf.call(g,a)>=0}]]:null);this.list.action=function(a){var b;b=f.target[a];b===void 0&&(b=f.target.constructor[a]);f.currentProperty=b;a=b===null?"NULL":isString(b)?b:b.toString();a=new TextMorph(a);a.isEditable=true;a.enableSelecting();
a.setReceiver(f.target);return f.detail.setContents(a)};this.list.hBar.alpha=0.6;this.list.vBar.alpha=0.6;this.list.listContents.step=null;this.add(this.list);this.detail=new ScrollFrameMorph;this.detail.acceptsDrops=!1;this.detail.contents.acceptsDrops=!1;this.detail.isTextLineWrapping=!0;this.detail.color=new Color(255,255,255);this.detail.hBar.alpha=0.6;this.detail.vBar.alpha=0.6;b=new TextMorph("");b.isEditable=!0;b.enableSelecting();b.setReceiver(this.target);this.detail.setContents(b);this.add(this.detail);
null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=new Color(255,255,255),this.work.hBar.alpha=0.6,this.work.vBar.alpha=0.6,b=new TextMorph(""),b.isEditable=!0,b.enableSelecting(),b.setReceiver(this.target),this.work.setContents(b));this.add(this.work);this.buttonSubset=new TriggerMorph;this.buttonSubset.labelString="show...";this.buttonSubset.action=function(){var a;a=new MenuMorph;a.addItem("attributes",
function(){f.showing="attributes";return f.buildPanes()});a.addItem("methods",function(){f.showing="methods";return f.buildPanes()});a.addItem("all",function(){f.showing="all";return f.buildPanes()});a.addLine();a.addItem(f.markOwnershipOfProperties?"un-mark ownership":"mark ownership",function(){f.markOwnershipOfProperties=!f.markOwnershipOfProperties;return f.buildPanes()},"highlight\nownership of properties");return a.popUpAtHand(f.world())};this.add(this.buttonSubset);this.buttonInspect=new TriggerMorph;
this.buttonInspect.labelString="inspect...";this.buttonInspect.action=function(){var b;if(isObject(f.currentProperty)){b=new MenuMorph;b.addItem("in new inspector...",function(){var b,c;c=f.world();b=new a(f.currentProperty);b.setPosition(c.hand.position());b.keepWithin(c);c.add(b);return b.changed()});b.addItem("here...",function(){return f.setTarget(f.currentProperty)});return b.popUpAtHand(f.world())}return f.inform((f.currentProperty===null?"null":typeof f.currentProperty)+"\nis not inspectable")};
this.add(this.buttonInspect);this.buttonEdit=new TriggerMorph;this.buttonEdit.labelString="edit...";this.buttonEdit.action=function(){var a;a=new MenuMorph(f);a.addItem("save","save","accept changes");a.addLine();a.addItem("add property...","addProperty");a.addItem("rename...","renameProperty");a.addItem("remove...","removeProperty");return a.popUpAtHand(f.world())};this.add(this.buttonEdit);this.buttonClose=new TriggerMorph;this.buttonClose.labelString="close";this.buttonClose.action=function(){return f.destroy()};
this.add(this.buttonClose);this.resizer=new HandleMorph(this,150,100,this.edge,this.edge);return this.fixLayout()};a.prototype.fixLayout=function(){var a,c,d,e;Morph.prototype.trackChanges=!1;d=this.left()+this.edge;e=this.top()+this.edge;c=this.right()-this.edge;c-=d;this.label.setPosition(new Point(d,e));this.label.setWidth(c);this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew());e=this.label.bottom()+2;c=Math.min(Math.floor(this.width()/
3),this.list.listContents.width());c-=this.edge;a=this.bottom()-2*this.edge-WorldMorph.MorphicPreferences.handleSize-e;this.list.setPosition(new Point(d,e));this.list.setExtent(new Point(c,a));d=this.list.right()+this.edge;c=this.right()-this.edge;c-=d;this.detail.setPosition(new Point(d,e));this.detail.setExtent(new Point(c,2*a/3-this.edge));e=this.detail.bottom()+this.edge;this.work.setPosition(new Point(d,e));this.work.setExtent(new Point(c,a/3));d=this.list.left();e=this.list.bottom()+this.edge;
c=this.list.width();a=WorldMorph.MorphicPreferences.handleSize;this.buttonSubset.setPosition(new Point(d,e));this.buttonSubset.setExtent(new Point(c,a));d=this.detail.left();c=this.detail.width()-this.edge-WorldMorph.MorphicPreferences.handleSize;c=c/3-this.edge/3;this.buttonInspect.setPosition(new Point(d,e));this.buttonInspect.setExtent(new Point(c,a));d=this.buttonInspect.right()+this.edge;this.buttonEdit.setPosition(new Point(d,e));this.buttonEdit.setExtent(new Point(c,a));d=this.buttonEdit.right()+
this.edge;c=this.detail.right()-this.edge-WorldMorph.MorphicPreferences.handleSize;c-=d;this.buttonClose.setPosition(new Point(d,e));this.buttonClose.setExtent(new Point(c,a));Morph.prototype.trackChanges=!0;return this.changed()};a.prototype.setExtent=function(b){a.__super__.setExtent.call(this,b);return this.fixLayout()};a.prototype.save=function(){var a,c;c=this.detail.contents.children[0].text.toString();a=this.list.selected;try{if(this.target.evaluateString("this."+a+" = "+c),this.target.drawNew)return this.target.changed(),
this.target.drawNew(),this.target.changed()}catch(d){return this.inform(d)}};a.prototype.addProperty=function(){var a=this;return this.prompt("new property name:",function(c){if(c&&(a.target[c]=null,a.buildPanes(),a.target.drawNew))return a.target.changed(),a.target.drawNew(),a.target.changed()},this,"property")};a.prototype.renameProperty=function(){var a,c=this;a=this.list.selected;return this.prompt("property name:",function(d){try{delete c.target[a],c.target[d]=c.currentProperty}catch(e){c.inform(e)}c.buildPanes();
if(c.target.drawNew)return c.target.changed(),c.target.drawNew(),c.target.changed()},this,a)};a.prototype.removeProperty=function(){var a;a=this.list.selected;try{if(delete this.target[a],this.currentProperty=null,this.buildPanes(),this.target.drawNew)return this.target.changed(),this.target.drawNew(),this.target.changed()}catch(c){return this.inform(c)}};return a}(BoxMorph);
Point=function(){function c(a,b){this.x=null!=a?a:0;this.y=null!=b?b:0}c.prototype.x=null;c.prototype.y=null;c.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())};c.prototype.copy=function(){return new c(this.x,this.y)};c.prototype.eq=function(a){return this.x===a.x&&this.y===a.y};c.prototype.lt=function(a){return this.x<a.x&&this.y<a.y};c.prototype.gt=function(a){return this.x>a.x&&this.y>a.y};c.prototype.ge=function(a){return this.x>=a.x&&this.y>=
a.y};c.prototype.le=function(a){return this.x<=a.x&&this.y<=a.y};c.prototype.max=function(a){return new c(Math.max(this.x,a.x),Math.max(this.y,a.y))};c.prototype.min=function(a){return new c(Math.min(this.x,a.x),Math.min(this.y,a.y))};c.prototype.round=function(){return new c(Math.round(this.x),Math.round(this.y))};c.prototype.abs=function(){return new c(Math.abs(this.x),Math.abs(this.y))};c.prototype.neg=function(){return new c(-this.x,-this.y)};c.prototype.mirror=function(){return new c(this.y,
this.x)};c.prototype.floor=function(){return new c(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))};c.prototype.ceil=function(){return new c(Math.ceil(this.x),Math.ceil(this.y))};c.prototype.add=function(a){return a instanceof c?new c(this.x+a.x,this.y+a.y):new c(this.x+a,this.y+a)};c.prototype.subtract=function(a){return a instanceof c?new c(this.x-a.x,this.y-a.y):new c(this.x-a,this.y-a)};c.prototype.multiplyBy=function(a){return a instanceof c?new c(this.x*a.x,this.y*a.y):new c(this.x*
a,this.y*a)};c.prototype.divideBy=function(a){return a instanceof c?new c(this.x/a.x,this.y/a.y):new c(this.x/a,this.y/a)};c.prototype.floorDivideBy=function(a){return a instanceof c?new c(Math.floor(this.x/a.x),Math.floor(this.y/a.y)):new c(Math.floor(this.x/a),Math.floor(this.y/a))};c.prototype.r=function(){var a;a=this.multiplyBy(this);return Math.sqrt(a.x+a.y)};c.prototype.degrees=function(){var a;if(0===this.x)return 0<=this.y?90:270;a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?degrees(a):
360+degrees(a):180+degrees(a)};c.prototype.theta=function(){var a;if(0===this.x)return 0<=this.y?radians(90):radians(270);a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?a:radians(360)+a:radians(180)+a};c.prototype.crossProduct=function(a){return this.multiplyBy(a.mirror())};c.prototype.distanceTo=function(a){return a.subtract(this).r()};c.prototype.rotate=function(a,b){var h;h=this.subtract(b);return"right"===a?(new c(-h.y,h.y)).add(b):"left"===a?(new c(h.y,-h.y)).add(b):b.subtract(h)};c.prototype.flip=
function(a,b){return"vertical"===a?new c(this.x,2*b.y-this.y):new c(2*b.x-this.x,this.y)};c.prototype.distanceAngle=function(a,b){var h,d;h=b;270<h?h-=360:-270>h&&(h+=360);if(-90<=h&&90>=h)return h=Math.sin(radians(h))*a,d=Math.sqrt(a*a-h*h),new c(h+this.x,this.y-d);h=Math.sin(radians(180-h))*a;d=Math.sqrt(a*a-h*h);return new c(h+this.x,this.y+d)};c.prototype.scaleBy=function(a){return this.multiplyBy(a)};c.prototype.translateBy=function(a){return this.add(a)};c.prototype.rotateBy=function(a,b){var h,
d,e;h=b||new c(0,0);d=this.subtract(h);e=d.r();d=a-d.theta();return new c(h.x+e*Math.cos(d),h.y-e*Math.sin(d))};c.prototype.asArray=function(){return[this.x,this.y]};c.prototype.corner=function(a){return new Rectangle(this.x,this.y,a.x,a.y)};c.prototype.rectangle=function(a){var b;b=this.min(a);a=this.max(a);return new Rectangle(b.x,b.y,a.x,a.y)};c.prototype.extent=function(a){a=this.add(a);return new Rectangle(this.x,this.y,a.x,a.y)};return c}();
Rectangle=function(){function c(a,b,c,d){this.origin=new Point(a||0,b||0);this.corner=new Point(c||0,d||0)}c.prototype.origin=null;c.prototype.corner=null;c.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"};c.prototype.copy=function(){return new c(this.left(),this.top(),this.right(),this.bottom())};c.prototype.setTo=function(a,b,c,d){this.origin=new Point(a||(0===a?0:this.left()),b||(0===b?0:this.top()));return this.corner=new Point(c||(0===c?0:this.right()),
d||(0===d?0:this.bottom()))};c.prototype.area=function(){var a;a=this.width();return 0>a?0:Math.max(a*this.height(),0)};c.prototype.bottom=function(){return this.corner.y};c.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())};c.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)};c.prototype.bottomRight=function(){return this.corner.copy()};c.prototype.boundingBox=function(){return this};c.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))};
c.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]};c.prototype.extent=function(){return this.corner.subtract(this.origin)};c.prototype.isEmpty=function(){var a;a=this.corner.subtract(this.origin);return a.x=a.y=0};c.prototype.isNotEmpty=function(){var a;a=this.corner.subtract(this.origin);return 0<a.x&&0<a.y};c.prototype.height=function(){return this.corner.y-this.origin.y};c.prototype.left=function(){return this.origin.x};c.prototype.leftCenter=function(){return new Point(this.left(),
this.center().y)};c.prototype.right=function(){return this.corner.x};c.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)};c.prototype.top=function(){return this.origin.y};c.prototype.topCenter=function(){return new Point(this.center().x,this.top())};c.prototype.topLeft=function(){return this.origin};c.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)};c.prototype.width=function(){return this.corner.x-this.origin.x};c.prototype.position=function(){return this.origin};
c.prototype.eq=function(a){return this.origin.eq(a.origin)&&this.corner.eq(a.corner)};c.prototype.abs=function(){var a,b;b=this.origin.abs();a=this.corner.max(b);return b.corner(a)};c.prototype.insetBy=function(a){var b;b=new c;b.origin=this.origin.add(a);b.corner=this.corner.subtract(a);return b};c.prototype.expandBy=function(a){var b;b=new c;b.origin=this.origin.subtract(a);b.corner=this.corner.add(a);return b};c.prototype.growBy=function(a){var b;b=new c;b.origin=this.origin.copy();b.corner=this.corner.add(a);
return b};c.prototype.intersect=function(a){var b;b=new c;b.origin=this.origin.max(a.origin);b.corner=this.corner.min(a.corner);return b};c.prototype.merge=function(a){var b;b=new c;b.origin=this.origin.min(a.origin);b.corner=this.corner.max(a.corner);return b};c.prototype.round=function(){return this.origin.round().corner(this.corner.round())};c.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil())};c.prototype.amountToTranslateWithin=function(a){var b,c;this.right()>
a.right()&&(b=a.right()-this.right());this.bottom()>a.bottom()&&(c=a.bottom()-this.bottom());this.left()+b<a.left()&&(b=a.left()-this.right());this.top()+c<a.top()&&(c=a.top()-this.top());return new Point(b,c)};c.prototype.containsPoint=function(a){return this.origin.le(a)&&a.lt(this.corner)};c.prototype.containsRectangle=function(a){return a.origin.gt(this.origin)&&a.corner.lt(this.corner)};c.prototype.intersects=function(a){var b;b=a.origin;a=a.corner;return a.x>=this.origin.x&&a.y>=this.origin.y&&
b.x<=this.corner.x&&b.y<=this.corner.y};c.prototype.scaleBy=function(a){var b;b=this.origin.multiplyBy(a);a=this.corner.multiplyBy(a);return new c(b.x,b.y,a.x,a.y)};c.prototype.translateBy=function(a){var b;b=this.origin.add(a);a=this.corner.add(a);return new c(b.x,b.y,a.x,a.y)};c.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]};c.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]};return c}();
SliderMorph=function(c){function a(b,c,d,e,g,f){this.start=null!=b?b:1;this.stop=null!=c?c:100;this.value=null!=d?d:50;this.size=null!=e?e:10;this.button=new SliderButtonMorph;this.button.isDraggable=!1;this.button.color=new Color(200,200,200);this.button.highlightColor=new Color(210,210,255);this.button.pressColor=new Color(180,180,255);a.__super__.constructor.call(this,g);this.add(this.button);this.alpha=0.3;this.color=f||new Color(0,0,0);this.setExtent(new Point(20,100))}__extends(a,c);a.prototype.target=
null;a.prototype.action=null;a.prototype.start=null;a.prototype.stop=null;a.prototype.value=null;a.prototype.size=null;a.prototype.offset=null;a.prototype.button=null;a.prototype.step=null;a.prototype.autoOrientation=function(){return noOperation};a.prototype.rangeSize=function(){return this.stop-this.start};a.prototype.ratio=function(){return this.size/this.rangeSize()};a.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-
this.button.width())/this.rangeSize()};a.prototype.drawNew=function(){var b,c;a.__super__.drawNew.call(this);this.button.orientation=this.orientation;"vertical"===this.orientation?(c=this.width()-2,b=Math.max(c,Math.round(this.height()*this.ratio())),this.button.silentSetExtent(new Point(c,b)),b=1,c=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())):(b=this.height()-2,c=Math.max(b,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(c,
b)),c=1,b=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width()));this.button.setPosition((new Point(b,c)).add(this.bounds.origin));this.button.drawNew();return this.button.changed()};a.prototype.updateValue=function(){var a;a="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left();this.value=Math.round(a/this.unitSize()+this.start);return this.updateTarget()};a.prototype.updateTarget=function(){if(this.action)return"function"===
typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value)};a.prototype.copyRecordingReferences=function(b){var c;c=a.__super__.copyRecordingReferences.call(this,b);c.target&&b[this.target]&&(c.target=b[this.target]);c.button&&b[this.button]&&(c.button=b[this.button]);return c};a.prototype.developersMenu=function(){var b;b=a.__super__.developersMenu.call(this);b.addItem("show value...","showValue","display a dialog box\nshowing the selected number");b.addItem("floor...",
function(){return this.prompt(b.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected");b.addItem("ceiling...",function(){return this.prompt(b.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,100*this.size,!0)},"set the maximum value\nwhich can be selected");b.addItem("button size...",function(){return this.prompt(b.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,
1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button");b.addLine();b.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one");return b};a.prototype.showValue=function(){return this.inform(this.value)};a.prototype.userSetStart=function(a){return this.start=Math.max(a,this.stop)};a.prototype.setStart=function(a){"number"===typeof a?this.start=Math.min(Math.max(a,0),this.stop-this.size):(a=parseFloat(a),isNaN(a)||(this.start=
Math.min(Math.max(a,0),this.stop-this.size)));this.value=Math.max(this.value,this.start);this.updateTarget();this.drawNew();return this.changed()};a.prototype.setStop=function(a){"number"===typeof a?this.stop=Math.max(a,this.start+this.size):(a=parseFloat(a),isNaN(a)||(this.stop=Math.max(a,this.start+this.size)));this.value=Math.min(this.value,this.stop);this.updateTarget();this.drawNew();return this.changed()};a.prototype.setSize=function(a){"number"===typeof a?this.size=Math.min(Math.max(a,1),this.stop-
this.start):(a=parseFloat(a),isNaN(a)||(this.size=Math.min(Math.max(a,1),this.stop-this.start)));this.value=Math.min(this.value,this.stop-this.size);this.updateTarget();this.drawNew();return this.changed()};a.prototype.setTarget=function(){var a,c,d=this;a=this.overlappedMorphs();c=new MenuMorph(this,"choose target:");a.push(this.world());a.forEach(function(a){return c.addItem(a.toString().slice(0,50),function(){d.target=a;return d.setTargetSetter()})});if(1===a.length)return this.target=a[0],this.setTargetSetter();
if(a.length)return c.popUpAtHand(this.world())};a.prototype.setTargetSetter=function(){var a,c,d=this;a=this.target.numericalSetters();c=new MenuMorph(this,"choose target property:");a.forEach(function(a){return c.addItem(a,function(){return d.action=a})});if(1===a.length)return this.action=a[0];if(a.length)return c.popUpAtHand(this.world())};a.prototype.numericalSetters=function(){var b;b=a.__super__.numericalSetters.call(this);b.push("setStart","setStop","setSize");return b};a.prototype.mouseDownLeft=
function(a){var c,d=this;this.offset=this.button.bounds.containsPoint(a)?a.subtract(this.button.bounds.origin):new Point;c=this.root();return this.step=function(){var a,b,f;return c.hand.mouseButton?(a=c.hand.bounds.origin,"vertical"===d.orientation?(b=d.button.bounds.origin.x,f=Math.max(Math.min(a.y-d.offset.y,d.bottom()-d.button.height()),d.top())):(f=d.button.bounds.origin.y,b=Math.max(Math.min(a.x-d.offset.x,d.right()-d.button.width()),d.left())),d.button.setPosition(new Point(b,f)),d.updateValue()):
d.step=null}};return a}(CircleBoxMorph);
MenuItemMorph=function(c){function a(b,c,d,e,g,f,i,j){a.__super__.constructor.call(this,b,c,d,e,g,f,i,j)}__extends(a,c);a.prototype.createLabel=function(){var a,c;null!==this.label&&this.label.destroy();isString(this.labelString)?this.label=this.createLabelString(this.labelString):this.labelString instanceof Array?(this.label=new Morph,this.label.alpha=0,this.label.add(a=this.createIcon(this.labelString[0])),this.label.add(c=this.createLabelString(this.labelString[1])),c.setCenter(a.center()),c.setLeft(a.right()+
4),this.label.bounds=a.bounds.merge(c.bounds),this.label.drawNew()):this.label=this.createIcon(this.labelString);this.silentSetExtent(this.label.extent().add(new Point(8,0)));this.label.bounds=this.position().add(new Point(4,0)).extent(this.label.extent());return this.add(this.label)};a.prototype.createIcon=function(a){var c,d;c=new Morph;c.image=a instanceof Morph?a.fullImage():a;a instanceof Morph&&a.getShadow()&&(d=c.image,c.image=newCanvas(a.fullBounds().extent().subtract(this.shadowBlur*(useBlurredShadows?
1:2))),c.image.getContext("2d").drawImage(d,0,0));c.silentSetWidth(c.image.width);c.silentSetHeight(c.image.height);return c};a.prototype.createLabelString=function(a){a=new TextMorph(a,this.fontSize,this.fontStyle);a.setColor(this.labelColor);return a};a.prototype.mouseEnter=function(){this.isListItem()||(this.image=this.highlightImage,this.changed());if(this.hint)return this.bubbleHelp(this.hint)};a.prototype.mouseLeave=function(){this.isListItem()||(this.image=this.normalImage,this.changed());
if(this.hint)return this.world().hand.destroyTemporaries()};a.prototype.mouseDownLeft=function(a){this.isListItem()&&(this.parent.unselectAllItems(),this.escalateEvent("mouseDownLeft",a));this.image=this.pressImage;return this.changed()};a.prototype.mouseMove=function(){if(this.isListItem())return this.escalateEvent("mouseMove")};a.prototype.mouseClickLeft=function(){this.isListItem()||(this.parent.destroy(),this.root().activeMenu=null);return this.trigger()};a.prototype.isListItem=function(){return this.parent?
this.parent.isListContents:!1};a.prototype.isSelectedListItem=function(){return this.isListItem()?this.image===this.pressImage:!1};return a}(TriggerMorph);ShadowMorph=function(c){function a(){a.__super__.constructor.call(this)}__extends(a,c);return a}(Morph);
