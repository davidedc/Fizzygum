<!DOCTYPE html>  <html> <head>   <title>Morph.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="BlinkerMorph.html">                 BlinkerMorph.coffee               </a>                                           <a class="source" href="BouncerMorph.html">                 BouncerMorph.coffee               </a>                                           <a class="source" href="BoxMorph.html">                 BoxMorph.coffee               </a>                                           <a class="source" href="CaretMorph.html">                 CaretMorph.coffee               </a>                                           <a class="source" href="CircleBoxMorph.html">                 CircleBoxMorph.coffee               </a>                                           <a class="source" href="CloseCircleButtonMorph.html">                 CloseCircleButtonMorph.coffee               </a>                                           <a class="source" href="Color.html">                 Color.coffee               </a>                                           <a class="source" href="ColorPaletteMorph.html">                 ColorPaletteMorph.coffee               </a>                                           <a class="source" href="ColorPickerMorph.html">                 ColorPickerMorph.coffee               </a>                                           <a class="source" href="FrameMorph.html">                 FrameMorph.coffee               </a>                                           <a class="source" href="GrayPaletteMorph.html">                 GrayPaletteMorph.coffee               </a>                                           <a class="source" href="HandMorph.html">                 HandMorph.coffee               </a>                                           <a class="source" href="HandleMorph.html">                 HandleMorph.coffee               </a>                                           <a class="source" href="InspectorMorph.html">                 InspectorMorph.coffee               </a>                                           <a class="source" href="ListMorph.html">                 ListMorph.coffee               </a>                                           <a class="source" href="MenuItemMorph.html">                 MenuItemMorph.coffee               </a>                                           <a class="source" href="MenuMorph.html">                 MenuMorph.coffee               </a>                                           <a class="source" href="Morph.html">                 Morph.coffee               </a>                                           <a class="source" href="MorphicNode.html">                 MorphicNode.coffee               </a>                                           <a class="source" href="MorphsListMorph.html">                 MorphsListMorph.coffee               </a>                                           <a class="source" href="MouseSensorMorph.html">                 MouseSensorMorph.coffee               </a>                                           <a class="source" href="Mousetrap.html">                 Mousetrap.coffee               </a>                                           <a class="source" href="PenMorph.html">                 PenMorph.coffee               </a>                                           <a class="source" href="Point.html">                 Point.coffee               </a>                                           <a class="source" href="Point2.html">                 Point2.coffee               </a>                                           <a class="source" href="Rectangle.html">                 Rectangle.coffee               </a>                                           <a class="source" href="RectangleMorph.html">                 RectangleMorph.coffee               </a>                                           <a class="source" href="ScrollFrameMorph.html">                 ScrollFrameMorph.coffee               </a>                                           <a class="source" href="ShadowMorph.html">                 ShadowMorph.coffee               </a>                                           <a class="source" href="SliderButtonMorph.html">                 SliderButtonMorph.coffee               </a>                                           <a class="source" href="SliderMorph.html">                 SliderMorph.coffee               </a>                                           <a class="source" href="SpeechBubbleMorph.html">                 SpeechBubbleMorph.coffee               </a>                                           <a class="source" href="StringFieldMorph.html">                 StringFieldMorph.coffee               </a>                                           <a class="source" href="StringMorph.html">                 StringMorph.coffee               </a>                                           <a class="source" href="SystemTest_SimpleMenuTest.html">                 SystemTest_SimpleMenuTest.coffee               </a>                                           <a class="source" href="SystemTestsRecorderAndPlayer.html">                 SystemTestsRecorderAndPlayer.coffee               </a>                                           <a class="source" href="TextMorph.html">                 TextMorph.coffee               </a>                                           <a class="source" href="TriggerMorph.html">                 TriggerMorph.coffee               </a>                                           <a class="source" href="WorkspaceMorph.html">                 WorkspaceMorph.coffee               </a>                                           <a class="source" href="WorldMorph.html">                 WorldMorph.coffee               </a>                                           <a class="source" href="globalFunctions.html">                 globalFunctions.coffee               </a>                                           <a class="source" href="globalSettings.html">                 globalSettings.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Morph.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Morph //////////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>this comment below is needed to figure our dependencies between classes
REQUIRES globalFunctions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Morph</span> <span class="k">extends</span> <span class="nx">MorphicNode</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Just some tests here ////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">propertyUpTheChain: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
  <span class="nv">morphMethod: </span><span class="nf">-&gt;</span>
    <span class="mf">3.14</span>
  <span class="vi">@morphStaticMethod: </span><span class="nf">-&gt;</span>
    <span class="mf">3.14</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>End of tests here ////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isMorph: </span><span class="kc">true</span>
  <span class="nv">bounds: </span><span class="kc">null</span>
  <span class="nv">color: </span><span class="kc">null</span>
  <span class="nv">texture: </span><span class="kc">null</span> <span class="c1"># optional url of a fill-image</span>
  <span class="nv">cachedTexture: </span><span class="kc">null</span> <span class="c1"># internal cache of actual bg image</span>
  <span class="nv">lastTime: </span><span class="kc">null</span>
  <span class="nv">alpha: </span><span class="mi">1</span>
  <span class="nv">isVisible: </span><span class="kc">true</span>
  <span class="nv">isDraggable: </span><span class="kc">false</span>
  <span class="nv">isTemplate: </span><span class="kc">false</span>
  <span class="nv">acceptsDrops: </span><span class="kc">false</span>
  <span class="nv">noticesTransparentClick: </span><span class="kc">false</span>
  <span class="nv">fps: </span><span class="mi">0</span>
  <span class="nv">customContextMenu: </span><span class="kc">null</span>
  <span class="nv">trackChanges: </span><span class="kc">true</span>
  <span class="nv">shadowBlur: </span><span class="mi">4</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>note that image contains only the CURRENT morph, not the composition of this
morph with all of the submorphs. I.e. for an inspector, this will only
contain the background of the window pane. Not any of its contents.
for the worldMorph, this only contains the background</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">image: </span><span class="kc">null</span>
  <span class="nv">onNextStep: </span><span class="kc">null</span> <span class="c1"># optional function to be run once. Not currently used in Zombie Kernel</span>
  
  <span class="nv">constructor: </span><span class="p">()</span> <span class="nf">-&gt;</span>
    <span class="k">super</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>[TODO] why is there this strange non-zero default bound?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@bounds = </span><span class="k">new</span> <span class="nx">Rectangle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
    <span class="vi">@color = </span><span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="vi">@lastTime = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Note that we don't call @updateRendering()
that's because the actual extending morph will probably
set more details of how it should look (e.g. size),
so we wait and we let the actual extending
morph to draw itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>damage list housekeeping</p>

<p>the trackChanges property of the Morph prototype is a Boolean switch
that determines whether the World's damage list ('broken' rectangles)
tracks changes. By default the switch is always on. If set to false
changes are not stored. This can be very useful for housekeeping of
the damage list in situations where a large number of (sub-) morphs
are changed more or less at once. Instead of keeping track of every
single submorph's changes tremendous performance improvements can be
achieved by setting the trackChanges flag to false before propagating
the layout changes, setting it to true again and then storing the full
bounds of the surrounding morph. An an example refer to the</p>

<pre><code>fixLayout()
</code></pre>

<p>method of InspectorMorph, or the</p>

<pre><code>startLayout()
endLayout()
</code></pre>

<p>methods of SyntaxElementMorph in the Snap application.</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Morph string representation: e.g. 'a Morph 2 [20@45 | 130@250]'</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toString: </span><span class="nf">-&gt;</span>
    <span class="s">&quot;a &quot;</span> <span class="o">+</span>
      <span class="p">(</span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">or</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
      <span class="s">&quot; &quot;</span> <span class="o">+</span>
      <span class="nx">@children</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span>
      <span class="s">&quot; &quot;</span> <span class="o">+</span>
      <span class="nx">@bounds</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Morph deleting:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">destroy: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@parent</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="nx">@fullChanged</span><span class="p">()</span>
      <span class="nx">@parent</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">@</span>
  
  <span class="nv">destroyAll: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>this is a typical case: we need to make a copy of the children
array first pecause we are iterating over an array that changes
its values (and length) while we are iterating on it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">childrenCopy = </span><span class="nx">@children</span><span class="p">.</span><span class="nx">filter</span> <span class="nf">(x) -&gt;</span> <span class="kc">true</span>
    <span class="nx">childrenCopy</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) =&gt;</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Morph stepping:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">runChildrensStepFunction: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>step is the function that this Morph wants to run at each step.
If the Morph wants to do nothing and let no-one of the children do nothing,
then step is set to null.
If the morph wants to do nothing but the children might want to do something,
then step is set to the function that does nothing (i.e. a function noOperation that
only returns null) </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">null</span>  <span class="k">unless</span> <span class="nx">@step</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>for objects where @fps is defined, check which ones are due to be stepped
and which ones want to wait. </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">elapsed = </span><span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">-</span> <span class="nx">@lastTime</span>
    <span class="k">if</span> <span class="nx">@fps</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">timeRemainingToWaitedFrame = </span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="nx">@fps</span><span class="p">)</span> <span class="o">-</span> <span class="nx">elapsed</span>
    <span class="k">else</span>
      <span class="nv">timeRemainingToWaitedFrame = </span><span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Question: why 1 here below?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">timeRemainingToWaitedFrame</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="vi">@lastTime = </span><span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">currentTime</span>
      <span class="k">if</span> <span class="nx">@onNextStep</span>
        <span class="nv">nxt = </span><span class="nx">@onNextStep</span>
        <span class="vi">@onNextStep = </span><span class="kc">null</span>
        <span class="nx">nxt</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
      <span class="nx">@step</span><span class="p">()</span>
      <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
        <span class="nx">child</span><span class="p">.</span><span class="nx">runChildrensStepFunction</span><span class="p">()</span>

  <span class="nv">nextSteps: </span><span class="nf">(arrayOfFunctions) -&gt;</span>
    <span class="nv">lst = </span><span class="nx">arrayOfFunctions</span> <span class="o">or</span> <span class="p">[]</span>
    <span class="nv">nxt = </span><span class="nx">lst</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">nxt</span>
      <span class="vi">@onNextStep = </span><span class="o">=&gt;</span>
        <span class="nx">nxt</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span>
        <span class="nx">@nextSteps</span> <span class="nx">lst</span>  
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>leaving this function as step means that the morph want to do nothing
but the children <em>are</em> traversed and their step function is invoked.
If a Morph wants to do nothing and wants to prevent the children to be
traversed, then this function should be set to null.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">step: </span><span class="nx">noOperation</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Morph accessing - geometry getting:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">left: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">left</span><span class="p">()</span>
  
  <span class="nv">right: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">right</span><span class="p">()</span>
  
  <span class="nv">top: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
  
  <span class="nv">bottom: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">bottom</span><span class="p">()</span>
  
  <span class="nv">center: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">center</span><span class="p">()</span>
  
  <span class="nv">bottomCenter: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">bottomCenter</span><span class="p">()</span>
  
  <span class="nv">bottomLeft: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">bottomLeft</span><span class="p">()</span>
  
  <span class="nv">bottomRight: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">bottomRight</span><span class="p">()</span>
  
  <span class="nv">boundingBox: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span>
  
  <span class="nv">corners: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">corners</span><span class="p">()</span>
  
  <span class="nv">leftCenter: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">leftCenter</span><span class="p">()</span>
  
  <span class="nv">rightCenter: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">rightCenter</span><span class="p">()</span>
  
  <span class="nv">topCenter: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">topCenter</span><span class="p">()</span>
  
  <span class="nv">topLeft: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">topLeft</span><span class="p">()</span>
  
  <span class="nv">topRight: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">topRight</span><span class="p">()</span>
  
  <span class="nv">position: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span>
  
  <span class="nv">extent: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">extent</span><span class="p">()</span>
  
  <span class="nv">width: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span>
  
  <span class="nv">height: </span><span class="nf">-&gt;</span>
    <span class="nx">@bounds</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
  
  <span class="nv">boundsIncludingChildren: </span><span class="nf">-&gt;</span>
    <span class="nv">result = </span><span class="nx">@bounds</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="nv">result = </span><span class="nx">result</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">boundsIncludingChildren</span><span class="p">())</span>  <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">isVisible</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">result</span>
  
  <span class="nv">boundsIncludingChildrenNoShadow: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>answer my full bounds but ignore any shadow</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">result = </span><span class="nx">@bounds</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">child</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">ShadowMorph</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">isVisible</span><span class="p">)</span>
        <span class="nv">result = </span><span class="nx">result</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">boundsIncludingChildren</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">result</span>
  
  <span class="nv">visibleBounds: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>answer which part of me is not clipped by a Frame</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">visible = </span><span class="nx">@bounds</span>
    <span class="nv">frames = </span><span class="nx">@allParents</span><span class="p">().</span><span class="nx">filter</span><span class="p">(</span><span class="nf">(p) -&gt;</span>
      <span class="nx">p</span> <span class="k">instanceof</span> <span class="nx">FrameMorph</span>
    <span class="p">)</span>
    <span class="nx">frames</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(f) -&gt;</span>
      <span class="nv">visible = </span><span class="nx">visible</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">bounds</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">visible</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Morph accessing - simple changes:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveBy: </span><span class="nf">(delta) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>question: why is changed() called two times?
question: can't we use silentMoveBy?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@changed</span><span class="p">()</span>
    <span class="vi">@bounds = </span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">translateBy</span><span class="p">(</span><span class="nx">delta</span><span class="p">)</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">moveBy</span> <span class="nx">delta</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@changed</span><span class="p">()</span>
  
  <span class="nv">silentMoveBy: </span><span class="nf">(delta) -&gt;</span>
    <span class="vi">@bounds = </span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">translateBy</span><span class="p">(</span><span class="nx">delta</span><span class="p">)</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">silentMoveBy</span> <span class="nx">delta</span>
  
  
  <span class="nv">setPosition: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nv">delta = </span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@topLeft</span><span class="p">())</span>
    <span class="nx">@moveBy</span> <span class="nx">delta</span>  <span class="k">if</span> <span class="p">(</span><span class="nx">delta</span><span class="p">.</span><span class="nx">x</span> <span class="o">isnt</span> <span class="mi">0</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">delta</span><span class="p">.</span><span class="nx">y</span> <span class="o">isnt</span> <span class="mi">0</span><span class="p">)</span>
  
  <span class="nv">silentSetPosition: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nv">delta = </span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@topLeft</span><span class="p">())</span>
    <span class="nx">@silentMoveBy</span> <span class="nx">delta</span>  <span class="k">if</span> <span class="p">(</span><span class="nx">delta</span><span class="p">.</span><span class="nx">x</span> <span class="o">isnt</span> <span class="mi">0</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">delta</span><span class="p">.</span><span class="nx">y</span> <span class="o">isnt</span> <span class="mi">0</span><span class="p">)</span>
  
  <span class="nv">setLeft: </span><span class="nf">(x) -&gt;</span>
    <span class="nx">@setPosition</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@top</span><span class="p">())</span>
  
  <span class="nv">setRight: </span><span class="nf">(x) -&gt;</span>
    <span class="nx">@setPosition</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@width</span><span class="p">(),</span> <span class="nx">@top</span><span class="p">())</span>
  
  <span class="nv">setTop: </span><span class="nf">(y) -&gt;</span>
    <span class="nx">@setPosition</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@left</span><span class="p">(),</span> <span class="nx">y</span><span class="p">)</span>
  
  <span class="nv">setBottom: </span><span class="nf">(y) -&gt;</span>
    <span class="nx">@setPosition</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@left</span><span class="p">(),</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">@height</span><span class="p">())</span>
  
  <span class="nv">setCenter: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nx">@setPosition</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@extent</span><span class="p">().</span><span class="nx">floorDivideBy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  
  <span class="nv">setFullCenter: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nx">@setPosition</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">extent</span><span class="p">().</span><span class="nx">floorDivideBy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>make sure I am completely within another Morph's bounds</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">keepWithin: </span><span class="nf">(aMorph) -&gt;</span>
    <span class="nv">leftOff = </span><span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">left</span><span class="p">()</span> <span class="o">-</span> <span class="nx">aMorph</span><span class="p">.</span><span class="nx">left</span><span class="p">()</span>
    <span class="nx">@moveBy</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="nx">leftOff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">leftOff</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nv">rightOff = </span><span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">right</span><span class="p">()</span> <span class="o">-</span> <span class="nx">aMorph</span><span class="p">.</span><span class="nx">right</span><span class="p">()</span>
    <span class="nx">@moveBy</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="o">-</span><span class="nx">rightOff</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">rightOff</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nv">topOff = </span><span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">top</span><span class="p">()</span> <span class="o">-</span> <span class="nx">aMorph</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
    <span class="nx">@moveBy</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nx">topOff</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">topOff</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nv">bottomOff = </span><span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">bottom</span><span class="p">()</span> <span class="o">-</span> <span class="nx">aMorph</span><span class="p">.</span><span class="nx">bottom</span><span class="p">()</span>
    <span class="nx">@moveBy</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nx">bottomOff</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">bottomOff</span> <span class="o">&gt;</span> <span class="mi">0</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Morph accessing - dimensional changes requiring a complete redraw</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setExtent: </span><span class="nf">(aPoint) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>check whether we are actually changing the extent.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">unless</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">@extent</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>question: why two "changed" invocations?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@changed</span><span class="p">()</span>
      <span class="nx">@silentSetExtent</span> <span class="nx">aPoint</span>
      <span class="nx">@changed</span><span class="p">()</span>
      <span class="nx">@updateRendering</span><span class="p">()</span>
  
  <span class="nv">silentSetExtent: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nv">ext = </span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">round</span><span class="p">()</span>
    <span class="nv">newWidth = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">ext</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">newHeight = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">ext</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="vi">@bounds.corner = </span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">newWidth</span><span class="p">,</span> <span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">newHeight</span><span class="p">)</span>
  
  <span class="nv">setWidth: </span><span class="nf">(width) -&gt;</span>
    <span class="nx">@setExtent</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">width</span> <span class="o">or</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@height</span><span class="p">())</span>
  
  <span class="nv">silentSetWidth: </span><span class="nf">(width) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>do not updateRendering() just yet</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">w = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">width</span> <span class="o">or</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="vi">@bounds.corner = </span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">@bounds</span><span class="p">.</span><span class="nx">corner</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  
  <span class="nv">setHeight: </span><span class="nf">(height) -&gt;</span>
    <span class="nx">@setExtent</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@width</span><span class="p">(),</span> <span class="nx">height</span> <span class="o">or</span> <span class="mi">0</span><span class="p">)</span>
  
  <span class="nv">silentSetHeight: </span><span class="nf">(height) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>do not updateRendering() just yet</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">h = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">height</span> <span class="o">or</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="vi">@bounds.corner = </span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">corner</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">h</span><span class="p">)</span>
  
  <span class="nv">setColor: </span><span class="nf">(aColor) -&gt;</span>
    <span class="k">if</span> <span class="nx">aColor</span>
      <span class="k">unless</span> <span class="nx">@color</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">aColor</span><span class="p">)</span>
        <span class="vi">@color = </span><span class="nx">aColor</span>
        <span class="nx">@changed</span><span class="p">()</span>
        <span class="nx">@updateRendering</span><span class="p">()</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Morph displaying ###########################################################</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>There are three fundamental methods for rendering and displaying anything.
* updateRendering: this one creates/updates the local canvas of this morph only
  i.e. not the children. For example: a ColorPickerMorph is a Morph which
  contains three children Morphs (a color palette, a greyscale palette and
  a feedback). The updateRendering method of ColorPickerMorph only creates
  a canvas for the container Morph. So that's just a canvas with a
  solid color. As the
  ColorPickerMorph constructor runs, the three childredn Morphs will
  run their own updateRendering method, so each child will have its own
  canvas with their own contents.
* blit: takes the local canvas and blits it to a specific area in a passed
  canvas. The local canvas doesn't contain any rendering of the children of
  this morph.
* recursivelyBlit: recursively draws all the local canvas of this morph and all
  its children into a specific area of a passed canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">updateRendering: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>initialize my surface property</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@image = </span><span class="nx">newCanvas</span><span class="p">(</span><span class="nx">@extent</span><span class="p">())</span>
    <span class="nv">context = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nv">context.fillStyle = </span><span class="nx">@color</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@width</span><span class="p">(),</span> <span class="nx">@height</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@cachedTexture</span>
      <span class="nx">@drawCachedTexture</span><span class="p">()</span>
    <span class="k">else</span> <span class="nx">@drawTexture</span> <span class="nx">@texture</span>  <span class="k">if</span> <span class="nx">@texture</span>
  
  <span class="nv">drawTexture: </span><span class="nf">(url) -&gt;</span>
    <span class="vi">@cachedTexture = </span><span class="k">new</span> <span class="nx">Image</span><span class="p">()</span>
    <span class="vi">@cachedTexture.onload = </span><span class="o">=&gt;</span>
      <span class="nx">@drawCachedTexture</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@cachedTexture.src = @texture = </span><span class="nx">url</span> <span class="c1"># make absolute</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>tiles the texture</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawCachedTexture: </span><span class="nf">-&gt;</span>
    <span class="nv">bg = </span><span class="nx">@cachedTexture</span>
    <span class="nv">cols = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">@image</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">bg</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
    <span class="nv">lines = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">@image</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">bg</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
    <span class="nv">context = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">lines</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">cols</span><span class="p">]</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">bg</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">bg</span><span class="p">.</span><span class="nx">width</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">bg</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
    <span class="nx">@changed</span><span class="p">()</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Morph.prototype.drawCachedTexture = function () {
   var context = this.image.getContext('2d'),
       pattern = context.createPattern(this.cachedTexture, 'repeat');
context.fillStyle = pattern;
   context.fillRect(0, 0, this.image.width, this.image.height);
   this.changed();
};</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>This method only paints this very morph's "image",
it doesn't descend the children
recursively. The recursion mechanism is done by recursivelyBlit, which
eventually invokes blit.
Note that this morph might paint something on the screen even if
it's not a "leaf".</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">blit: </span><span class="nf">(aCanvas, clippingRectangle = @bounds) -&gt;</span>
    <span class="k">return</span> <span class="kc">null</span>  <span class="k">unless</span> <span class="nx">@isVisible</span>
    <span class="nv">area = </span><span class="nx">clippingRectangle</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">@bounds</span><span class="p">).</span><span class="nx">round</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>test whether anything that we are going to be drawing
is visible (i.e. within the clippingRectangle)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">area</span><span class="p">.</span><span class="nx">isNotEmpty</span><span class="p">()</span>
      <span class="nv">delta = </span><span class="nx">@position</span><span class="p">().</span><span class="nx">neg</span><span class="p">()</span>
      <span class="nv">src = </span><span class="nx">area</span><span class="p">.</span><span class="nx">copy</span><span class="p">().</span><span class="nx">translateBy</span><span class="p">(</span><span class="nx">delta</span><span class="p">).</span><span class="nx">round</span><span class="p">()</span>
      <span class="nv">context = </span><span class="nx">aCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
      <span class="nv">context.globalAlpha = </span><span class="nx">@alpha</span>
      <span class="nv">sl = </span><span class="nx">src</span><span class="p">.</span><span class="nx">left</span><span class="p">()</span>
      <span class="nv">st = </span><span class="nx">src</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
      <span class="nv">al = </span><span class="nx">area</span><span class="p">.</span><span class="nx">left</span><span class="p">()</span>
      <span class="nv">at = </span><span class="nx">area</span><span class="p">.</span><span class="nx">top</span><span class="p">()</span>
      <span class="nv">w = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">width</span><span class="p">(),</span> <span class="nx">@image</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">sl</span><span class="p">)</span>
      <span class="nv">h = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">height</span><span class="p">(),</span> <span class="nx">@image</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">st</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span>  <span class="k">if</span> <span class="nx">w</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">1</span>

      <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@image</span><span class="p">,</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">sl</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">st</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">w</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">al</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">at</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">w</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>

      <span class="k">if</span> <span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">showRedraws</span>
        <span class="nv">randomR = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
        <span class="nv">randomG = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
        <span class="nv">randomB = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
        <span class="nv">context.globalAlpha = </span><span class="mf">0.5</span>
        <span class="nv">context.fillStyle = </span><span class="s">&quot;rgb(&quot;</span><span class="o">+</span><span class="nx">randomR</span><span class="o">+</span><span class="s">&quot;,&quot;</span><span class="o">+</span><span class="nx">randomG</span><span class="o">+</span><span class="s">&quot;,&quot;</span><span class="o">+</span><span class="nx">randomB</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">;</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">al</span><span class="p">),</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">at</span><span class="p">),</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">w</span><span class="p">),</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">h</span><span class="p">));</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>"for debugging purposes:"</p>

<pre><code>try {
    context.drawImage(
        this.image,
        src.left(),
        src.top(),
        w,
        h,
        area.left(),
        area.top(),
        w,
        h
    );
} catch (err) {
    alert('internal error\n\n' + err
        + '\n ---'
        + '\n canvas: ' + aCanvas
        + '\n canvas.width: ' + aCanvas.width
        + '\n canvas.height: ' + aCanvas.height
        + '\n ---'
        + '\n image: ' + this.image
        + '\n image.width: ' + this.image.width
        + '\n image.height: ' + this.image.height
        + '\n ---'
        + '\n w: ' + w
        + '\n h: ' + h
        + '\n sl: ' + sl
        + '\n st: ' + st
        + '\n area.left: ' + area.left()
        + '\n area.top ' + area.top()
        );
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">recursivelyBlit: </span><span class="p">(</span><span class="nx">aCanvas</span><span class="p">,</span> <span class="nv">clippingRectangle = </span><span class="nx">@boundsIncludingChildren</span><span class="p">())</span> <span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="kc">null</span>  <span class="k">unless</span> <span class="nx">@isVisible</span>
    <span class="nx">@blit</span> <span class="nx">aCanvas</span><span class="p">,</span> <span class="nx">clippingRectangle</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">recursivelyBlit</span> <span class="nx">aCanvas</span><span class="p">,</span> <span class="nx">clippingRectangle</span>
  
  
  <span class="nv">hide: </span><span class="nf">-&gt;</span>
    <span class="vi">@isVisible = </span><span class="kc">false</span>
    <span class="nx">@changed</span><span class="p">()</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
  
  
  <span class="nv">show: </span><span class="nf">-&gt;</span>
    <span class="vi">@isVisible = </span><span class="kc">true</span>
    <span class="nx">@changed</span><span class="p">()</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
  
  
  <span class="nv">toggleVisibility: </span><span class="nf">-&gt;</span>
    <span class="vi">@isVisible = </span><span class="p">(</span><span class="o">not</span> <span class="nx">@isVisible</span><span class="p">)</span>
    <span class="nx">@changed</span><span class="p">()</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(child) -&gt;</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">toggleVisibility</span><span class="p">()</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Morph full image:</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>this function is not used.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fullImageClassic: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>why doesn't this work for all Morphs?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">fb = </span><span class="nx">@boundsIncludingChildren</span><span class="p">()</span>
    <span class="nv">img = </span><span class="nx">newCanvas</span><span class="p">(</span><span class="nx">fb</span><span class="p">.</span><span class="nx">extent</span><span class="p">())</span>
    <span class="nx">@recursivelyBlit</span> <span class="nx">img</span><span class="p">,</span> <span class="nx">fb</span>
    <span class="nv">img.globalAlpha = </span><span class="nx">@alpha</span>
    <span class="nx">img</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>fixes https://github.com/jmoenig/morphic.js/issues/7</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fullImage: </span><span class="nf">-&gt;</span>
    <span class="nv">boundsIncludingChildren = </span><span class="nx">@boundsIncludingChildren</span><span class="p">()</span>
    <span class="nv">img = </span><span class="nx">newCanvas</span><span class="p">(</span><span class="nx">boundsIncludingChildren</span><span class="p">.</span><span class="nx">extent</span><span class="p">())</span>
    <span class="nv">ctx = </span><span class="nx">img</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="o">-</span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="p">,</span> <span class="o">-</span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span>
    <span class="nx">@recursivelyBlit</span> <span class="nx">img</span><span class="p">,</span> <span class="nx">boundsIncludingChildren</span>
    <span class="nx">img</span>

  <span class="nv">fullImageData: </span><span class="nf">-&gt;</span>
    <span class="nx">@fullImage</span><span class="p">().</span><span class="nx">toDataURL</span><span class="p">()</span>

  <span class="nv">fullImageHashCode: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">hashCode</span><span class="p">(</span><span class="nx">@fullImageData</span><span class="p">())</span>
  </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Morph shadow:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shadowImage: </span><span class="nf">(off_, color) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>fallback for Windows Chrome-Shadow bug</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">offset = </span><span class="nx">off_</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="nv">clr = </span><span class="nx">color</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">fb = </span><span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">extent</span><span class="p">()</span>
    <span class="nv">img = </span><span class="nx">@fullImage</span><span class="p">()</span>
    <span class="nv">outline = </span><span class="nx">newCanvas</span><span class="p">(</span><span class="nx">fb</span><span class="p">)</span>
    <span class="nv">ctx = </span><span class="nx">outline</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="nv">ctx.globalCompositeOperation = </span><span class="s">&quot;destination-out&quot;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="o">-</span><span class="nx">offset</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="o">-</span><span class="nx">offset</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nv">sha = </span><span class="nx">newCanvas</span><span class="p">(</span><span class="nx">fb</span><span class="p">)</span>
    <span class="nv">ctx = </span><span class="nx">sha</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">outline</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="nv">ctx.globalCompositeOperation = </span><span class="s">&quot;source-atop&quot;</span>
    <span class="nv">ctx.fillStyle = </span><span class="nx">clr</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">y</span>
    <span class="nx">sha</span>
  
  <span class="nv">shadowImageBlurred: </span><span class="nf">(off_, color) -&gt;</span>
    <span class="nv">offset = </span><span class="nx">off_</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="nv">blur = </span><span class="nx">@shadowBlur</span>
    <span class="nv">clr = </span><span class="nx">color</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">fb = </span><span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">extent</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span><span class="nx">blur</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nv">img = </span><span class="nx">@fullImage</span><span class="p">()</span>
    <span class="nv">sha = </span><span class="nx">newCanvas</span><span class="p">(</span><span class="nx">fb</span><span class="p">)</span>
    <span class="nv">ctx = </span><span class="nx">sha</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nv">ctx.shadowOffsetX = </span><span class="nx">offset</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">ctx.shadowOffsetY = </span><span class="nx">offset</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">ctx.shadowBlur = </span><span class="nx">blur</span>
    <span class="nv">ctx.shadowColor = </span><span class="nx">clr</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">blur</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">blur</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nv">ctx.shadowOffsetX = </span><span class="mi">0</span>
    <span class="nv">ctx.shadowOffsetY = </span><span class="mi">0</span>
    <span class="nv">ctx.shadowBlur = </span><span class="mi">0</span>
    <span class="nv">ctx.globalCompositeOperation = </span><span class="s">&quot;destination-out&quot;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">blur</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">blur</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nx">sha</span>
  
  <span class="nv">shadow: </span><span class="nf">(off_, a, color) -&gt;</span>
    <span class="nv">shadow = </span><span class="k">new</span> <span class="nx">ShadowMorph</span><span class="p">()</span>
    <span class="nv">offset = </span><span class="nx">off_</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="nv">alpha = </span><span class="nx">a</span> <span class="o">or</span> <span class="p">((</span><span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="nv">fb = </span><span class="nx">@boundsIncludingChildren</span><span class="p">()</span>
    <span class="nx">shadow</span><span class="p">.</span><span class="nx">setExtent</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">extent</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span><span class="nx">@shadowBlur</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">useBlurredShadows</span> <span class="o">and</span>  <span class="o">!</span><span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">MorphicPreferences</span><span class="p">.</span><span class="nx">isFlat</span>
      <span class="nv">shadow.image = </span><span class="nx">@shadowImageBlurred</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span>
      <span class="nv">shadow.alpha = </span><span class="nx">alpha</span>
      <span class="nx">shadow</span><span class="p">.</span><span class="nx">setPosition</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">offset</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@shadowBlur</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">shadow.image = </span><span class="nx">@shadowImage</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span>
      <span class="nv">shadow.alpha = </span><span class="nx">alpha</span>
      <span class="nx">shadow</span><span class="p">.</span><span class="nx">setPosition</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
    <span class="nx">shadow</span>
  
  <span class="nv">addShadow: </span><span class="nf">(off_, a, color) -&gt;</span>
    <span class="nv">offset = </span><span class="nx">off_</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="nv">alpha = </span><span class="nx">a</span> <span class="o">or</span> <span class="p">((</span><span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="nv">shadow = </span><span class="nx">@shadow</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span>
    <span class="nx">@addBack</span> <span class="nx">shadow</span>
    <span class="nx">@fullChanged</span><span class="p">()</span>
    <span class="nx">shadow</span>
  
  <span class="nv">getShadow: </span><span class="nf">-&gt;</span>
    <span class="nv">shadows = </span><span class="nx">@children</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">filter</span><span class="p">(</span><span class="nf">(child) -&gt;</span>
      <span class="nx">child</span> <span class="k">instanceof</span> <span class="nx">ShadowMorph</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nx">shadows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="k">if</span> <span class="nx">shadows</span><span class="p">.</span><span class="nx">length</span>
    <span class="kc">null</span>
  
  <span class="nv">removeShadow: </span><span class="nf">-&gt;</span>
    <span class="nv">shadow = </span><span class="nx">@getShadow</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">shadow</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="nx">@fullChanged</span><span class="p">()</span>
      <span class="nx">@removeChild</span> <span class="nx">shadow</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Morph pen trails:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">penTrails: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>answer my pen trails canvas. default is to answer my image</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@image</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Morph updating ///////////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">changed: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@trackChanges</span>
      <span class="nv">w = </span><span class="nx">@root</span><span class="p">()</span>
      <span class="nx">w</span><span class="p">.</span><span class="nx">broken</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@visibleBounds</span><span class="p">().</span><span class="nx">spread</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">w</span> <span class="k">instanceof</span> <span class="nx">WorldMorph</span>
    <span class="nx">@parent</span><span class="p">.</span><span class="nx">childChanged</span> <span class="nx">@</span>  <span class="k">if</span> <span class="nx">@parent</span>
  
  <span class="nv">fullChanged: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@trackChanges</span>
      <span class="nv">w = </span><span class="nx">@root</span><span class="p">()</span>
      <span class="nx">w</span><span class="p">.</span><span class="nx">broken</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@boundsIncludingChildren</span><span class="p">().</span><span class="nx">spread</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">w</span> <span class="k">instanceof</span> <span class="nx">WorldMorph</span>
  
  <span class="nv">childChanged: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>react to a  change in one of my children,
default is to just pass this message on upwards
override this method for Morphs that need to adjust accordingly</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@parent</span><span class="p">.</span><span class="nx">childChanged</span> <span class="nx">@</span>  <span class="k">if</span> <span class="nx">@parent</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Morph accessing - structure //////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">world: </span><span class="nf">-&gt;</span>
    <span class="nv">root = </span><span class="nx">@root</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">root</span>  <span class="k">if</span> <span class="nx">root</span> <span class="k">instanceof</span> <span class="nx">WorldMorph</span>
    <span class="k">return</span> <span class="nx">root</span><span class="p">.</span><span class="nx">world</span>  <span class="k">if</span> <span class="nx">root</span> <span class="k">instanceof</span> <span class="nx">HandMorph</span>
    <span class="kc">null</span>
  </pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>attaches submorph ontop</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="nf">(aMorph) -&gt;</span>
    <span class="nv">owner = </span><span class="nx">aMorph</span><span class="p">.</span><span class="nx">parent</span>
    <span class="nx">owner</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">aMorph</span>  <span class="k">if</span> <span class="nx">owner</span><span class="o">?</span>
    <span class="nx">@addChild</span> <span class="nx">aMorph</span>
  </pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>attaches submorph underneath</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addBack: </span><span class="nf">(aMorph) -&gt;</span>
    <span class="nv">owner = </span><span class="nx">aMorph</span><span class="p">.</span><span class="nx">parent</span>
    <span class="nx">owner</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">aMorph</span>  <span class="k">if</span> <span class="nx">owner</span><span class="o">?</span>
    <span class="nx">@addChildFirst</span> <span class="nx">aMorph</span>
  
  <span class="nv">topMorphSuchThat: </span><span class="nf">(predicate) -&gt;</span>
    <span class="k">if</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">@</span><span class="p">)</span>
      <span class="nv">next = </span><span class="nx">detect</span><span class="p">(</span><span class="nx">@children</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">reverse</span><span class="p">(),</span> <span class="nx">predicate</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">topMorphSuchThat</span><span class="p">(</span><span class="nx">predicate</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">next</span>
      <span class="k">return</span> <span class="nx">@</span>
    <span class="kc">null</span>
  
  <span class="nv">morphAt: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nv">morphs = </span><span class="nx">@allChildren</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">reverse</span><span class="p">()</span>
    <span class="nv">result = </span><span class="kc">null</span>
    <span class="nx">morphs</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(m) -&gt;</span>
      <span class="nv">result = </span><span class="nx">m</span>  <span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nx">boundsIncludingChildren</span><span class="p">().</span><span class="nx">containsPoint</span><span class="p">(</span><span class="nx">aPoint</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">result</span> <span class="o">is</span> <span class="kc">null</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">result</span>
  </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>alternative -  more elegant and possibly more
performant - solution for morphAt.
Has some issues, commented out for now</p>

<p>Morph.prototype.morphAt = function (aPoint) {
return this.topMorphSuchThat(function (m) {
    return m.boundsIncludingChildren().containsPoint(aPoint);
});
};</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>used for example:
- to determine which morphs you can attach a morph to
- for a SliderMorph's "set target" so you can change properties of another Morph
- by the HandleMorph when you attach it to some other morph</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">overlappedMorphs: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>find all morphs in the world that intersect me,
excluding myself and the World
and any of my parents
   (cause I'm already attached to them directly or indirectly)
or any of my children
   (cause they are already attached to me directly or indirectly)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">world = </span><span class="nx">@world</span><span class="p">()</span>
    <span class="nv">fb = </span><span class="nx">@boundsIncludingChildren</span><span class="p">()</span>
    <span class="nv">allParents = </span><span class="nx">@allParents</span><span class="p">()</span>
    <span class="nv">allChildren = </span><span class="nx">@allChildren</span><span class="p">()</span>
    <span class="nv">morphs = </span><span class="nx">world</span><span class="p">.</span><span class="nx">allChildren</span><span class="p">()</span>
    <span class="nx">morphs</span><span class="p">.</span><span class="nx">filter</span> <span class="nf">(m) =&gt;</span>
      <span class="nx">m</span><span class="p">.</span><span class="nx">isVisible</span> <span class="o">and</span>
        <span class="nx">m</span> <span class="o">isnt</span> <span class="nx">@</span> <span class="o">and</span>
        <span class="nx">m</span> <span class="o">isnt</span> <span class="nx">world</span> <span class="o">and</span>
        <span class="o">not</span> <span class="nx">contains</span><span class="p">(</span><span class="nx">allParents</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="o">and</span>
        <span class="o">not</span> <span class="nx">contains</span><span class="p">(</span><span class="nx">allChildren</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="o">and</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">boundsIncludingChildren</span><span class="p">().</span><span class="nx">intersects</span><span class="p">(</span><span class="nx">fb</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Morph pixel access:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getPixelColor: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nv">point = </span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">)</span>
    <span class="nv">context = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nv">data = </span><span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
  
  <span class="nv">isTransparentAt: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="k">if</span> <span class="nx">@bounds</span><span class="p">.</span><span class="nx">containsPoint</span><span class="p">(</span><span class="nx">aPoint</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span>  <span class="k">if</span> <span class="nx">@texture</span>
      <span class="nv">point = </span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">)</span>
      <span class="nv">context = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
      <span class="nv">data = </span><span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>check the 4th byte - the Alpha (RGBA)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="kc">false</span>
  </pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Morph duplicating ////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">copy: </span><span class="nf">-&gt;</span>
    <span class="nv">c = </span><span class="nx">copy</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="nv">c.parent = </span><span class="kc">null</span>
    <span class="nv">c.children = </span><span class="p">[]</span>
    <span class="nv">c.bounds = </span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
    <span class="nx">c</span>
  
  <span class="nv">fullCopy: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Produce a copy of me with my entire tree of submorphs. Morphs
mentioned more than once are all directed to a single new copy.
Other properties are also <em>shallow</em> copied, so you must override
to deep copy Arrays and (complex) Objects</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">dict = </span><span class="p">{}</span>
    <span class="nv">c = </span><span class="nx">@copyRecordingReferences</span><span class="p">(</span><span class="nx">dict</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">forAllChildren</span> <span class="nf">(m) -&gt;</span>
      <span class="nx">m</span><span class="p">.</span><span class="nx">updateReferences</span> <span class="nx">dict</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">c</span>
  
  <span class="nv">copyRecordingReferences: </span><span class="nf">(dict) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Recursively copy this entire composite morph, recording the
correspondence between old and new morphs in the given dictionary.
This dictionary will be used to update intra-composite references
in the copy. See updateReferences().
Note: This default implementation copies ONLY morphs in the
submorph hierarchy. If a morph stores morphs in other properties
that it wants to copy, then it should override this method to do so.
The same goes for morphs that contain other complex data that
should be copied when the morph is duplicated.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">c = </span><span class="nx">@copy</span><span class="p">()</span>
    <span class="nx">dict</span><span class="p">[</span><span class="nx">@</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(m) -&gt;</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">add</span> <span class="nx">m</span><span class="p">.</span><span class="nx">copyRecordingReferences</span><span class="p">(</span><span class="nx">dict</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">c</span>
  
  <span class="nv">updateReferences: </span><span class="nf">(dict) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Update intra-morph references within a composite morph that has
been copied. For example, if a button refers to morph X in the
orginal composite then the copy of that button in the new composite
should refer to the copy of X in new composite, not the original X.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">property</span> <span class="k">of</span> <span class="nx">@</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dict</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span>  <span class="k">if</span> <span class="nx">property</span><span class="p">.</span><span class="nx">isMorph</span> <span class="o">and</span> <span class="nx">dict</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Morph dragging and dropping /////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">rootForGrab: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">rootForGrab</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">@</span> <span class="k">instanceof</span> <span class="nx">ShadowMorph</span>
    <span class="k">return</span> <span class="nx">@parent</span>  <span class="k">if</span> <span class="nx">@parent</span> <span class="k">instanceof</span> <span class="nx">ScrollFrameMorph</span>
    <span class="k">if</span> <span class="nx">@parent</span> <span class="o">is</span> <span class="kc">null</span> <span class="o">or</span>
      <span class="nx">@parent</span> <span class="k">instanceof</span> <span class="nx">WorldMorph</span> <span class="o">or</span>
      <span class="nx">@parent</span> <span class="k">instanceof</span> <span class="nx">FrameMorph</span> <span class="o">or</span>
      <span class="nx">@isDraggable</span> <span class="o">is</span> <span class="kc">true</span>
        <span class="k">return</span> <span class="nx">@</span>  
    <span class="nx">@parent</span><span class="p">.</span><span class="nx">rootForGrab</span><span class="p">()</span>
  
  <span class="nv">wantsDropOf: </span><span class="nf">(aMorph) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>default is to answer the general flag - change for my heirs</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">aMorph</span> <span class="k">instanceof</span> <span class="nx">HandleMorph</span><span class="p">)</span> <span class="o">or</span>
      <span class="p">(</span><span class="nx">aMorph</span> <span class="k">instanceof</span> <span class="nx">MenuMorph</span><span class="p">)</span> <span class="o">or</span>
      <span class="p">(</span><span class="nx">aMorph</span> <span class="k">instanceof</span> <span class="nx">InspectorMorph</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">false</span>  
    <span class="nx">@acceptsDrops</span>
  
  <span class="nv">pickUp: </span><span class="nf">(wrrld) -&gt;</span>
    <span class="nv">world = </span><span class="nx">wrrld</span> <span class="o">or</span> <span class="nx">@world</span><span class="p">()</span>
    <span class="nx">@setPosition</span> <span class="nx">world</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">position</span><span class="p">().</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@extent</span><span class="p">().</span><span class="nx">floorDivideBy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="nx">world</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">grab</span> <span class="nx">@</span>
  
  <span class="nv">isPickedUp: </span><span class="nf">-&gt;</span>
    <span class="nx">@parentThatIsA</span><span class="p">(</span><span class="nx">HandMorph</span><span class="p">)</span> <span class="o">isnt</span> <span class="kc">null</span>
  
  <span class="nv">situation: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>answer a dictionary specifying where I am right now, so
I can slide back to it if I'm dropped somewhere else</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@parent</span>
      <span class="k">return</span> <span class="p">(</span>
        <span class="nv">origin: </span><span class="nx">@parent</span>
        <span class="nv">position: </span><span class="nx">@position</span><span class="p">().</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@parent</span><span class="p">.</span><span class="nx">position</span><span class="p">())</span>
      <span class="p">)</span>
    <span class="kc">null</span>
  
  <span class="nv">slideBackTo: </span><span class="nf">(situation, inSteps) -&gt;</span>
    <span class="nv">steps = </span><span class="nx">inSteps</span> <span class="o">or</span> <span class="mi">5</span>
    <span class="nv">pos = </span><span class="nx">situation</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">position</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span><span class="nx">situation</span><span class="p">.</span><span class="nx">position</span><span class="p">)</span>
    <span class="nv">xStep = </span><span class="o">-</span><span class="p">(</span><span class="nx">@left</span><span class="p">()</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="nx">steps</span>
    <span class="nv">yStep = </span><span class="o">-</span><span class="p">(</span><span class="nx">@top</span><span class="p">()</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">/</span> <span class="nx">steps</span>
    <span class="nv">stepCount = </span><span class="mi">0</span>
    <span class="nv">oldStep = </span><span class="nx">@step</span>
    <span class="nv">oldFps = </span><span class="nx">@fps</span>
    <span class="vi">@fps = </span><span class="mi">0</span>
    <span class="vi">@step = </span><span class="o">=&gt;</span>
      <span class="nx">@fullChanged</span><span class="p">()</span>
      <span class="nx">@silentMoveBy</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">xStep</span><span class="p">,</span> <span class="nx">yStep</span><span class="p">)</span>
      <span class="nx">@fullChanged</span><span class="p">()</span>
      <span class="nx">stepCount</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nx">stepCount</span> <span class="o">is</span> <span class="nx">steps</span>
        <span class="nx">situation</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@</span>
        <span class="nx">situation</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">reactToDropOf</span> <span class="nx">@</span>  <span class="k">if</span> <span class="nx">situation</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">reactToDropOf</span>
        <span class="vi">@step = </span><span class="nx">oldStep</span>
        <span class="vi">@fps = </span><span class="nx">oldFps</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Morph utilities ////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">resize: </span><span class="nf">-&gt;</span>
    <span class="nx">@world</span><span class="p">().</span><span class="nv">activeHandle = </span><span class="k">new</span> <span class="nx">HandleMorph</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
  
  <span class="nv">move: </span><span class="nf">-&gt;</span>
    <span class="nx">@world</span><span class="p">().</span><span class="nv">activeHandle = </span><span class="k">new</span> <span class="nx">HandleMorph</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s">&quot;move&quot;</span><span class="p">)</span>
  
  <span class="nv">hint: </span><span class="nf">(msg) -&gt;</span>
    <span class="nv">text = </span><span class="nx">msg</span>
    <span class="k">if</span> <span class="nx">msg</span>
      <span class="nv">text = </span><span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span>
    <span class="k">else</span>
      <span class="nv">text = </span><span class="s">&quot;NULL&quot;</span>
    <span class="nv">m = </span><span class="k">new</span> <span class="nx">MenuMorph</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span>
    <span class="nv">m.isDraggable = </span><span class="kc">true</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">popUpCenteredAtHand</span> <span class="nx">@world</span><span class="p">()</span>
  
  <span class="nv">inform: </span><span class="nf">(msg) -&gt;</span>
    <span class="nv">text = </span><span class="nx">msg</span>
    <span class="k">if</span> <span class="nx">msg</span>
      <span class="nv">text = </span><span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span>
    <span class="k">else</span>
      <span class="nv">text = </span><span class="s">&quot;NULL&quot;</span>
    <span class="nv">m = </span><span class="k">new</span> <span class="nx">MenuMorph</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;Ok&quot;</span>
    <span class="nv">m.isDraggable = </span><span class="kc">true</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">popUpCenteredAtHand</span> <span class="nx">@world</span><span class="p">()</span>
  
  <span class="nv">prompt: </span><span class="nf">(msg, callback, environment, defaultContents, width, floorNum,</span>
<span class="nf">    ceilingNum, isRounded) -&gt;</span>
    <span class="nv">isNumeric = </span><span class="kc">true</span>  <span class="k">if</span> <span class="nx">ceilingNum</span>
    <span class="nv">menu = </span><span class="k">new</span> <span class="nx">MenuMorph</span><span class="p">(</span><span class="nx">callback</span> <span class="o">or</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">environment</span> <span class="o">or</span> <span class="kc">null</span><span class="p">)</span>
    <span class="nv">entryField = </span><span class="k">new</span> <span class="nx">StringFieldMorph</span><span class="p">(</span>
      <span class="nx">defaultContents</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
      <span class="nx">width</span> <span class="o">or</span> <span class="mi">100</span><span class="p">,</span>
      <span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">MorphicPreferences</span><span class="p">.</span><span class="nx">prompterFontSize</span><span class="p">,</span>
      <span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">MorphicPreferences</span><span class="p">.</span><span class="nx">prompterFontName</span><span class="p">,</span>
      <span class="kc">false</span><span class="p">,</span>
      <span class="kc">false</span><span class="p">,</span>
      <span class="nx">isNumeric</span><span class="p">)</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">entryField</span>
    <span class="k">if</span> <span class="nx">ceilingNum</span> <span class="o">or</span> <span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">MorphicPreferences</span><span class="p">.</span><span class="nx">useSliderForInput</span>
      <span class="nv">slider = </span><span class="k">new</span> <span class="nx">SliderMorph</span><span class="p">(</span>
        <span class="nx">floorNum</span> <span class="o">or</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">ceilingNum</span><span class="p">,</span>
        <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">defaultContents</span><span class="p">),</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">ceilingNum</span> <span class="o">-</span> <span class="nx">floorNum</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s">&quot;horizontal&quot;</span><span class="p">)</span>
      <span class="nv">slider.alpha = </span><span class="mi">1</span>
      <span class="nv">slider.color = </span><span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="mi">225</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">225</span><span class="p">)</span>
      <span class="nv">slider.button.color = </span><span class="nx">menu</span><span class="p">.</span><span class="nx">borderColor</span>
      <span class="nv">slider.button.highlightColor = </span><span class="nx">slider</span><span class="p">.</span><span class="nx">button</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nx">slider</span><span class="p">.</span><span class="nx">button</span><span class="p">.</span><span class="nx">highlightColor</span><span class="p">.</span><span class="nx">b</span> <span class="o">+=</span> <span class="mi">100</span>
      <span class="nv">slider.button.pressColor = </span><span class="nx">slider</span><span class="p">.</span><span class="nx">button</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nx">slider</span><span class="p">.</span><span class="nx">button</span><span class="p">.</span><span class="nx">pressColor</span><span class="p">.</span><span class="nx">b</span> <span class="o">+=</span> <span class="mi">150</span>
      <span class="nx">slider</span><span class="p">.</span><span class="nx">setHeight</span> <span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">MorphicPreferences</span><span class="p">.</span><span class="nx">prompterSliderSize</span>
      <span class="k">if</span> <span class="nx">isRounded</span>
        <span class="nv">slider.action = </span><span class="nf">(num) -&gt;</span>
          <span class="nx">entryField</span><span class="p">.</span><span class="nx">changed</span><span class="p">()</span>
          <span class="nv">entryField.text.text = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">num</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
          <span class="nx">entryField</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">updateRendering</span><span class="p">()</span>
          <span class="nx">entryField</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">changed</span><span class="p">()</span>
          <span class="nx">entryField</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">edit</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nv">slider.action = </span><span class="nf">(num) -&gt;</span>
          <span class="nx">entryField</span><span class="p">.</span><span class="nx">changed</span><span class="p">()</span>
          <span class="nv">entryField.text.text = </span><span class="nx">num</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
          <span class="nx">entryField</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">updateRendering</span><span class="p">()</span>
          <span class="nx">entryField</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">changed</span><span class="p">()</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">slider</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span> <span class="mi">2</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;Ok&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="nx">entryField</span><span class="p">.</span><span class="nx">string</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;Cancel&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">menu.isDraggable = </span><span class="kc">true</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">popUpAtHand</span> <span class="nx">@world</span><span class="p">()</span>
    <span class="nx">entryField</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">edit</span><span class="p">()</span>
  
  <span class="nv">pickColor: </span><span class="nf">(msg, callback, environment, defaultContents) -&gt;</span>
    <span class="nv">menu = </span><span class="k">new</span> <span class="nx">MenuMorph</span><span class="p">(</span><span class="nx">callback</span> <span class="o">or</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">environment</span> <span class="o">or</span> <span class="kc">null</span><span class="p">)</span>
    <span class="nv">colorPicker = </span><span class="k">new</span> <span class="nx">ColorPickerMorph</span><span class="p">(</span><span class="nx">defaultContents</span><span class="p">)</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">colorPicker</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span> <span class="mi">2</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;Ok&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="nx">colorPicker</span><span class="p">.</span><span class="nx">getChoice</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;Cancel&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">menu.isDraggable = </span><span class="kc">true</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">popUpAtHand</span> <span class="nx">@world</span><span class="p">()</span>

  <span class="nv">inspect: </span><span class="nf">(anotherObject) -&gt;</span>
    <span class="nv">inspectee = </span><span class="nx">@</span>
    <span class="nv">inspectee = </span><span class="nx">anotherObject</span>  <span class="k">if</span> <span class="nx">anotherObject</span>
    <span class="nx">@spawnInspector</span> <span class="nx">inspectee</span>

  <span class="nv">spawnInspector: </span><span class="nf">(inspectee) -&gt;</span>
    <span class="nv">inspector = </span><span class="k">new</span> <span class="nx">InspectorMorph</span><span class="p">(</span><span class="nx">inspectee</span><span class="p">)</span>
    <span class="nv">world = </span><span class="p">(</span><span class="k">if</span> <span class="nx">@world</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="k">then</span> <span class="nx">@world</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="nx">@root</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@world</span><span class="p">))</span>
    <span class="nx">inspector</span><span class="p">.</span><span class="nx">setPosition</span> <span class="nx">world</span><span class="p">.</span><span class="nx">hand</span><span class="p">.</span><span class="nx">position</span><span class="p">()</span>
    <span class="nx">inspector</span><span class="p">.</span><span class="nx">keepWithin</span> <span class="nx">world</span>
    <span class="nx">world</span><span class="p">.</span><span class="nx">add</span> <span class="nx">inspector</span>
    <span class="nx">inspector</span><span class="p">.</span><span class="nx">changed</span><span class="p">()</span>
    
  </pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Morph menus ////////////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">contextMenu: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="nx">@customContextMenu</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">@customContextMenu</span>
    <span class="nv">world = </span><span class="p">(</span><span class="k">if</span> <span class="nx">@world</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="k">then</span> <span class="nx">@world</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="nx">@root</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@world</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">world</span> <span class="o">and</span> <span class="nx">world</span><span class="p">.</span><span class="nx">isDevMode</span>
      <span class="k">return</span> <span class="nx">@developersMenu</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">@parent</span> <span class="o">is</span> <span class="nx">world</span>
      <span class="k">return</span> <span class="nx">@hierarchyMenu</span><span class="p">()</span>
    <span class="nx">@userMenu</span><span class="p">()</span> <span class="o">or</span> <span class="p">(</span><span class="nx">@parent</span> <span class="o">and</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">userMenu</span><span class="p">())</span>
  
  <span class="nv">hierarchyMenu: </span><span class="nf">-&gt;</span>
    <span class="nv">parents = </span><span class="nx">@allParents</span><span class="p">()</span>
    <span class="nv">world = </span><span class="p">(</span><span class="k">if</span> <span class="nx">@world</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="k">then</span> <span class="nx">@world</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="nx">@root</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@world</span><span class="p">))</span>
    <span class="nv">menu = </span><span class="k">new</span> <span class="nx">MenuMorph</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>show all the entries of all the developers menus of all
the parents.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">parents</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(each) -&gt;</span>
      <span class="k">if</span> <span class="nx">each</span><span class="p">.</span><span class="nx">developersMenu</span> <span class="o">and</span> <span class="p">(</span><span class="nx">each</span> <span class="o">isnt</span> <span class="nx">world</span><span class="p">)</span>
        <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="nx">each</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="nf">-&gt;</span>
          <span class="nx">each</span><span class="p">.</span><span class="nx">developersMenu</span><span class="p">().</span><span class="nx">popUpAtHand</span> <span class="nx">@world</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">menu</span>
  
  <span class="nv">developersMenu: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>'name' is not an official property of a function, hence:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">world = </span><span class="p">(</span><span class="k">if</span> <span class="nx">@world</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="k">then</span> <span class="nx">@world</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="nx">@root</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@world</span><span class="p">))</span>
    <span class="nv">userMenu = </span><span class="nx">@userMenu</span><span class="p">()</span> <span class="o">or</span> <span class="p">(</span><span class="nx">@parent</span> <span class="o">and</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">userMenu</span><span class="p">())</span>
    <span class="nv">menu = </span><span class="k">new</span> <span class="nx">MenuMorph</span><span class="p">(</span>
      <span class="nx">@</span><span class="p">,</span>
      <span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">or</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">userMenu</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;user features...&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
        <span class="nx">userMenu</span><span class="p">.</span><span class="nx">popUpAtHand</span> <span class="nx">@world</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span><span class="p">()</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;color...&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nf">-&gt;</span>
      <span class="nx">@pickColor</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;\ncolor:&quot;</span><span class="p">,</span> <span class="nx">@setColor</span><span class="p">,</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">@color</span>
    <span class="p">),</span> <span class="s">&quot;choose another color \nfor this morph&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;transparency...&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nf">-&gt;</span>
      <span class="nx">@prompt</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;\nalpha\nvalue:&quot;</span><span class="p">,</span>
        <span class="nx">@setAlphaScaled</span><span class="p">,</span> <span class="nx">@</span><span class="p">,</span> <span class="p">(</span><span class="nx">@alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="mi">100</span><span class="p">,</span>
        <span class="kc">true</span>
    <span class="p">),</span> <span class="s">&quot;set this morph&#39;s\nalpha value&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;resize...&quot;</span><span class="p">,</span> <span class="s">&quot;resize&quot;</span><span class="p">,</span> <span class="s">&quot;show a handle\nwhich can be dragged\nto change this morph&#39;s&quot;</span> <span class="o">+</span> <span class="s">&quot; extent&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span><span class="p">()</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;duplicate&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nf">-&gt;</span>
      <span class="nx">@fullCopy</span><span class="p">().</span><span class="nx">pickUp</span> <span class="nx">@world</span><span class="p">()</span>
    <span class="p">),</span> <span class="s">&quot;make a copy\nand pick it up&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;pick up&quot;</span><span class="p">,</span> <span class="s">&quot;pickUp&quot;</span><span class="p">,</span> <span class="s">&quot;disattach and put \ninto the hand&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;attach...&quot;</span><span class="p">,</span> <span class="s">&quot;attach&quot;</span><span class="p">,</span> <span class="s">&quot;stick this morph\nto another one&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;move...&quot;</span><span class="p">,</span> <span class="s">&quot;move&quot;</span><span class="p">,</span> <span class="s">&quot;show a handle\nwhich can be dragged\nto move this morph&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;inspect...&quot;</span><span class="p">,</span> <span class="s">&quot;inspect&quot;</span><span class="p">,</span> <span class="s">&quot;open a window\non all properties&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;pic...&quot;</span><span class="p">,</span> <span class="p">(()</span><span class="nf">-&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">@fullImageData</span><span class="p">())),</span> <span class="s">&quot;open a new window\nwith a picture of this morph&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@isDraggable</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;lock&quot;</span><span class="p">,</span> <span class="s">&quot;toggleIsDraggable&quot;</span><span class="p">,</span> <span class="s">&quot;make this morph\nunmovable&quot;</span>
    <span class="k">else</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;unlock&quot;</span><span class="p">,</span> <span class="s">&quot;toggleIsDraggable&quot;</span><span class="p">,</span> <span class="s">&quot;make this morph\nmovable&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;hide&quot;</span><span class="p">,</span> <span class="s">&quot;hide&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;delete&quot;</span><span class="p">,</span> <span class="s">&quot;destroy&quot;</span>
    <span class="k">unless</span> <span class="nx">@</span> <span class="k">instanceof</span> <span class="nx">WorldMorph</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span><span class="p">()</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;World...&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nf">-&gt;</span>
        <span class="nx">world</span><span class="p">.</span><span class="nx">contextMenu</span><span class="p">().</span><span class="nx">popUpAtHand</span> <span class="nx">@world</span><span class="p">()</span>
      <span class="p">),</span> <span class="s">&quot;show the\nWorld&#39;s menu&quot;</span>
    <span class="nx">menu</span>
  
  <span class="nv">userMenu: </span><span class="nf">-&gt;</span>
    <span class="kc">null</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Morph menu actions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">calculateAlphaScaled: </span><span class="nf">(alpha) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">alpha</span> <span class="o">is</span> <span class="s">&quot;number&quot;</span>
      <span class="nv">unscaled = </span><span class="nx">alpha</span> <span class="o">/</span> <span class="mi">100</span>
      <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">unscaled</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">newAlpha = </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">alpha</span><span class="p">)</span>
      <span class="k">unless</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">newAlpha</span><span class="p">)</span>
        <span class="nv">unscaled = </span><span class="nx">newAlpha</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">unscaled</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

  <span class="nv">setAlphaScaled: </span><span class="nf">(alpha) -&gt;</span>
    <span class="vi">@alpha = </span><span class="nx">@calculateAlphaScaled</span><span class="p">(</span><span class="nx">alpha</span><span class="p">)</span>
    <span class="nx">@changed</span><span class="p">()</span>
  
  <span class="nv">attach: </span><span class="nf">-&gt;</span>
    <span class="nv">choices = </span><span class="nx">@overlappedMorphs</span><span class="p">()</span>
    <span class="nv">menu = </span><span class="k">new</span> <span class="nx">MenuMorph</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="s">&quot;choose new parent:&quot;</span><span class="p">)</span>
    <span class="nx">choices</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(each) =&gt;</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="nx">each</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="o">=&gt;</span>
        <span class="nx">each</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@</span>
        <span class="vi">@isDraggable = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">menu</span><span class="p">.</span><span class="nx">popUpAtHand</span> <span class="nx">@world</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">choices</span><span class="p">.</span><span class="nx">length</span>
  
  <span class="nv">toggleIsDraggable: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>for context menu demo purposes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@isDraggable = </span><span class="o">not</span> <span class="nx">@isDraggable</span>
  
  <span class="nv">colorSetters: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>for context menu demo purposes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="s">&quot;color&quot;</span><span class="p">]</span>
  
  <span class="nv">numericalSetters: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>for context menu demo purposes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="s">&quot;setLeft&quot;</span><span class="p">,</span> <span class="s">&quot;setTop&quot;</span><span class="p">,</span> <span class="s">&quot;setWidth&quot;</span><span class="p">,</span> <span class="s">&quot;setHeight&quot;</span><span class="p">,</span> <span class="s">&quot;setAlphaScaled&quot;</span><span class="p">]</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Morph entry field tabbing //////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">allEntryFields: </span><span class="nf">-&gt;</span>
    <span class="nx">@allChildren</span><span class="p">().</span><span class="nx">filter</span> <span class="nf">(each) -&gt;</span>
      <span class="nx">each</span><span class="p">.</span><span class="nx">isEditable</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">each</span> <span class="k">instanceof</span> <span class="nx">StringMorph</span> <span class="o">||</span> <span class="nx">each</span> <span class="k">instanceof</span> <span class="nx">TextMorph</span><span class="p">);</span>
  
  
  <span class="nv">nextEntryField: </span><span class="nf">(current) -&gt;</span>
    <span class="nv">fields = </span><span class="nx">@allEntryFields</span><span class="p">()</span>
    <span class="nv">idx = </span><span class="nx">fields</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">if</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  
  <span class="nv">previousEntryField: </span><span class="nf">(current) -&gt;</span>
    <span class="nv">fields = </span><span class="nx">@allEntryFields</span><span class="p">()</span>
    <span class="nv">idx = </span><span class="nx">fields</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">if</span> <span class="nx">idx</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">fields</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  
  <span class="nv">tab: </span><span class="nf">(editField) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>the <tab> key was pressed in one of my edit fields.
invoke my "nextTab()" function if it exists, else
propagate it up my owner chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@nextTab</span>
      <span class="nx">@nextTab</span> <span class="nx">editField</span>
    <span class="k">else</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">tab</span> <span class="nx">editField</span>  <span class="k">if</span> <span class="nx">@parent</span>
  
  <span class="nv">backTab: </span><span class="nf">(editField) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>the <back tab> key was pressed in one of my edit fields.
invoke my "previousTab()" function if it exists, else
propagate it up my owner chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@previousTab</span>
      <span class="nx">@previousTab</span> <span class="nx">editField</span>
    <span class="k">else</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">backTab</span> <span class="nx">editField</span>  <span class="k">if</span> <span class="nx">@parent</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>the following are examples of what the navigation methods should
look like. Insert these at the World level for fallback, and at lower
levels in the Morphic tree (e.g. dialog boxes) for a more fine-grained
control over the tabbing cycle.</p>

<p>Morph.prototype.nextTab = function (editField) {
var    next = this.nextEntryField(editField);
editField.clearSelection();
next.selectAll();
next.edit();
};</p>

<p>Morph.prototype.previousTab = function (editField) {
var    prev = this.previousEntryField(editField);
editField.clearSelection();
prev.selectAll();
prev.edit();
};</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Morph events:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">escalateEvent: </span><span class="nf">(functionName, arg) -&gt;</span>
    <span class="nv">handler = </span><span class="nx">@parent</span>
    <span class="nv">handler = </span><span class="nx">handler</span><span class="p">.</span><span class="nx">parent</span>  <span class="k">while</span> <span class="o">not</span> <span class="nx">handler</span><span class="p">[</span><span class="nx">functionName</span><span class="p">]</span> <span class="o">and</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">parent</span><span class="o">?</span>
    <span class="nx">handler</span><span class="p">[</span><span class="nx">functionName</span><span class="p">]</span> <span class="nx">arg</span>  <span class="k">if</span> <span class="nx">handler</span><span class="p">[</span><span class="nx">functionName</span><span class="p">]</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Morph eval. Used by the Inspector and the TextMorph.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">evaluateString: </span><span class="nf">(code) -&gt;</span>
    <span class="k">try</span>
      <span class="nv">result = </span><span class="nb">eval</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
      <span class="nx">@updateRendering</span><span class="p">()</span>
      <span class="nx">@changed</span><span class="p">()</span>
    <span class="k">catch</span> <span class="nx">err</span>
      <span class="nx">@inform</span> <span class="nx">err</span>
    <span class="nx">result</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Morph collision detection - not used anywhere at the moment ////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">isTouching: </span><span class="nf">(otherMorph) -&gt;</span>
    <span class="nv">oImg = </span><span class="nx">@overlappingImage</span><span class="p">(</span><span class="nx">otherMorph</span><span class="p">)</span>
    <span class="nv">data = </span><span class="nx">oImg</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">).</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">oImg</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">oImg</span><span class="p">.</span><span class="nx">height</span><span class="p">).</span><span class="nx">data</span>
    <span class="nx">detect</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(each) -&gt;</span>
      <span class="nx">each</span> <span class="o">isnt</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">isnt</span> <span class="kc">null</span>
  
  <span class="nv">overlappingImage: </span><span class="nf">(otherMorph) -&gt;</span>
    <span class="nv">fb = </span><span class="nx">@boundsIncludingChildren</span><span class="p">()</span>
    <span class="nv">otherFb = </span><span class="nx">otherMorph</span><span class="p">.</span><span class="nx">boundsIncludingChildren</span><span class="p">()</span>
    <span class="nv">oRect = </span><span class="nx">fb</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">otherFb</span><span class="p">)</span>
    <span class="nv">oImg = </span><span class="nx">newCanvas</span><span class="p">(</span><span class="nx">oRect</span><span class="p">.</span><span class="nx">extent</span><span class="p">())</span>
    <span class="nv">ctx = </span><span class="nx">oImg</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">newCanvas</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="k">if</span> <span class="nx">oRect</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">oRect</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@fullImage</span><span class="p">(),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">oRect</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">oRect</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nv">ctx.globalCompositeOperation = </span><span class="s">&quot;source-in&quot;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">otherMorph</span><span class="p">.</span><span class="nx">fullImage</span><span class="p">(),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">otherFb</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">oRect</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">otherFb</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">oRect</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nx">oImg</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 