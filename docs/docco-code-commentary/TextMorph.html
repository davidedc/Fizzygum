<!DOCTYPE html>  <html> <head>   <title>TextMorph.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="BlinkerMorph.html">                 BlinkerMorph.coffee               </a>                                           <a class="source" href="BouncerMorph.html">                 BouncerMorph.coffee               </a>                                           <a class="source" href="BoxMorph.html">                 BoxMorph.coffee               </a>                                           <a class="source" href="CaretMorph.html">                 CaretMorph.coffee               </a>                                           <a class="source" href="CircleBoxMorph.html">                 CircleBoxMorph.coffee               </a>                                           <a class="source" href="CloseCircleButtonMorph.html">                 CloseCircleButtonMorph.coffee               </a>                                           <a class="source" href="Color.html">                 Color.coffee               </a>                                           <a class="source" href="ColorPaletteMorph.html">                 ColorPaletteMorph.coffee               </a>                                           <a class="source" href="ColorPickerMorph.html">                 ColorPickerMorph.coffee               </a>                                           <a class="source" href="FrameMorph.html">                 FrameMorph.coffee               </a>                                           <a class="source" href="GrayPaletteMorph.html">                 GrayPaletteMorph.coffee               </a>                                           <a class="source" href="HandMorph.html">                 HandMorph.coffee               </a>                                           <a class="source" href="HandleMorph.html">                 HandleMorph.coffee               </a>                                           <a class="source" href="InspectorMorph.html">                 InspectorMorph.coffee               </a>                                           <a class="source" href="ListMorph.html">                 ListMorph.coffee               </a>                                           <a class="source" href="MenuItemMorph.html">                 MenuItemMorph.coffee               </a>                                           <a class="source" href="MenuMorph.html">                 MenuMorph.coffee               </a>                                           <a class="source" href="Morph.html">                 Morph.coffee               </a>                                           <a class="source" href="MorphicNode.html">                 MorphicNode.coffee               </a>                                           <a class="source" href="MorphsListMorph.html">                 MorphsListMorph.coffee               </a>                                           <a class="source" href="MouseSensorMorph.html">                 MouseSensorMorph.coffee               </a>                                           <a class="source" href="Mousetrap.html">                 Mousetrap.coffee               </a>                                           <a class="source" href="PenMorph.html">                 PenMorph.coffee               </a>                                           <a class="source" href="Point.html">                 Point.coffee               </a>                                           <a class="source" href="Point2.html">                 Point2.coffee               </a>                                           <a class="source" href="Rectangle.html">                 Rectangle.coffee               </a>                                           <a class="source" href="RectangleMorph.html">                 RectangleMorph.coffee               </a>                                           <a class="source" href="ScrollFrameMorph.html">                 ScrollFrameMorph.coffee               </a>                                           <a class="source" href="ShadowMorph.html">                 ShadowMorph.coffee               </a>                                           <a class="source" href="SliderButtonMorph.html">                 SliderButtonMorph.coffee               </a>                                           <a class="source" href="SliderMorph.html">                 SliderMorph.coffee               </a>                                           <a class="source" href="SpeechBubbleMorph.html">                 SpeechBubbleMorph.coffee               </a>                                           <a class="source" href="StringFieldMorph.html">                 StringFieldMorph.coffee               </a>                                           <a class="source" href="StringMorph.html">                 StringMorph.coffee               </a>                                           <a class="source" href="SystemTest_SimpleMenuTest.html">                 SystemTest_SimpleMenuTest.coffee               </a>                                           <a class="source" href="SystemTestsRecorderAndPlayer.html">                 SystemTestsRecorderAndPlayer.coffee               </a>                                           <a class="source" href="TextMorph.html">                 TextMorph.coffee               </a>                                           <a class="source" href="TriggerMorph.html">                 TriggerMorph.coffee               </a>                                           <a class="source" href="WorkspaceMorph.html">                 WorkspaceMorph.coffee               </a>                                           <a class="source" href="WorldMorph.html">                 WorldMorph.coffee               </a>                                           <a class="source" href="globalFunctions.html">                 globalFunctions.coffee               </a>                                           <a class="source" href="globalSettings.html">                 globalSettings.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               TextMorph.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>TextMorph ///////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>I am a multi-line, word-wrapping String</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Note that in the original Jens' Morphic.js version he
has made this quasi-inheriting from StringMorph i.e. he is copying
over manually the following methods like so:</p>

<p>TextMorph::font = StringMorph::font
 TextMorph::edit = StringMorph::edit
 TextMorph::selection = StringMorph::selection
 TextMorph::selectionStartSlot = StringMorph::selectionStartSlot
 TextMorph::clearSelection = StringMorph::clearSelection
 TextMorph::deleteSelection = StringMorph::deleteSelection
 TextMorph::selectAll = StringMorph::selectAll
 TextMorph::mouseClickLeft = StringMorph::mouseClickLeft
 TextMorph::enableSelecting = StringMorph::enableSelecting 
 TextMorph::disableSelecting = StringMorph::disableSelecting
 TextMorph::toggleIsDraggable = StringMorph::toggleIsDraggable
 TextMorph::toggleWeight = StringMorph::toggleWeight
 TextMorph::toggleItalic = StringMorph::toggleItalic
 TextMorph::setSerif = StringMorph::setSerif
 TextMorph::setSansSerif = StringMorph::setSansSerif
 TextMorph::setText = StringMorph::setText
 TextMorph::setFontSize = StringMorph::setFontSize
 TextMorph::numericalSetters = StringMorph::numericalSetters</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">TextMorph</span> <span class="k">extends</span> <span class="nx">StringMorph</span>

  <span class="nv">words: </span><span class="p">[]</span>
  <span class="nv">lines: </span><span class="p">[]</span>
  <span class="nv">lineSlots: </span><span class="p">[]</span>
  <span class="nv">alignment: </span><span class="kc">null</span>
  <span class="nv">maxWidth: </span><span class="kc">null</span>
  <span class="nv">maxLineWidth: </span><span class="mi">0</span>
  <span class="nv">backgroundColor: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>additional properties for ad-hoc evaluation:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">receiver: </span><span class="kc">null</span>

  <span class="nv">constructor: </span><span class="nf">(</span>
<span class="nf">    text, @fontSize = 12, @fontStyle = &quot;sans-serif&quot;, @isBold = false,</span>
<span class="nf">    @isItalic = false, @alignment = &quot;left&quot;, @maxWidth = 0, fontName, shadowOffset,</span>
<span class="nf">    @shadowColor = null</span>
<span class="nf">    ) -&gt;</span>
      <span class="k">super</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>override inherited properites:</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@markedTextColor = </span><span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
      <span class="vi">@markedBackgoundColor = </span><span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
      <span class="vi">@text = </span><span class="nx">text</span> <span class="o">or</span> <span class="p">((</span><span class="k">if</span> <span class="nx">text</span> <span class="o">is</span> <span class="s">&quot;&quot;</span> <span class="k">then</span> <span class="nx">text</span> <span class="k">else</span> <span class="s">&quot;TextMorph&quot;</span><span class="p">))</span>
      <span class="vi">@fontName = </span><span class="nx">fontName</span> <span class="o">or</span> <span class="nx">WorldMorph</span><span class="p">.</span><span class="nx">MorphicPreferences</span><span class="p">.</span><span class="nx">globalFontFamily</span>
      <span class="vi">@shadowOffset = </span><span class="nx">shadowOffset</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="vi">@color = </span><span class="k">new</span> <span class="nx">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="vi">@noticesTransparentClick = </span><span class="kc">true</span>
      <span class="nx">@updateRendering</span><span class="p">()</span>
  
  <span class="nv">breakTextIntoLines: </span><span class="nf">-&gt;</span>
    <span class="nv">paragraphs = </span><span class="nx">@text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
    <span class="nv">canvas = </span><span class="nx">newCanvas</span><span class="p">()</span>
    <span class="nv">context = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nv">currentLine = </span><span class="s">&quot;&quot;</span>
    <span class="nv">slot = </span><span class="mi">0</span>
    <span class="nv">context.font = </span><span class="nx">@font</span><span class="p">()</span>
    <span class="vi">@maxLineWidth = </span><span class="mi">0</span>
    <span class="vi">@lines = </span><span class="p">[]</span>
    <span class="vi">@lineSlots = </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="vi">@words = </span><span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>put all the text in an array, word by word</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">paragraphs</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(p) =&gt;</span>
      <span class="vi">@words = </span><span class="nx">@words</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">))</span>
      <span class="nx">@words</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>takes the text, word by word, and re-flows
it according to the available width for the
text (if there is such limit).
The end result is an array of lines
called @lines, which contains the string for
each line (excluding the end of lines).
Also another array is created, called
@lineSlots, which memorises how many characters
of the text have been consumed up to each line
 example: original text: "Hello\nWorld"
then @lines[0] = "Hello" @lines[1] = "World"
and @lineSlots[0] = 6, @lineSlots[1] = 11
Note that this algorithm doesn't work in case
of single non-spaced words that are longer than
the allowed width.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@words</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(word) =&gt;</span>
      <span class="k">if</span> <span class="nx">word</span> <span class="o">is</span> <span class="s">&quot;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>we reached the end of the line in the
original text, so push the line and the
slots count in the arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@lines</span><span class="p">.</span><span class="nx">push</span> <span class="nx">currentLine</span>
        <span class="nx">@lineSlots</span><span class="p">.</span><span class="nx">push</span> <span class="nx">slot</span>
        <span class="vi">@maxLineWidth = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@maxLineWidth</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">currentLine</span><span class="p">).</span><span class="nx">width</span><span class="p">)</span>
        <span class="nv">currentLine = </span><span class="s">&quot;&quot;</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">@maxWidth</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>there is a width limit, so we need
to check whether we overflowed it. So create
a prospective line and then check its width.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">lineForOverflowTest = </span><span class="nx">currentLine</span> <span class="o">+</span> <span class="nx">word</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
          <span class="nv">w = </span><span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">lineForOverflowTest</span><span class="p">).</span><span class="nx">width</span>
          <span class="k">if</span> <span class="nx">w</span> <span class="o">&gt;</span> <span class="nx">@maxWidth</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>ok we just overflowed the available space,
so we need to push the old line and its
"slot" number to the respective arrays.
the new line is going to only contain the
word that has caused the overflow.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">@lines</span><span class="p">.</span><span class="nx">push</span> <span class="nx">currentLine</span>
            <span class="nx">@lineSlots</span><span class="p">.</span><span class="nx">push</span> <span class="nx">slot</span>
            <span class="vi">@maxLineWidth = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@maxLineWidth</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">currentLine</span><span class="p">).</span><span class="nx">width</span><span class="p">)</span>
            <span class="nv">currentLine = </span><span class="nx">word</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
          <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>no overflow happened, so just proceed as normal</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">currentLine = </span><span class="nx">lineForOverflowTest</span>
        <span class="k">else</span>
          <span class="nv">currentLine = </span><span class="nx">currentLine</span> <span class="o">+</span> <span class="nx">word</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
        <span class="nx">slot</span> <span class="o">+=</span> <span class="nx">word</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
  
  
  <span class="nv">updateRendering: </span><span class="nf">-&gt;</span>
    <span class="vi">@image = </span><span class="nx">newCanvas</span><span class="p">()</span>
    <span class="nv">context = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nv">context.font = </span><span class="nx">@font</span><span class="p">()</span>
    <span class="nx">@breakTextIntoLines</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>set my extent</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">shadowWidth = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
    <span class="nv">shadowHeight = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nv">height = </span><span class="nx">@lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="p">(</span><span class="nx">fontHeight</span><span class="p">(</span><span class="nx">@fontSize</span><span class="p">)</span> <span class="o">+</span> <span class="nx">shadowHeight</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@maxWidth</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="vi">@bounds = </span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@maxLineWidth</span> <span class="o">+</span> <span class="nx">shadowWidth</span><span class="p">,</span> <span class="nx">height</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="vi">@bounds = </span><span class="nx">@bounds</span><span class="p">.</span><span class="nx">origin</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">@maxWidth</span> <span class="o">+</span> <span class="nx">shadowWidth</span><span class="p">,</span> <span class="nx">height</span><span class="p">))</span>
    <span class="vi">@image.width = </span><span class="nx">@width</span><span class="p">()</span>
    <span class="vi">@image.height = </span><span class="nx">@height</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>changing the canvas size resets many of
the properties of the canvas, so we need to
re-initialise the font and alignments here</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">context.font = </span><span class="nx">@font</span><span class="p">()</span>
    <span class="nv">context.textAlign = </span><span class="s">&quot;left&quot;</span>
    <span class="nv">context.textBaseline = </span><span class="s">&quot;bottom&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>fill the background, if desired</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@backgroundColor</span>
      <span class="nv">context.fillStyle = </span><span class="nx">@backgroundColor</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@width</span><span class="p">(),</span> <span class="nx">@height</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>draw the shadow, if any</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@shadowColor</span>
      <span class="nv">offx = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nv">offy = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>console.log 'shadow x: ' + offx + " y: " + offy</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">context.fillStyle = </span><span class="nx">@shadowColor</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nv">i = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">@lines</span>
        <span class="nv">width = </span><span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">line</span><span class="p">).</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">shadowWidth</span>
        <span class="k">if</span> <span class="nx">@alignment</span> <span class="o">is</span> <span class="s">&quot;right&quot;</span>
          <span class="nv">x = </span><span class="nx">@width</span><span class="p">()</span> <span class="o">-</span> <span class="nx">width</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">@alignment</span> <span class="o">is</span> <span class="s">&quot;center&quot;</span>
          <span class="nv">x = </span><span class="p">(</span><span class="nx">@width</span><span class="p">()</span> <span class="o">-</span> <span class="nx">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span> <span class="c1"># &#39;left&#39;</span>
          <span class="nv">x = </span><span class="mi">0</span>
        <span class="nv">y = </span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">fontHeight</span><span class="p">(</span><span class="nx">@fontSize</span><span class="p">)</span> <span class="o">+</span> <span class="nx">shadowHeight</span><span class="p">)</span> <span class="o">-</span> <span class="nx">shadowHeight</span>
        <span class="nx">i</span><span class="o">++</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">offx</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">offy</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>now draw the actual text</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">offx = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="nv">offy = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>console.log 'maintext x: ' + offx + " y: " + offy</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">context.fillStyle = </span><span class="nx">@color</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nv">i = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">@lines</span>
      <span class="nv">width = </span><span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">line</span><span class="p">).</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">shadowWidth</span>
      <span class="k">if</span> <span class="nx">@alignment</span> <span class="o">is</span> <span class="s">&quot;right&quot;</span>
        <span class="nv">x = </span><span class="nx">@width</span><span class="p">()</span> <span class="o">-</span> <span class="nx">width</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">@alignment</span> <span class="o">is</span> <span class="s">&quot;center&quot;</span>
        <span class="nv">x = </span><span class="p">(</span><span class="nx">@width</span><span class="p">()</span> <span class="o">-</span> <span class="nx">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
      <span class="k">else</span> <span class="c1"># &#39;left&#39;</span>
        <span class="nv">x = </span><span class="mi">0</span>
      <span class="nv">y = </span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">fontHeight</span><span class="p">(</span><span class="nx">@fontSize</span><span class="p">)</span> <span class="o">+</span> <span class="nx">shadowHeight</span><span class="p">)</span> <span class="o">-</span> <span class="nx">shadowHeight</span>
      <span class="nx">i</span><span class="o">++</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">offx</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">offy</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Draw the selection. This is done by re-drawing the
selected text, one character at the time, just with
a background rectangle.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">start = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">@startMark</span><span class="p">,</span> <span class="nx">@endMark</span><span class="p">)</span>
    <span class="nv">stop = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">@startMark</span><span class="p">,</span> <span class="nx">@endMark</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">start</span><span class="p">...</span><span class="nx">stop</span><span class="p">]</span>
      <span class="nv">p = </span><span class="nx">@slotCoordinates</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@position</span><span class="p">())</span>
      <span class="nv">c = </span><span class="nx">@text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
      <span class="nv">context.fillStyle = </span><span class="nx">@markedBackgoundColor</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">fontHeight</span><span class="p">(</span><span class="nx">@fontSize</span><span class="p">)</span>
      <span class="nv">context.fillStyle = </span><span class="nx">@markedTextColor</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">fontHeight</span><span class="p">(</span><span class="nx">@fontSize</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>notify my parent of layout change</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@parent</span><span class="p">.</span><span class="nx">layoutChanged</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">layoutChanged</span>  <span class="k">if</span> <span class="nx">@parent</span>
  
  <span class="nv">setExtent: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="vi">@maxWidth = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">aPoint</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">@changed</span><span class="p">()</span>
    <span class="nx">@updateRendering</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>TextMorph measuring ////</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>answer the logical position point of the given index ("slot")
i.e. the row and the column where a particular character is.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">slotRowAndColumn: </span><span class="nf">(slot) -&gt;</span>
    <span class="nv">idx = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Note that this solution scans all the characters
in all the rows up to the slot. This could be
done a lot quicker by stopping at the first row
such that @lineSlots[theRow] &lt;= slot
You could even do a binary search if one really
wanted to, because the contents of @lineSlots are
in order, as they contain a cumulative count...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">row</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@lines</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nv">idx = </span><span class="nx">@lineSlots</span><span class="p">[</span><span class="nx">row</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">col</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@lines</span><span class="p">[</span><span class="nx">row</span><span class="p">].</span><span class="nx">length</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">]</span>  <span class="k">if</span> <span class="nx">idx</span> <span class="o">is</span> <span class="nx">slot</span>
        <span class="nx">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">[</span><span class="nx">@lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">@lines</span><span class="p">[</span><span class="nx">@lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Answer the position (in pixels) of the given index ("slot")
where the caret should be placed.
This is in absolute world coordinates.
This function assumes that the text is left-justified.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">slotCoordinates: </span><span class="nf">(slot) -&gt;</span>
    <span class="p">[</span><span class="nx">slotRow</span><span class="p">,</span> <span class="nx">slotColumn</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@slotRowAndColumn</span><span class="p">(</span><span class="nx">slot</span><span class="p">)</span>
    <span class="nv">context = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nv">shadowHeight = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nv">yOffset = </span><span class="nx">slotRow</span> <span class="o">*</span> <span class="p">(</span><span class="nx">fontHeight</span><span class="p">(</span><span class="nx">@fontSize</span><span class="p">)</span> <span class="o">+</span> <span class="nx">shadowHeight</span><span class="p">)</span>
    <span class="nv">xOffset = </span><span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">((</span><span class="nx">@lines</span><span class="p">[</span><span class="nx">slotRow</span><span class="p">]).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">slotColumn</span><span class="p">)).</span><span class="nx">width</span>
    <span class="nv">x = </span><span class="nx">@left</span><span class="p">()</span> <span class="o">+</span> <span class="nx">xOffset</span>
    <span class="nv">y = </span><span class="nx">@top</span><span class="p">()</span> <span class="o">+</span> <span class="nx">yOffset</span>
    <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Returns the slot (index) closest to the given point
so the caret can be moved accordingly
This function assumes that the text is left-justified.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">slotAt: </span><span class="nf">(aPoint) -&gt;</span>
    <span class="nv">charX = </span><span class="mi">0</span>
    <span class="nv">row = </span><span class="mi">0</span>
    <span class="nv">col = </span><span class="mi">0</span>
    <span class="nv">shadowHeight = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">@shadowOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="nv">context = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nx">row</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="k">while</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@top</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">((</span><span class="nx">fontHeight</span><span class="p">(</span><span class="nx">@fontSize</span><span class="p">)</span> <span class="o">+</span> <span class="nx">shadowHeight</span><span class="p">)</span> <span class="o">*</span> <span class="nx">row</span><span class="p">)</span>
    <span class="nv">row = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">while</span> <span class="nx">aPoint</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@left</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">charX</span>
      <span class="nx">charX</span> <span class="o">+=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">@lines</span><span class="p">[</span><span class="nx">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="nx">col</span><span class="p">]).</span><span class="nx">width</span>
      <span class="nx">col</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nx">@lineSlots</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">+</span> <span class="nx">col</span> <span class="o">-</span> <span class="mi">1</span>
  
  <span class="nv">upFrom: </span><span class="nf">(slot) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>answer the slot above the given one</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">slotRow</span><span class="p">,</span> <span class="nx">slotColumn</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@slotRowAndColumn</span><span class="p">(</span><span class="nx">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">slot</span>  <span class="k">if</span> <span class="nx">slotRow</span> <span class="o">&lt;</span> <span class="mi">1</span>
    <span class="nv">above = </span><span class="nx">@lines</span><span class="p">[</span><span class="nx">slotRow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@lineSlots</span><span class="p">[</span><span class="nx">slotRow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">above</span><span class="p">.</span><span class="nx">length</span>  <span class="k">if</span> <span class="nx">above</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">slotColumn</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nx">@lineSlots</span><span class="p">[</span><span class="nx">slotRow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">slotColumn</span>
  
  <span class="nv">downFrom: </span><span class="nf">(slot) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>answer the slot below the given one</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">slotRow</span><span class="p">,</span> <span class="nx">slotColumn</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@slotRowAndColumn</span><span class="p">(</span><span class="nx">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">slot</span>  <span class="k">if</span> <span class="nx">slotRow</span> <span class="o">&gt;</span> <span class="nx">@lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="nv">below = </span><span class="nx">@lines</span><span class="p">[</span><span class="nx">slotRow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@lineSlots</span><span class="p">[</span><span class="nx">slotRow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">below</span><span class="p">.</span><span class="nx">length</span>  <span class="k">if</span> <span class="nx">below</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">slotColumn</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nx">@lineSlots</span><span class="p">[</span><span class="nx">slotRow</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">slotColumn</span>
  
  <span class="nv">startOfLine: </span><span class="nf">(slot) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>answer the first slot (index) of the line for the given slot</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@lineSlots</span><span class="p">[</span><span class="nx">@slotRowAndColumn</span><span class="p">(</span><span class="nx">slot</span><span class="p">).</span><span class="nx">y</span><span class="p">]</span>
  
  <span class="nv">endOfLine: </span><span class="nf">(slot) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>answer the slot (index) indicating the EOL for the given slot</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@startOfLine</span><span class="p">(</span><span class="nx">slot</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@lines</span><span class="p">[</span><span class="nx">@slotRowAndColumn</span><span class="p">(</span><span class="nx">slot</span><span class="p">).</span><span class="nx">y</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>TextMorph menus:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">developersMenu: </span><span class="nf">-&gt;</span>
    <span class="nv">menu = </span><span class="k">super</span><span class="p">()</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span><span class="p">()</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;edit&quot;</span><span class="p">,</span> <span class="s">&quot;edit&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;font size...&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nf">-&gt;</span>
      <span class="nx">@prompt</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;\nfont\nsize:&quot;</span><span class="p">,</span>
        <span class="nx">@setFontSize</span><span class="p">,</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">@fontSize</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">true</span>
    <span class="p">),</span> <span class="s">&quot;set this Text&#39;s\nfont point size&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;align left&quot;</span><span class="p">,</span> <span class="s">&quot;setAlignmentToLeft&quot;</span>  <span class="k">if</span> <span class="nx">@alignment</span> <span class="o">isnt</span> <span class="s">&quot;left&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;align right&quot;</span><span class="p">,</span> <span class="s">&quot;setAlignmentToRight&quot;</span>  <span class="k">if</span> <span class="nx">@alignment</span> <span class="o">isnt</span> <span class="s">&quot;right&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;align center&quot;</span><span class="p">,</span> <span class="s">&quot;setAlignmentToCenter&quot;</span>  <span class="k">if</span> <span class="nx">@alignment</span> <span class="o">isnt</span> <span class="s">&quot;center&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addLine</span><span class="p">()</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;serif&quot;</span><span class="p">,</span> <span class="s">&quot;setSerif&quot;</span>  <span class="k">if</span> <span class="nx">@fontStyle</span> <span class="o">isnt</span> <span class="s">&quot;serif&quot;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;sans-serif&quot;</span><span class="p">,</span> <span class="s">&quot;setSansSerif&quot;</span>  <span class="k">if</span> <span class="nx">@fontStyle</span> <span class="o">isnt</span> <span class="s">&quot;sans-serif&quot;</span>
    <span class="k">if</span> <span class="nx">@isBold</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;normal weight&quot;</span><span class="p">,</span> <span class="s">&quot;toggleWeight&quot;</span>
    <span class="k">else</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;bold&quot;</span><span class="p">,</span> <span class="s">&quot;toggleWeight&quot;</span>
    <span class="k">if</span> <span class="nx">@isItalic</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;normal style&quot;</span><span class="p">,</span> <span class="s">&quot;toggleItalic&quot;</span>
    <span class="k">else</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">addItem</span> <span class="s">&quot;italic&quot;</span><span class="p">,</span> <span class="s">&quot;toggleItalic&quot;</span>
    <span class="nx">menu</span>
  
  <span class="nv">setAlignmentToLeft: </span><span class="nf">-&gt;</span>
    <span class="vi">@alignment = </span><span class="s">&quot;left&quot;</span>
    <span class="nx">@updateRendering</span><span class="p">()</span>
    <span class="nx">@changed</span><span class="p">()</span>
  
  <span class="nv">setAlignmentToRight: </span><span class="nf">-&gt;</span>
    <span class="vi">@alignment = </span><span class="s">&quot;right&quot;</span>
    <span class="nx">@updateRendering</span><span class="p">()</span>
    <span class="nx">@changed</span><span class="p">()</span>
  
  <span class="nv">setAlignmentToCenter: </span><span class="nf">-&gt;</span>
    <span class="vi">@alignment = </span><span class="s">&quot;center&quot;</span>
    <span class="nx">@updateRendering</span><span class="p">()</span>
    <span class="nx">@changed</span><span class="p">()</span>  
  </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>TextMorph evaluation:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">evaluationMenu: </span><span class="nf">-&gt;</span>
    <span class="nv">menu = </span><span class="nx">@hierarchyMenu</span><span class="p">()</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">prependLine</span><span class="p">()</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">prependItem</span> <span class="s">&quot;select all&quot;</span><span class="p">,</span> <span class="s">&quot;selectAllAndEdit&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>only show the do it / show it / inspect it entries
if there is actually something selected.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@selection</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s\s*/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s\s*$/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">prependLine</span><span class="p">()</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">prependItem</span> <span class="s">&quot;inspect it&quot;</span><span class="p">,</span> <span class="s">&quot;inspectIt&quot;</span><span class="p">,</span> <span class="s">&quot;evaluate the\nselected expression\nand inspect the result&quot;</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">prependItem</span> <span class="s">&quot;show it&quot;</span><span class="p">,</span> <span class="s">&quot;showIt&quot;</span><span class="p">,</span> <span class="s">&quot;evaluate the\nselected expression\nand show the result&quot;</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">prependItem</span> <span class="s">&quot;do it&quot;</span><span class="p">,</span> <span class="s">&quot;doIt&quot;</span><span class="p">,</span> <span class="s">&quot;evaluate the\nselected expression&quot;</span>
    <span class="nx">menu</span>

  <span class="nv">selectAllAndEdit: </span><span class="nf">-&gt;</span>
    <span class="nx">@edit</span><span class="p">()</span>
    <span class="nx">@selectAll</span><span class="p">()</span>
   </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>this is set by the inspector. It tells the TextMorph
that any following doIt/showIt/inspectIt action needs to be
done apropos a particural obj</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setReceiver: </span><span class="nf">(obj) -&gt;</span>
    <span class="vi">@receiver = </span><span class="nx">obj</span>
    <span class="vi">@customContextMenu = </span><span class="nx">@evaluationMenu</span>
  
  <span class="nv">doIt: </span><span class="nf">-&gt;</span>
    <span class="nx">@receiver</span><span class="p">.</span><span class="nx">evaluateString</span> <span class="nx">@selection</span><span class="p">()</span>
    <span class="nx">@edit</span><span class="p">()</span>
  
  <span class="nv">showIt: </span><span class="nf">-&gt;</span>
    <span class="nv">result = </span><span class="nx">@receiver</span><span class="p">.</span><span class="nx">evaluateString</span><span class="p">(</span><span class="nx">@selection</span><span class="p">())</span>
    <span class="k">if</span> <span class="nx">result</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@inform</span> <span class="nx">result</span>
  
  <span class="nv">inspectIt: </span><span class="nf">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>evaluateString is a pimped-up eval in
the Morph class.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">result = </span><span class="nx">@receiver</span><span class="p">.</span><span class="nx">evaluateString</span><span class="p">(</span><span class="nx">@selection</span><span class="p">())</span>
    <span class="k">if</span> <span class="nx">result</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@spawnInspector</span> <span class="nx">result</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 